
# Evolution in the prescription and cost of non-intravenous rescue benzodiazepines for the treatment of seizure emergencies








## 1. Preparation of software for analysis




Install needed packages
```{r}
# install.packages("dplyr")
library(dplyr)

# install.packages("dbplyr")
library(dbplyr)

# install.packages("tidyr")
library(tidyr)

# install.packages("RSQLite")
library(RSQLite)

# install.packages("tibble")
library(tibble)

# install.packages("haven")
library(haven)

# install.packages("lubridate")
library(lubridate)

# install.packages("gmodels")
library(gmodels)

# install.packages("bazar")
library(bazar)

# install.packages("DescTools")
library(DescTools)

# install.packages("ggplot2")
library(ggplot2)

# install.packages("plotly")
library(plotly)
```








## 2. Data ingestion




Create the connection to the database
```{r}
# Create the connection to the MarketScan database
MarketScan <- DBI::dbConnect(RSQLite::SQLite(), "D:\\MarketScan\\MarketScan.db")
src_dbi(MarketScan)
```




Create the link to the relevant tables
```{r}
# Year 2006
ms_i_2006 <- tbl(MarketScan, "ms_i_2006")
ms_s_2006 <- tbl(MarketScan, "ms_s_2006")
ms_d_2006 <- tbl(MarketScan, "ms_d_2006")
ms_o_2006 <- tbl(MarketScan, "ms_o_2006")
ms_a_2006 <- tbl(MarketScan, "ms_a_2006")
ms_t_2006 <- tbl(MarketScan, "ms_t_2006")
redbook_2006 <- tbl(MarketScan, "redbook_2006")

# Year 2007
ms_i_2007 <- tbl(MarketScan, "ms_i_2007")
ms_s_2007 <- tbl(MarketScan, "ms_s_2007")
ms_d_2007 <- tbl(MarketScan, "ms_d_2007")
ms_o_2007 <- tbl(MarketScan, "ms_o_2007")
ms_a_2007 <- tbl(MarketScan, "ms_a_2007")
ms_t_2007 <- tbl(MarketScan, "ms_t_2007")
redbook_2007 <- tbl(MarketScan, "redbook_2007")

# Year 2008
ms_i_2008 <- tbl(MarketScan, "ms_i_2008")
ms_s_2008 <- tbl(MarketScan, "ms_s_2008")
ms_d_2008 <- tbl(MarketScan, "ms_d_2008")
ms_o_2008 <- tbl(MarketScan, "ms_o_2008")
ms_a_2008 <- tbl(MarketScan, "ms_a_2008")
ms_t_2008 <- tbl(MarketScan, "ms_t_2008")
redbook_2008 <- tbl(MarketScan, "redbook_2008")

# Year 2009
ms_i_2009 <- tbl(MarketScan, "ms_i_2009")
ms_s_2009 <- tbl(MarketScan, "ms_s_2009")
ms_d_2009 <- tbl(MarketScan, "ms_d_2009")
ms_o_2009 <- tbl(MarketScan, "ms_o_2009")
ms_a_2009 <- tbl(MarketScan, "ms_a_2009")
ms_t_2009 <- tbl(MarketScan, "ms_t_2009")
redbook_2009 <- tbl(MarketScan, "redbook_2009")

# Year 2010
ms_i_2010 <- tbl(MarketScan, "ms_i_2010")
ms_s_2010 <- tbl(MarketScan, "ms_s_2010")
ms_d_2010 <- tbl(MarketScan, "ms_d_2010")
ms_o_2010 <- tbl(MarketScan, "ms_o_2010")
ms_a_2010 <- tbl(MarketScan, "ms_a_2010")
ms_t_2010 <- tbl(MarketScan, "ms_t_2010")
redbook_2010 <- tbl(MarketScan, "redbook_2010")

# Year 2011
ms_i_2011 <- tbl(MarketScan, "ms_i_2011")
ms_s_2011 <- tbl(MarketScan, "ms_s_2011")
ms_d_2011 <- tbl(MarketScan, "ms_d_2011")
ms_o_2011 <- tbl(MarketScan, "ms_o_2011")
ms_a_2011 <- tbl(MarketScan, "ms_a_2011")
ms_t_2011 <- tbl(MarketScan, "ms_t_2011")
redbook_2011 <- tbl(MarketScan, "redbook_2011")

# Year 2012
ms_i_2012 <- tbl(MarketScan, "ms_i_2012")
ms_s_2012 <- tbl(MarketScan, "ms_s_2012")
ms_d_2012 <- tbl(MarketScan, "ms_d_2012")
ms_o_2012 <- tbl(MarketScan, "ms_o_2012")
ms_a_2012 <- tbl(MarketScan, "ms_a_2012")
ms_t_2012 <- tbl(MarketScan, "ms_t_2012")
redbook_2012 <- tbl(MarketScan, "redbook_2012")

# Year 2013
ms_i_2013 <- tbl(MarketScan, "ms_i_2013")
ms_s_2013 <- tbl(MarketScan, "ms_s_2013")
ms_d_2013 <- tbl(MarketScan, "ms_d_2013")
ms_o_2013 <- tbl(MarketScan, "ms_o_2013")
ms_a_2013 <- tbl(MarketScan, "ms_a_2013")
ms_t_2013 <- tbl(MarketScan, "ms_t_2013")
redbook_2013 <- tbl(MarketScan, "redbook_2013")

# Year 2014
ms_i_2014 <- tbl(MarketScan, "ms_i_2014")
ms_s_2014 <- tbl(MarketScan, "ms_s_2014")
ms_d_2014 <- tbl(MarketScan, "ms_d_2014")
ms_o_2014 <- tbl(MarketScan, "ms_o_2014")
ms_a_2014 <- tbl(MarketScan, "ms_a_2014")
ms_t_2014 <- tbl(MarketScan, "ms_t_2014")
redbook_2014 <- tbl(MarketScan, "redbook_2014")

# Year 2015
ms_i_2015 <- tbl(MarketScan, "ms_i_2015")
ms_s_2015 <- tbl(MarketScan, "ms_s_2015")
ms_d_2015 <- tbl(MarketScan, "ms_d_2015")
ms_o_2015 <- tbl(MarketScan, "ms_o_2015")
ms_a_2015 <- tbl(MarketScan, "ms_a_2015")
ms_t_2015 <- tbl(MarketScan, "ms_t_2015")
redbook_2015 <- tbl(MarketScan, "redbook_2015")

# Year 2016
ms_i_2016 <- tbl(MarketScan, "ms_i_2016")
ms_s_2016 <- tbl(MarketScan, "ms_s_2016")
ms_d_2016 <- tbl(MarketScan, "ms_d_2016")
ms_o_2016 <- tbl(MarketScan, "ms_o_2016")
ms_a_2016 <- tbl(MarketScan, "ms_a_2016")
ms_t_2016 <- tbl(MarketScan, "ms_t_2016")
redbook_2016 <- tbl(MarketScan, "redbook_2016")

# Year 2017
ms_i_2017 <- tbl(MarketScan, "ms_i_2017")
ms_s_2017 <- tbl(MarketScan, "ms_s_2017")
ms_d_2017 <- tbl(MarketScan, "ms_d_2017")
ms_o_2017 <- tbl(MarketScan, "ms_o_2017")
ms_a_2017 <- tbl(MarketScan, "ms_a_2017")
ms_t_2017 <- tbl(MarketScan, "ms_t_2017")
redbook_2017 <- tbl(MarketScan, "redbook_2017")

# Year 2018
ms_i_2018 <- tbl(MarketScan, "ms_i_2018")
ms_s_2018 <- tbl(MarketScan, "ms_s_2018")
ms_d_2018 <- tbl(MarketScan, "ms_d_2018")
ms_o_2018 <- tbl(MarketScan, "ms_o_2018")
ms_a_2018 <- tbl(MarketScan, "ms_a_2018")
ms_t_2018 <- tbl(MarketScan, "ms_t_2018")
redbook_2018 <- tbl(MarketScan, "redbook_2018")

# Year 2019
ms_i_2019 <- tbl(MarketScan, "ms_i_2019")
ms_s_2019 <- tbl(MarketScan, "ms_s_2019")
ms_d_2019 <- tbl(MarketScan, "ms_d_2019")
ms_o_2019 <- tbl(MarketScan, "ms_o_2019")
ms_a_2019 <- tbl(MarketScan, "ms_a_2019")
ms_t_2019 <- tbl(MarketScan, "ms_t_2019")
redbook_2019 <- tbl(MarketScan, "redbook_2019")

# Year 2020
ms_i_2020 <- tbl(MarketScan, "ms_i_2020")
ms_s_2020 <- tbl(MarketScan, "ms_s_2020")
ms_d_2020 <- tbl(MarketScan, "ms_d_2020")
ms_o_2020 <- tbl(MarketScan, "ms_o_2020")
ms_a_2020 <- tbl(MarketScan, "ms_a_2020")
ms_t_2020 <- tbl(MarketScan, "ms_t_2020")
redbook_2020 <- tbl(MarketScan, "redbook_2020")

# Year 2021
ms_i_2021 <- tbl(MarketScan, "ms_i_2021")
ms_s_2021 <- tbl(MarketScan, "ms_s_2021")
ms_d_2021 <- tbl(MarketScan, "ms_d_2021")
ms_o_2021 <- tbl(MarketScan, "ms_o_2021")
ms_a_2021 <- tbl(MarketScan, "ms_a_2021")
ms_t_2021 <- tbl(MarketScan, "ms_t_2021")
redbook_2021 <- tbl(MarketScan, "redbook_2021")

# Year 2022
ms_i_2022 <- tbl(MarketScan, "ms_i_2022")
ms_s_2022 <- tbl(MarketScan, "ms_s_2022")
ms_d_2022 <- tbl(MarketScan, "ms_d_2022")
ms_o_2022 <- tbl(MarketScan, "ms_o_2022")
ms_a_2022 <- tbl(MarketScan, "ms_a_2022")
ms_t_2022 <- tbl(MarketScan, "ms_t_2022")
redbook_2022 <- tbl(MarketScan, "redbook_2022")
```




Identify patients with epilepsy
```{r}
# Codes for patients with epilepsy
codes_epilepsy_ICD9 <- c("345", "3450", "34500", "34501", "3451", "34510", "34511", "3454", "34540", "34541", "3455", "34550", "34551", "3456", "34560", "34561", "3457", "34570", "34571", "3458", "34580", "34581", "3459", "34590", "34591")

codes_epilepsy_ICD10 <- c("G40", "G400", "G4000", "G40001", "G40009", "G4001", "G40011", "G40019", "G401", "G4010", "G40101", "G40109", "G4011", "G40111", "G40119", "G402", "G4020", "G40201", "G40209", "G4021", "G40211", "G40219", "G403", "G4030", "G40301", "G40309", "G4031", "G40311", "G40319", "G40A", "G40A0", "G40A01", "G40A09", "G40A1", "G40A11", "G40A19", "G40B", "G40B0", "G40B01", "G40B09", "G40B1", "G40B11", "G40B19", "G404", "G4040", "G40401", "G40409", "G4041", "G40411", "G40419", "G408", "G4080", "G40801", "G40802", "G40803", "G40804", "G4081", "G40811", "G40812", "G40813", "G40814", "G4082", "G40821", "G40822", "G40823", "G40824", "G4083", "G40833", "G40834", "G409", "G4090", "G40901", "G40909", "G4091", "G40911", "G40919")


# Patients with epilepsy

#################################2006#################################
epilepsy_2006_i <- ms_i_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2006_o <- ms_o_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2006_s <- ms_s_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
epilepsy_2007_i <- ms_i_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2007_o <- ms_o_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2007_s <- ms_s_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
epilepsy_2008_i <- ms_i_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2008_o <- ms_o_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2008_s <- ms_s_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
epilepsy_2009_i <- ms_i_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2009_o <- ms_o_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2009_s <- ms_s_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
epilepsy_2010_i <- ms_i_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2010_o <- ms_o_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2010_s <- ms_s_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
epilepsy_2011_i <- ms_i_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2011_o <- ms_o_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2011_s <- ms_s_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
epilepsy_2012_i <- ms_i_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2012_o <- ms_o_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2012_s <- ms_s_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
epilepsy_2013_i <- ms_i_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2013_o <- ms_o_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2013_s <- ms_s_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
epilepsy_2014_i <- ms_i_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2014_o <- ms_o_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2014_s <- ms_s_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
epilepsy_2015_i <- ms_i_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9 |
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2015_o <- ms_o_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2015_s <- ms_s_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
epilepsy_2016_i <- ms_i_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2016_o <- ms_o_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2016_s <- ms_s_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
epilepsy_2017_i <- ms_i_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2017_o <- ms_o_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2017_s <- ms_s_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
epilepsy_2018_i <- ms_i_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2018_o <- ms_o_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2018_s <- ms_s_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
epilepsy_2019_i <- ms_i_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2019_o <- ms_o_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2019_s <- ms_s_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2020#################################
epilepsy_2020_i <- ms_i_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2020_o <- ms_o_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2020_s <- ms_s_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2021#################################
epilepsy_2021_i <- ms_i_2021 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2021_o <- ms_o_2021 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2021_s <- ms_s_2021 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2022#################################
epilepsy_2022_i <- ms_i_2022 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2022_o <- ms_o_2022 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2022_s <- ms_s_2022 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Patients with epilepsy (at least 2 different codes for epilepsy separated by at least 180 days)
epilepsy <- bind_rows(epilepsy_2006_i, epilepsy_2006_o, epilepsy_2006_s, epilepsy_2007_i, epilepsy_2007_o, epilepsy_2007_s, epilepsy_2008_i, epilepsy_2008_o, epilepsy_2008_s, epilepsy_2009_i, epilepsy_2009_o, epilepsy_2009_s, epilepsy_2010_i, epilepsy_2010_o, epilepsy_2010_s, epilepsy_2011_i, epilepsy_2011_o, epilepsy_2011_s, epilepsy_2012_i, epilepsy_2012_o, epilepsy_2012_s, epilepsy_2013_i, epilepsy_2013_o, epilepsy_2013_s, epilepsy_2014_i, epilepsy_2014_o, epilepsy_2014_s, epilepsy_2015_i, epilepsy_2015_o, epilepsy_2015_s, epilepsy_2016_i, epilepsy_2016_o, epilepsy_2016_s, epilepsy_2017_i, epilepsy_2017_o, epilepsy_2017_s, epilepsy_2018_i, epilepsy_2018_o, epilepsy_2018_s, epilepsy_2019_i, epilepsy_2019_o, epilepsy_2019_s, epilepsy_2020_i, epilepsy_2020_o, epilepsy_2020_s, epilepsy_2021_i, epilepsy_2021_o, epilepsy_2021_s, epilepsy_2022_i, epilepsy_2022_o, epilepsy_2022_s) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  mutate(maximum_days_between_epilepsy_diagnoses=max(SVCDATE)-min(SVCDATE)) %>% 
  filter(maximum_days_between_epilepsy_diagnoses>=180)

epilepsy_n <- epilepsy %>% distinct(ENROLID) %>% nrow()
epilepsy_n
```




Identify patients with refractory epilepsy
```{r}

# Codes for patients with refractory epilepsy
codes_refractory_epilepsy_ICD9 <- c("34501", "34511", "34541", "34551", "34561", "34571", "34581", "34591")

codes_refractory_epilepsy_ICD10 <- c("G4001", "G40011", "G40019", "G4011", "G40.111", "G40119", "G4021", "G40211", "G40219", "G4031", "G40311", "G40319", "G40A1", "G40A11", "G40A19", "G40B1", "G40B11", "G40B19", "G4041", "G40411", "G40419", "G40803", "G40804", "G40813", "G40814", "G40823", "G40824", "G40833", "G40834", "G4091", "G40911", "G40919")


# Patients with refractory epilepsy

#################################2006#################################
refractory_epilepsy_2006_i <- ms_i_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2006_o <- ms_o_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

refractory_epilepsy_2006_s <- ms_s_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
refractory_epilepsy_2007_i <- ms_i_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2007_o <- ms_o_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

refractory_epilepsy_2007_s <- ms_s_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
refractory_epilepsy_2008_i <- ms_i_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2008_o <- ms_o_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

refractory_epilepsy_2008_s <- ms_s_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
refractory_epilepsy_2009_i <- ms_i_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2009_o <- ms_o_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

refractory_epilepsy_2009_s <- ms_s_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
refractory_epilepsy_2010_i <- ms_i_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2010_o <- ms_o_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

refractory_epilepsy_2010_s <- ms_s_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
refractory_epilepsy_2011_i <- ms_i_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2011_o <- ms_o_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

refractory_epilepsy_2011_s <- ms_s_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
refractory_epilepsy_2012_i <- ms_i_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2012_o <- ms_o_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

refractory_epilepsy_2012_s <- ms_s_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
refractory_epilepsy_2013_i <- ms_i_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2013_o <- ms_o_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

refractory_epilepsy_2013_s <- ms_s_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
refractory_epilepsy_2014_i <- ms_i_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2014_o <- ms_o_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

refractory_epilepsy_2014_s <- ms_s_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
refractory_epilepsy_2015_i <- ms_i_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9 |
                                      DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10 |
                                      DX3 %in% codes_refractory_epilepsy_ICD10 | DX4 %in% codes_refractory_epilepsy_ICD10 |
                                      DX5 %in% codes_refractory_epilepsy_ICD10 | DX6 %in% codes_refractory_epilepsy_ICD10 |
                                      DX7 %in% codes_refractory_epilepsy_ICD10 | DX8 %in% codes_refractory_epilepsy_ICD10 |
                                      DX9 %in% codes_refractory_epilepsy_ICD10 | DX10 %in% codes_refractory_epilepsy_ICD10 |
                                      DX11%in% codes_refractory_epilepsy_ICD10 | DX12 %in% codes_refractory_epilepsy_ICD10 |
                                      DX13 %in% codes_refractory_epilepsy_ICD10 | DX14 %in% codes_refractory_epilepsy_ICD10 |
                                      DX15 %in% codes_refractory_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2015_o <- ms_o_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9 |
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

refractory_epilepsy_2015_s <- ms_s_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | DX2 %in% codes_refractory_epilepsy_ICD9 |
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
refractory_epilepsy_2016_i <- ms_i_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10 |
                                      DX3 %in% codes_refractory_epilepsy_ICD10 | DX4 %in% codes_refractory_epilepsy_ICD10 |
                                      DX5 %in% codes_refractory_epilepsy_ICD10 | DX6 %in% codes_refractory_epilepsy_ICD10 |
                                      DX7 %in% codes_refractory_epilepsy_ICD10 | DX8 %in% codes_refractory_epilepsy_ICD10 |
                                      DX9 %in% codes_refractory_epilepsy_ICD10 | DX10 %in% codes_refractory_epilepsy_ICD10 |
                                      DX11%in% codes_refractory_epilepsy_ICD10 | DX12 %in% codes_refractory_epilepsy_ICD10 |
                                      DX13 %in% codes_refractory_epilepsy_ICD10 | DX14 %in% codes_refractory_epilepsy_ICD10 |
                                      DX15 %in% codes_refractory_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2016_o <- ms_o_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

refractory_epilepsy_2016_s <- ms_s_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
refractory_epilepsy_2017_i <- ms_i_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10 |
                                      DX3 %in% codes_refractory_epilepsy_ICD10 | DX4 %in% codes_refractory_epilepsy_ICD10 |
                                      DX5 %in% codes_refractory_epilepsy_ICD10 | DX6 %in% codes_refractory_epilepsy_ICD10 |
                                      DX7 %in% codes_refractory_epilepsy_ICD10 | DX8 %in% codes_refractory_epilepsy_ICD10 |
                                      DX9 %in% codes_refractory_epilepsy_ICD10 | DX10 %in% codes_refractory_epilepsy_ICD10 |
                                      DX11%in% codes_refractory_epilepsy_ICD10 | DX12 %in% codes_refractory_epilepsy_ICD10 |
                                      DX13 %in% codes_refractory_epilepsy_ICD10 | DX14 %in% codes_refractory_epilepsy_ICD10 |
                                      DX15 %in% codes_refractory_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2017_o <- ms_o_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

refractory_epilepsy_2017_s <- ms_s_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
refractory_epilepsy_2018_i <- ms_i_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10 |
                                      DX3 %in% codes_refractory_epilepsy_ICD10 | DX4 %in% codes_refractory_epilepsy_ICD10 |
                                      DX5 %in% codes_refractory_epilepsy_ICD10 | DX6 %in% codes_refractory_epilepsy_ICD10 |
                                      DX7 %in% codes_refractory_epilepsy_ICD10 | DX8 %in% codes_refractory_epilepsy_ICD10 |
                                      DX9 %in% codes_refractory_epilepsy_ICD10 | DX10 %in% codes_refractory_epilepsy_ICD10 |
                                      DX11%in% codes_refractory_epilepsy_ICD10 | DX12 %in% codes_refractory_epilepsy_ICD10 |
                                      DX13 %in% codes_refractory_epilepsy_ICD10 | DX14 %in% codes_refractory_epilepsy_ICD10 |
                                      DX15 %in% codes_refractory_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2018_o <- ms_o_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

refractory_epilepsy_2018_s <- ms_s_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
refractory_epilepsy_2019_i <- ms_i_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10 |
                                      DX3 %in% codes_refractory_epilepsy_ICD10 | DX4 %in% codes_refractory_epilepsy_ICD10 |
                                      DX5 %in% codes_refractory_epilepsy_ICD10 | DX6 %in% codes_refractory_epilepsy_ICD10 |
                                      DX7 %in% codes_refractory_epilepsy_ICD10 | DX8 %in% codes_refractory_epilepsy_ICD10 |
                                      DX9 %in% codes_refractory_epilepsy_ICD10 | DX10 %in% codes_refractory_epilepsy_ICD10 |
                                      DX11%in% codes_refractory_epilepsy_ICD10 | DX12 %in% codes_refractory_epilepsy_ICD10 |
                                      DX13 %in% codes_refractory_epilepsy_ICD10 | DX14 %in% codes_refractory_epilepsy_ICD10 |
                                      DX15 %in% codes_refractory_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2019_o <- ms_o_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

refractory_epilepsy_2019_s <- ms_s_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2020#################################
refractory_epilepsy_2020_i <- ms_i_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10 |
                                      DX3 %in% codes_refractory_epilepsy_ICD10 | DX4 %in% codes_refractory_epilepsy_ICD10 |
                                      DX5 %in% codes_refractory_epilepsy_ICD10 | DX6 %in% codes_refractory_epilepsy_ICD10 |
                                      DX7 %in% codes_refractory_epilepsy_ICD10 | DX8 %in% codes_refractory_epilepsy_ICD10 |
                                      DX9 %in% codes_refractory_epilepsy_ICD10 | DX10 %in% codes_refractory_epilepsy_ICD10 |
                                      DX11%in% codes_refractory_epilepsy_ICD10 | DX12 %in% codes_refractory_epilepsy_ICD10 |
                                      DX13 %in% codes_refractory_epilepsy_ICD10 | DX14 %in% codes_refractory_epilepsy_ICD10 |
                                      DX15 %in% codes_refractory_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2020_o <- ms_o_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

refractory_epilepsy_2020_s <- ms_s_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2021#################################
refractory_epilepsy_2021_i <- ms_i_2021 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10 |
                                      DX3 %in% codes_refractory_epilepsy_ICD10 | DX4 %in% codes_refractory_epilepsy_ICD10 |
                                      DX5 %in% codes_refractory_epilepsy_ICD10 | DX6 %in% codes_refractory_epilepsy_ICD10 |
                                      DX7 %in% codes_refractory_epilepsy_ICD10 | DX8 %in% codes_refractory_epilepsy_ICD10 |
                                      DX9 %in% codes_refractory_epilepsy_ICD10 | DX10 %in% codes_refractory_epilepsy_ICD10 |
                                      DX11%in% codes_refractory_epilepsy_ICD10 | DX12 %in% codes_refractory_epilepsy_ICD10 |
                                      DX13 %in% codes_refractory_epilepsy_ICD10 | DX14 %in% codes_refractory_epilepsy_ICD10 |
                                      DX15 %in% codes_refractory_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2021_o <- ms_o_2021 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

refractory_epilepsy_2021_s <- ms_s_2021 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2022#################################
refractory_epilepsy_2022_i <- ms_i_2022 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10 |
                                      DX3 %in% codes_refractory_epilepsy_ICD10 | DX4 %in% codes_refractory_epilepsy_ICD10 |
                                      DX5 %in% codes_refractory_epilepsy_ICD10 | DX6 %in% codes_refractory_epilepsy_ICD10 |
                                      DX7 %in% codes_refractory_epilepsy_ICD10 | DX8 %in% codes_refractory_epilepsy_ICD10 |
                                      DX9 %in% codes_refractory_epilepsy_ICD10 | DX10 %in% codes_refractory_epilepsy_ICD10 |
                                      DX11%in% codes_refractory_epilepsy_ICD10 | DX12 %in% codes_refractory_epilepsy_ICD10 |
                                      DX13 %in% codes_refractory_epilepsy_ICD10 | DX14 %in% codes_refractory_epilepsy_ICD10 |
                                      DX15 %in% codes_refractory_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2022_o <- ms_o_2022 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

refractory_epilepsy_2022_s <- ms_s_2022 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Refractory epilepsy (at least 2 different codes for refractory epilepsy separated by at least 180 days)
refractory_epilepsy <- bind_rows(refractory_epilepsy_2006_i, refractory_epilepsy_2006_o, refractory_epilepsy_2006_s, refractory_epilepsy_2007_i, refractory_epilepsy_2007_o, refractory_epilepsy_2007_s, refractory_epilepsy_2008_i, refractory_epilepsy_2008_o, refractory_epilepsy_2008_s, refractory_epilepsy_2009_i, refractory_epilepsy_2009_o, refractory_epilepsy_2009_s, refractory_epilepsy_2010_i, refractory_epilepsy_2010_o, refractory_epilepsy_2010_s, refractory_epilepsy_2011_i, refractory_epilepsy_2011_o, refractory_epilepsy_2011_s, refractory_epilepsy_2012_i, refractory_epilepsy_2012_o, refractory_epilepsy_2012_s, refractory_epilepsy_2013_i, refractory_epilepsy_2013_o, refractory_epilepsy_2013_s, refractory_epilepsy_2014_i, refractory_epilepsy_2014_o, refractory_epilepsy_2014_s, refractory_epilepsy_2015_i, refractory_epilepsy_2015_o, refractory_epilepsy_2015_s, refractory_epilepsy_2016_i, refractory_epilepsy_2016_o, refractory_epilepsy_2016_s, refractory_epilepsy_2017_i, refractory_epilepsy_2017_o, refractory_epilepsy_2017_s, refractory_epilepsy_2018_i, refractory_epilepsy_2018_o, refractory_epilepsy_2018_s, refractory_epilepsy_2019_i, refractory_epilepsy_2019_o, refractory_epilepsy_2019_s, refractory_epilepsy_2020_i, refractory_epilepsy_2020_o, refractory_epilepsy_2020_s, refractory_epilepsy_2021_i, refractory_epilepsy_2021_o, refractory_epilepsy_2021_s, refractory_epilepsy_2022_i, refractory_epilepsy_2022_o, refractory_epilepsy_2022_s) %>% 
  distinct(ENROLID, SVCDATE, keep_all=TRUE) %>% 
  group_by(ENROLID) %>% 
  mutate(maximum_days_between_refractory_epilepsy_diagnoses=max(SVCDATE)-min(SVCDATE)) %>% 
  filter(maximum_days_between_refractory_epilepsy_diagnoses>=180)


refractory_epilepsy_n <- refractory_epilepsy %>% distinct(ENROLID) %>% nrow()
refractory_epilepsy_n
```




Information on antiseizure medications
```{r}
# Extract the information from the redbook data
redbook_2006_data <- redbook_2006 %>% collect()
redbook_2007_data <- redbook_2007 %>% collect()
redbook_2008_data <- redbook_2008 %>% collect()
redbook_2009_data <- redbook_2009 %>% collect()
redbook_2010_data <- redbook_2010 %>% collect()
redbook_2011_data <- redbook_2011 %>% collect()
redbook_2012_data <- redbook_2012 %>% collect()
redbook_2013_data <- redbook_2013 %>% collect()
redbook_2014_data <- redbook_2014 %>% collect()
redbook_2015_data <- redbook_2015 %>% collect()
redbook_2016_data <- redbook_2016 %>% collect()
redbook_2017_data <- redbook_2017 %>% collect()
redbook_2018_data <- redbook_2018 %>% collect()
redbook_2019_data <- redbook_2019 %>% collect()
redbook_2020_data <- redbook_2020 %>% collect()
redbook_2021_data <- redbook_2021 %>% collect()
redbook_2022_data <- redbook_2022 %>% collect()
```




Antiseizure medications
```{r}
# Antiseizure medications
############################################2006############################################
codes_NDCNUM_phenobarbital_2006 <- redbook_2006_data %>% 
  filter(
      grepl("phenobarb", GENNME, ignore.case=TRUE) |
      grepl("phenobarb", THRDTDS, ignore.case=TRUE) |
      grepl("phenobarb", PRODNME, ignore.case=TRUE) |
      grepl("luminal", PRODNME, ignore.case=TRUE) |
      grepl("solfoton", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenobarbital_2006 <- as.numeric(codes_NDCNUM_phenobarbital_2006)


codes_NDCNUM_phenytoin_2006 <- redbook_2006_data %>% 
  filter(
      grepl("phenytoin", GENNME, ignore.case=TRUE) |
      grepl("phenytoin", THRDTDS, ignore.case=TRUE) |
      grepl("phenytoin", PRODNME, ignore.case=TRUE) |
      grepl("dilantin", PRODNME, ignore.case=TRUE) |
      grepl("phenytek", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenytoin_2006 <- as.numeric(codes_NDCNUM_phenytoin_2006)


codes_NDCNUM_valproate_2006 <- redbook_2006_data %>% 
  filter(
      grepl("valpro", GENNME, ignore.case=TRUE) |
      grepl("valpro", THRDTDS, ignore.case=TRUE) |
      grepl("valpro", PRODNME, ignore.case=TRUE) |
      grepl("depakene", PRODNME, ignore.case=TRUE) |
      grepl("depakote", PRODNME, ignore.case=TRUE) |
      grepl("depacon", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_valproate_2006 <- as.numeric(codes_NDCNUM_valproate_2006)


codes_NDCNUM_carbamazepine_2006 <- redbook_2006_data %>% 
  filter(
      grepl("carbamazepine", GENNME, ignore.case=TRUE) |
      grepl("carbamazepine", THRDTDS, ignore.case=TRUE) |
      grepl("carbamazepine", PRODNME, ignore.case=TRUE) |
      grepl("tegretol", PRODNME, ignore.case=TRUE) |
      grepl("carbatrol", PRODNME, ignore.case=TRUE) |
      grepl("epitol", PRODNME, ignore.case=TRUE) |
      grepl("equetro", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("atretol", PRODNME, ignore.case=TRUE)
    ) %>%   
  pull(NDCNUM)
codes_NDCNUM_carbamazepine_2006 <- as.numeric(codes_NDCNUM_carbamazepine_2006)


codes_NDCNUM_oxcarbazepine_2006 <- redbook_2006_data %>% 
  filter(
      grepl("oxcarbazepine", GENNME, ignore.case=TRUE) |
      grepl("oxcarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("oxcarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("oxtellar", PRODNME, ignore.case=TRUE) |
      grepl("trileptal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_oxcarbazepine_2006 <- as.numeric(codes_NDCNUM_oxcarbazepine_2006)


codes_NDCNUM_rufinamide_2006 <- redbook_2006_data %>% 
  filter(
      grepl("rufinamide", GENNME, ignore.case=TRUE) |
      grepl("rufinamide", THRDTDS, ignore.case=TRUE) |
      grepl("rufinamide", PRODNME, ignore.case=TRUE) |
      grepl("banzel", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rufinamide_2006 <- as.numeric(codes_NDCNUM_rufinamide_2006)


codes_NDCNUM_levetiracetam_2006 <- redbook_2006_data %>% 
  filter(
      grepl("levetiracetam", GENNME, ignore.case=TRUE) |
      grepl("levetiracetam", THRDTDS, ignore.case=TRUE) |
      grepl("levetiracetam", PRODNME, ignore.case=TRUE) |
      grepl("elepsia", PRODNME, ignore.case=TRUE) |
      grepl("keppra", PRODNME, ignore.case=TRUE) |
      grepl("roweepra", PRODNME, ignore.case=TRUE) |
      grepl("spritam", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_levetiracetam_2006 <- as.numeric(codes_NDCNUM_levetiracetam_2006)


codes_NDCNUM_lamotrigine_2006 <- redbook_2006_data %>% 
  filter(
      grepl("lamotrigine", GENNME, ignore.case=TRUE) |
      grepl("lamotrigine", THRDTDS, ignore.case=TRUE) |
      grepl("lamotrigine", PRODNME, ignore.case=TRUE) |
      grepl("lamictal", PRODNME, ignore.case=TRUE) |
      grepl("subvenite", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lamotrigine_2006 <- as.numeric(codes_NDCNUM_lamotrigine_2006)


codes_NDCNUM_brivaracetam_2006 <- redbook_2006_data %>% 
  filter(
      grepl("brivaracetam", GENNME, ignore.case=TRUE) |
      grepl("brivaracetam", THRDTDS, ignore.case=TRUE) |
      grepl("brivaracetam", PRODNME, ignore.case=TRUE) |
      grepl("briviact", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_brivaracetam_2006 <- as.numeric(codes_NDCNUM_brivaracetam_2006)


codes_NDCNUM_cenobamate_2006 <- redbook_2006_data %>% 
  filter(
      grepl("cenobamate", GENNME, ignore.case=TRUE) |
      grepl("cenobamate", THRDTDS, ignore.case=TRUE) |
      grepl("cenobamate", PRODNME, ignore.case=TRUE) |
      grepl("xcopri", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cenobamate_2006 <- as.numeric(codes_NDCNUM_cenobamate_2006)


codes_NDCNUM_clobazam_2006 <- redbook_2006_data %>% 
  filter(
      grepl("clobazam", GENNME, ignore.case=TRUE) |
      grepl("clobazam", THRDTDS, ignore.case=TRUE) |
      grepl("clobazam", PRODNME, ignore.case=TRUE) |
      grepl("onfi", PRODNME, ignore.case=TRUE) |
      grepl("sympazan", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("HIV", GENNME, ignore.case=TRUE) &
    !grepl("pregnancy", GENNME, ignore.case=TRUE) &
    !grepl("denture", GENNME, ignore.case=TRUE) &
    !grepl("hyoscyamine", GENNME, ignore.case=TRUE) &
    !grepl("glucose", GENNME, ignore.case=TRUE) &
    !grepl("device", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_clobazam_2006 <- as.numeric(codes_NDCNUM_clobazam_2006)


codes_NDCNUM_eslicarbazepine_2006 <- redbook_2006_data %>% 
  filter(
      grepl("eslicarbazepine", GENNME, ignore.case=TRUE) |
      grepl("eslicarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("eslicarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("aptiom", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_eslicarbazepine_2006 <- as.numeric(codes_NDCNUM_eslicarbazepine_2006)


codes_NDCNUM_ethosuximide_2006 <- redbook_2006_data %>% 
  filter(
      grepl("ethosuximide", GENNME, ignore.case=TRUE) |
      grepl("ethosuximide", THRDTDS, ignore.case=TRUE) |
      grepl("ethosuximide", PRODNME, ignore.case=TRUE) |
      grepl("zarontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_ethosuximide_2006 <- as.numeric(codes_NDCNUM_ethosuximide_2006)


codes_NDCNUM_lacosamide_2006 <- redbook_2006_data %>% 
  filter(
      grepl("lacosamide", GENNME, ignore.case=TRUE) |
      grepl("lacosamide", THRDTDS, ignore.case=TRUE) |
      grepl("lacosamide", PRODNME, ignore.case=TRUE) |
      grepl("vimpat", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lacosamide_2006 <- as.numeric(codes_NDCNUM_lacosamide_2006)


codes_NDCNUM_perampanel_2006 <- redbook_2006_data %>% 
  filter(
      grepl("perampanel", GENNME, ignore.case=TRUE) |
      grepl("perampanel", THRDTDS, ignore.case=TRUE) |
      grepl("perampanel", PRODNME, ignore.case=TRUE) |
      grepl("fycompa", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_perampanel_2006 <- as.numeric(codes_NDCNUM_perampanel_2006)


codes_NDCNUM_stiripentol_2006 <- redbook_2006_data %>% 
  filter(
      grepl("stiripentol", GENNME, ignore.case=TRUE) |
      grepl("stiripentol", THRDTDS, ignore.case=TRUE) |
      grepl("stiripentol", PRODNME, ignore.case=TRUE) |
      grepl("diacomit", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_stiripentol_2006 <- as.numeric(codes_NDCNUM_stiripentol_2006)


codes_NDCNUM_topiramate_2006 <- redbook_2006_data %>% 
  filter(
      grepl("topiramate", GENNME, ignore.case=TRUE) |
      grepl("topiramate", THRDTDS, ignore.case=TRUE) |
      grepl("topiramate", PRODNME, ignore.case=TRUE) |
      grepl("eprontia", PRODNME, ignore.case=TRUE) |
      grepl("topamax", PRODNME, ignore.case=TRUE) |
      grepl("trokendi", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE) &
    !grepl("qudexy", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_topiramate_2006 <- as.numeric(codes_NDCNUM_topiramate_2006)


codes_NDCNUM_vigabatrin_2006 <- redbook_2006_data %>% 
  filter(
      grepl("vigabatrin", GENNME, ignore.case=TRUE) |
      grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |
      grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
      grepl("sabril", PRODNME, ignore.case=TRUE) |
      grepl("vigadrone", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_vigabatrin_2006 <- as.numeric(codes_NDCNUM_vigabatrin_2006)


codes_NDCNUM_zonisamide_2006 <- redbook_2006_data %>% 
  filter(
      grepl("zonisamide", GENNME, ignore.case=TRUE) |
      grepl("zonisamide", THRDTDS, ignore.case=TRUE) |
      grepl("zonisamide", PRODNME, ignore.case=TRUE) |
      grepl("zonegran", PRODNME, ignore.case=TRUE) |
      grepl("zonisade", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_zonisamide_2006 <- as.numeric(codes_NDCNUM_zonisamide_2006)


codes_NDCNUM_felbamate_2006 <- redbook_2006_data %>% 
  filter(
      grepl("felbamate", GENNME, ignore.case=TRUE) |
      grepl("felbamate", THRDTDS, ignore.case=TRUE) |
      grepl("felbamate", PRODNME, ignore.case=TRUE) |
      grepl("felbatol", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_felbamate_2006 <- as.numeric(codes_NDCNUM_felbamate_2006)


codes_NDCNUM_pregabalin_2006 <- redbook_2006_data %>% 
  filter(
      grepl("pregabalin", GENNME, ignore.case=TRUE) |
      grepl("pregabalin", THRDTDS, ignore.case=TRUE) |
      grepl("pregabalin", PRODNME, ignore.case=TRUE) |
      grepl("lyrica", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_pregabalin_2006 <- as.numeric(codes_NDCNUM_pregabalin_2006)


codes_NDCNUM_tiagabine_2006 <- redbook_2006_data %>% 
  filter(
      grepl("tiagabine", GENNME, ignore.case=TRUE) |
      grepl("tiagabine", THRDTDS, ignore.case=TRUE) |
      grepl("tiagabine", PRODNME, ignore.case=TRUE) |
      grepl("gabitril", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_tiagabine_2006 <- as.numeric(codes_NDCNUM_tiagabine_2006)


codes_NDCNUM_cannabidiol_2006 <- redbook_2006_data %>% 
  filter(
      grepl("epidiolex", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cannabidiol_2006 <- as.numeric(codes_NDCNUM_cannabidiol_2006)


codes_NDCNUM_gabapentin_2006 <- redbook_2006_data %>% 
  filter(
      grepl("gabapentin", GENNME, ignore.case=TRUE) |
      grepl("gabapentin", THRDTDS, ignore.case=TRUE) |
      grepl("gabapentin", PRODNME, ignore.case=TRUE) |
      grepl("gralise", PRODNME, ignore.case=TRUE) |
      grepl("neurontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl(";", GENNME, ignore.case=TRUE) &
    !grepl("enacarbil", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_gabapentin_2006 <- as.numeric(codes_NDCNUM_gabapentin_2006)


codes_NDCNUM_fenfluramine_2006 <- redbook_2006_data %>% 
  filter(
      grepl("fenfluramine", GENNME, ignore.case=TRUE) |
      grepl("fenfluramine", THRDTDS, ignore.case=TRUE) |
      grepl("fenfluramine", PRODNME, ignore.case=TRUE) |
      grepl("fintepla", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("dex", GENNME, ignore.case=TRUE) &
    !grepl("dex", THRDTDS, ignore.case=TRUE) &
    !grepl("hydrochloride", GENNME, ignore.case=TRUE) &    
    !grepl("hydrochloride", THRDTDS, ignore.case=TRUE) &
    !grepl("pondimin", PRODNME, ignore.case=TRUE) &
    !grepl("redux", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_fenfluramine_2006 <- as.numeric(codes_NDCNUM_fenfluramine_2006)


codes_NDCNUM_methsuximide_2006 <- redbook_2006_data %>% 
  filter(
      grepl("methsuximide", GENNME, ignore.case=TRUE) |
      grepl("methsuximide", THRDTDS, ignore.case=TRUE) |
      grepl("methsuximide", PRODNME, ignore.case=TRUE) |
      grepl("celontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_methsuximide_2006 <- as.numeric(codes_NDCNUM_methsuximide_2006)


codes_NDCNUM_ASM_2006 <- c(
  codes_NDCNUM_phenobarbital_2006,
  codes_NDCNUM_phenytoin_2006,
  codes_NDCNUM_valproate_2006,
  codes_NDCNUM_carbamazepine_2006,
  codes_NDCNUM_oxcarbazepine_2006,
  codes_NDCNUM_rufinamide_2006,
  codes_NDCNUM_levetiracetam_2006,
  codes_NDCNUM_lamotrigine_2006,
  codes_NDCNUM_brivaracetam_2006,
  codes_NDCNUM_cenobamate_2006,
  codes_NDCNUM_clobazam_2006,
  codes_NDCNUM_eslicarbazepine_2006,
  codes_NDCNUM_ethosuximide_2006,
  codes_NDCNUM_lacosamide_2006,
  codes_NDCNUM_perampanel_2006,
  codes_NDCNUM_stiripentol_2006,
  codes_NDCNUM_topiramate_2006,
  codes_NDCNUM_vigabatrin_2006,
  codes_NDCNUM_zonisamide_2006,
  codes_NDCNUM_felbamate_2006,
  codes_NDCNUM_pregabalin_2006,
  codes_NDCNUM_tiagabine_2006,
  codes_NDCNUM_cannabidiol_2006,
  codes_NDCNUM_gabapentin_2006,
  codes_NDCNUM_fenfluramine_2006,
  codes_NDCNUM_methsuximide_2006
)




############################################2007############################################
codes_NDCNUM_phenobarbital_2007 <- redbook_2007_data %>% 
  filter(
      grepl("phenobarb", GENNME, ignore.case=TRUE) |
      grepl("phenobarb", THRDTDS, ignore.case=TRUE) |
      grepl("phenobarb", PRODNME, ignore.case=TRUE) |
      grepl("luminal", PRODNME, ignore.case=TRUE) |
      grepl("solfoton", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenobarbital_2007 <- as.numeric(codes_NDCNUM_phenobarbital_2007)


codes_NDCNUM_phenytoin_2007 <- redbook_2007_data %>% 
  filter(
      grepl("phenytoin", GENNME, ignore.case=TRUE) |
      grepl("phenytoin", THRDTDS, ignore.case=TRUE) |
      grepl("phenytoin", PRODNME, ignore.case=TRUE) |
      grepl("dilantin", PRODNME, ignore.case=TRUE) |
      grepl("phenytek", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenytoin_2007 <- as.numeric(codes_NDCNUM_phenytoin_2007)


codes_NDCNUM_valproate_2007 <- redbook_2007_data %>% 
  filter(
      grepl("valpro", GENNME, ignore.case=TRUE) |
      grepl("valpro", THRDTDS, ignore.case=TRUE) |
      grepl("valpro", PRODNME, ignore.case=TRUE) |
      grepl("depakene", PRODNME, ignore.case=TRUE) |
      grepl("depakote", PRODNME, ignore.case=TRUE) |
      grepl("depacon", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_valproate_2007 <- as.numeric(codes_NDCNUM_valproate_2007)


codes_NDCNUM_carbamazepine_2007 <- redbook_2007_data %>% 
  filter(
      grepl("carbamazepine", GENNME, ignore.case=TRUE) |
      grepl("carbamazepine", THRDTDS, ignore.case=TRUE) |
      grepl("carbamazepine", PRODNME, ignore.case=TRUE) |
      grepl("tegretol", PRODNME, ignore.case=TRUE) |
      grepl("carbatrol", PRODNME, ignore.case=TRUE) |
      grepl("epitol", PRODNME, ignore.case=TRUE) |
      grepl("equetro", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("atretol", PRODNME, ignore.case=TRUE)
    ) %>%   
  pull(NDCNUM)
codes_NDCNUM_carbamazepine_2007 <- as.numeric(codes_NDCNUM_carbamazepine_2007)


codes_NDCNUM_oxcarbazepine_2007 <- redbook_2007_data %>% 
  filter(
      grepl("oxcarbazepine", GENNME, ignore.case=TRUE) |
      grepl("oxcarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("oxcarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("oxtellar", PRODNME, ignore.case=TRUE) |
      grepl("trileptal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_oxcarbazepine_2007 <- as.numeric(codes_NDCNUM_oxcarbazepine_2007)


codes_NDCNUM_rufinamide_2007 <- redbook_2007_data %>% 
  filter(
      grepl("rufinamide", GENNME, ignore.case=TRUE) |
      grepl("rufinamide", THRDTDS, ignore.case=TRUE) |
      grepl("rufinamide", PRODNME, ignore.case=TRUE) |
      grepl("banzel", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rufinamide_2007 <- as.numeric(codes_NDCNUM_rufinamide_2007)


codes_NDCNUM_levetiracetam_2007 <- redbook_2007_data %>% 
  filter(
      grepl("levetiracetam", GENNME, ignore.case=TRUE) |
      grepl("levetiracetam", THRDTDS, ignore.case=TRUE) |
      grepl("levetiracetam", PRODNME, ignore.case=TRUE) |
      grepl("elepsia", PRODNME, ignore.case=TRUE) |
      grepl("keppra", PRODNME, ignore.case=TRUE) |
      grepl("roweepra", PRODNME, ignore.case=TRUE) |
      grepl("spritam", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_levetiracetam_2007 <- as.numeric(codes_NDCNUM_levetiracetam_2007)


codes_NDCNUM_lamotrigine_2007 <- redbook_2007_data %>% 
  filter(
      grepl("lamotrigine", GENNME, ignore.case=TRUE) |
      grepl("lamotrigine", THRDTDS, ignore.case=TRUE) |
      grepl("lamotrigine", PRODNME, ignore.case=TRUE) |
      grepl("lamictal", PRODNME, ignore.case=TRUE) |
      grepl("subvenite", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lamotrigine_2007 <- as.numeric(codes_NDCNUM_lamotrigine_2007)


codes_NDCNUM_brivaracetam_2007 <- redbook_2007_data %>% 
  filter(
      grepl("brivaracetam", GENNME, ignore.case=TRUE) |
      grepl("brivaracetam", THRDTDS, ignore.case=TRUE) |
      grepl("brivaracetam", PRODNME, ignore.case=TRUE) |
      grepl("briviact", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_brivaracetam_2007 <- as.numeric(codes_NDCNUM_brivaracetam_2007)


codes_NDCNUM_cenobamate_2007 <- redbook_2007_data %>% 
  filter(
      grepl("cenobamate", GENNME, ignore.case=TRUE) |
      grepl("cenobamate", THRDTDS, ignore.case=TRUE) |
      grepl("cenobamate", PRODNME, ignore.case=TRUE) |
      grepl("xcopri", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cenobamate_2007 <- as.numeric(codes_NDCNUM_cenobamate_2007)


codes_NDCNUM_clobazam_2007 <- redbook_2007_data %>% 
  filter(
      grepl("clobazam", GENNME, ignore.case=TRUE) |
      grepl("clobazam", THRDTDS, ignore.case=TRUE) |
      grepl("clobazam", PRODNME, ignore.case=TRUE) |
      grepl("onfi", PRODNME, ignore.case=TRUE) |
      grepl("sympazan", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("HIV", GENNME, ignore.case=TRUE) &
    !grepl("pregnancy", GENNME, ignore.case=TRUE) &
    !grepl("denture", GENNME, ignore.case=TRUE) &
    !grepl("hyoscyamine", GENNME, ignore.case=TRUE) &
    !grepl("glucose", GENNME, ignore.case=TRUE) &
    !grepl("device", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_clobazam_2007 <- as.numeric(codes_NDCNUM_clobazam_2007)


codes_NDCNUM_eslicarbazepine_2007 <- redbook_2007_data %>% 
  filter(
      grepl("eslicarbazepine", GENNME, ignore.case=TRUE) |
      grepl("eslicarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("eslicarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("aptiom", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_eslicarbazepine_2007 <- as.numeric(codes_NDCNUM_eslicarbazepine_2007)


codes_NDCNUM_ethosuximide_2007 <- redbook_2007_data %>% 
  filter(
      grepl("ethosuximide", GENNME, ignore.case=TRUE) |
      grepl("ethosuximide", THRDTDS, ignore.case=TRUE) |
      grepl("ethosuximide", PRODNME, ignore.case=TRUE) |
      grepl("zarontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_ethosuximide_2007 <- as.numeric(codes_NDCNUM_ethosuximide_2007)


codes_NDCNUM_lacosamide_2007 <- redbook_2007_data %>% 
  filter(
      grepl("lacosamide", GENNME, ignore.case=TRUE) |
      grepl("lacosamide", THRDTDS, ignore.case=TRUE) |
      grepl("lacosamide", PRODNME, ignore.case=TRUE) |
      grepl("vimpat", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lacosamide_2007 <- as.numeric(codes_NDCNUM_lacosamide_2007)


codes_NDCNUM_perampanel_2007 <- redbook_2007_data %>% 
  filter(
      grepl("perampanel", GENNME, ignore.case=TRUE) |
      grepl("perampanel", THRDTDS, ignore.case=TRUE) |
      grepl("perampanel", PRODNME, ignore.case=TRUE) |
      grepl("fycompa", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_perampanel_2007 <- as.numeric(codes_NDCNUM_perampanel_2007)


codes_NDCNUM_stiripentol_2007 <- redbook_2007_data %>% 
  filter(
      grepl("stiripentol", GENNME, ignore.case=TRUE) |
      grepl("stiripentol", THRDTDS, ignore.case=TRUE) |
      grepl("stiripentol", PRODNME, ignore.case=TRUE) |
      grepl("diacomit", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_stiripentol_2007 <- as.numeric(codes_NDCNUM_stiripentol_2007)


codes_NDCNUM_topiramate_2007 <- redbook_2007_data %>% 
  filter(
      grepl("topiramate", GENNME, ignore.case=TRUE) |
      grepl("topiramate", THRDTDS, ignore.case=TRUE) |
      grepl("topiramate", PRODNME, ignore.case=TRUE) |
      grepl("eprontia", PRODNME, ignore.case=TRUE) |
      grepl("topamax", PRODNME, ignore.case=TRUE) |
      grepl("trokendi", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE) &
    !grepl("qudexy", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_topiramate_2007 <- as.numeric(codes_NDCNUM_topiramate_2007)


codes_NDCNUM_vigabatrin_2007 <- redbook_2007_data %>% 
  filter(
      grepl("vigabatrin", GENNME, ignore.case=TRUE) |
      grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |
      grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
      grepl("sabril", PRODNME, ignore.case=TRUE) |
      grepl("vigadrone", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_vigabatrin_2007 <- as.numeric(codes_NDCNUM_vigabatrin_2007)


codes_NDCNUM_zonisamide_2007 <- redbook_2007_data %>% 
  filter(
      grepl("zonisamide", GENNME, ignore.case=TRUE) |
      grepl("zonisamide", THRDTDS, ignore.case=TRUE) |
      grepl("zonisamide", PRODNME, ignore.case=TRUE) |
      grepl("zonegran", PRODNME, ignore.case=TRUE) |
      grepl("zonisade", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_zonisamide_2007 <- as.numeric(codes_NDCNUM_zonisamide_2007)


codes_NDCNUM_felbamate_2007 <- redbook_2007_data %>% 
  filter(
      grepl("felbamate", GENNME, ignore.case=TRUE) |
      grepl("felbamate", THRDTDS, ignore.case=TRUE) |
      grepl("felbamate", PRODNME, ignore.case=TRUE) |
      grepl("felbatol", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_felbamate_2007 <- as.numeric(codes_NDCNUM_felbamate_2007)


codes_NDCNUM_pregabalin_2007 <- redbook_2007_data %>% 
  filter(
      grepl("pregabalin", GENNME, ignore.case=TRUE) |
      grepl("pregabalin", THRDTDS, ignore.case=TRUE) |
      grepl("pregabalin", PRODNME, ignore.case=TRUE) |
      grepl("lyrica", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_pregabalin_2007 <- as.numeric(codes_NDCNUM_pregabalin_2007)


codes_NDCNUM_tiagabine_2007 <- redbook_2007_data %>% 
  filter(
      grepl("tiagabine", GENNME, ignore.case=TRUE) |
      grepl("tiagabine", THRDTDS, ignore.case=TRUE) |
      grepl("tiagabine", PRODNME, ignore.case=TRUE) |
      grepl("gabitril", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_tiagabine_2007 <- as.numeric(codes_NDCNUM_tiagabine_2007)


codes_NDCNUM_cannabidiol_2007 <- redbook_2007_data %>% 
  filter(
      grepl("epidiolex", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cannabidiol_2007 <- as.numeric(codes_NDCNUM_cannabidiol_2007)


codes_NDCNUM_gabapentin_2007 <- redbook_2007_data %>% 
  filter(
      grepl("gabapentin", GENNME, ignore.case=TRUE) |
      grepl("gabapentin", THRDTDS, ignore.case=TRUE) |
      grepl("gabapentin", PRODNME, ignore.case=TRUE) |
      grepl("gralise", PRODNME, ignore.case=TRUE) |
      grepl("neurontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl(";", GENNME, ignore.case=TRUE) &
    !grepl("enacarbil", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_gabapentin_2007 <- as.numeric(codes_NDCNUM_gabapentin_2007)


codes_NDCNUM_fenfluramine_2007 <- redbook_2007_data %>% 
  filter(
      grepl("fenfluramine", GENNME, ignore.case=TRUE) |
      grepl("fenfluramine", THRDTDS, ignore.case=TRUE) |
      grepl("fenfluramine", PRODNME, ignore.case=TRUE) |
      grepl("fintepla", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("dex", GENNME, ignore.case=TRUE) &
    !grepl("dex", THRDTDS, ignore.case=TRUE) &
    !grepl("hydrochloride", GENNME, ignore.case=TRUE) &    
    !grepl("hydrochloride", THRDTDS, ignore.case=TRUE) &
    !grepl("pondimin", PRODNME, ignore.case=TRUE) &
    !grepl("redux", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_fenfluramine_2007 <- as.numeric(codes_NDCNUM_fenfluramine_2007)


codes_NDCNUM_methsuximide_2007 <- redbook_2007_data %>% 
  filter(
      grepl("methsuximide", GENNME, ignore.case=TRUE) |
      grepl("methsuximide", THRDTDS, ignore.case=TRUE) |
      grepl("methsuximide", PRODNME, ignore.case=TRUE) |
      grepl("celontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_methsuximide_2007 <- as.numeric(codes_NDCNUM_methsuximide_2007)


codes_NDCNUM_ASM_2007 <- c(
  codes_NDCNUM_phenobarbital_2007,
  codes_NDCNUM_phenytoin_2007,
  codes_NDCNUM_valproate_2007,
  codes_NDCNUM_carbamazepine_2007,
  codes_NDCNUM_oxcarbazepine_2007,
  codes_NDCNUM_rufinamide_2007,
  codes_NDCNUM_levetiracetam_2007,
  codes_NDCNUM_lamotrigine_2007,
  codes_NDCNUM_brivaracetam_2007,
  codes_NDCNUM_cenobamate_2007,
  codes_NDCNUM_clobazam_2007,
  codes_NDCNUM_eslicarbazepine_2007,
  codes_NDCNUM_ethosuximide_2007,
  codes_NDCNUM_lacosamide_2007,
  codes_NDCNUM_perampanel_2007,
  codes_NDCNUM_stiripentol_2007,
  codes_NDCNUM_topiramate_2007,
  codes_NDCNUM_vigabatrin_2007,
  codes_NDCNUM_zonisamide_2007,
  codes_NDCNUM_felbamate_2007,
  codes_NDCNUM_pregabalin_2007,
  codes_NDCNUM_tiagabine_2007,
  codes_NDCNUM_cannabidiol_2007,
  codes_NDCNUM_gabapentin_2007,
  codes_NDCNUM_fenfluramine_2007,
  codes_NDCNUM_methsuximide_2007
)




############################################2008############################################
codes_NDCNUM_phenobarbital_2008 <- redbook_2008_data %>% 
  filter(
      grepl("phenobarb", GENNME, ignore.case=TRUE) |
      grepl("phenobarb", THRDTDS, ignore.case=TRUE) |
      grepl("phenobarb", PRODNME, ignore.case=TRUE) |
      grepl("luminal", PRODNME, ignore.case=TRUE) |
      grepl("solfoton", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenobarbital_2008 <- as.numeric(codes_NDCNUM_phenobarbital_2008)


codes_NDCNUM_phenytoin_2008 <- redbook_2008_data %>% 
  filter(
      grepl("phenytoin", GENNME, ignore.case=TRUE) |
      grepl("phenytoin", THRDTDS, ignore.case=TRUE) |
      grepl("phenytoin", PRODNME, ignore.case=TRUE) |
      grepl("dilantin", PRODNME, ignore.case=TRUE) |
      grepl("phenytek", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenytoin_2008 <- as.numeric(codes_NDCNUM_phenytoin_2008)


codes_NDCNUM_valproate_2008 <- redbook_2008_data %>% 
  filter(
      grepl("valpro", GENNME, ignore.case=TRUE) |
      grepl("valpro", THRDTDS, ignore.case=TRUE) |
      grepl("valpro", PRODNME, ignore.case=TRUE) |
      grepl("depakene", PRODNME, ignore.case=TRUE) |
      grepl("depakote", PRODNME, ignore.case=TRUE) |
      grepl("depacon", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_valproate_2008 <- as.numeric(codes_NDCNUM_valproate_2008)


codes_NDCNUM_carbamazepine_2008 <- redbook_2008_data %>% 
  filter(
      grepl("carbamazepine", GENNME, ignore.case=TRUE) |
      grepl("carbamazepine", THRDTDS, ignore.case=TRUE) |
      grepl("carbamazepine", PRODNME, ignore.case=TRUE) |
      grepl("tegretol", PRODNME, ignore.case=TRUE) |
      grepl("carbatrol", PRODNME, ignore.case=TRUE) |
      grepl("epitol", PRODNME, ignore.case=TRUE) |
      grepl("equetro", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("atretol", PRODNME, ignore.case=TRUE)
    ) %>%   
  pull(NDCNUM)
codes_NDCNUM_carbamazepine_2008 <- as.numeric(codes_NDCNUM_carbamazepine_2008)


codes_NDCNUM_oxcarbazepine_2008 <- redbook_2008_data %>% 
  filter(
      grepl("oxcarbazepine", GENNME, ignore.case=TRUE) |
      grepl("oxcarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("oxcarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("oxtellar", PRODNME, ignore.case=TRUE) |
      grepl("trileptal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_oxcarbazepine_2008 <- as.numeric(codes_NDCNUM_oxcarbazepine_2008)


codes_NDCNUM_rufinamide_2008 <- redbook_2008_data %>% 
  filter(
      grepl("rufinamide", GENNME, ignore.case=TRUE) |
      grepl("rufinamide", THRDTDS, ignore.case=TRUE) |
      grepl("rufinamide", PRODNME, ignore.case=TRUE) |
      grepl("banzel", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rufinamide_2008 <- as.numeric(codes_NDCNUM_rufinamide_2008)


codes_NDCNUM_levetiracetam_2008 <- redbook_2008_data %>% 
  filter(
      grepl("levetiracetam", GENNME, ignore.case=TRUE) |
      grepl("levetiracetam", THRDTDS, ignore.case=TRUE) |
      grepl("levetiracetam", PRODNME, ignore.case=TRUE) |
      grepl("elepsia", PRODNME, ignore.case=TRUE) |
      grepl("keppra", PRODNME, ignore.case=TRUE) |
      grepl("roweepra", PRODNME, ignore.case=TRUE) |
      grepl("spritam", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_levetiracetam_2008 <- as.numeric(codes_NDCNUM_levetiracetam_2008)


codes_NDCNUM_lamotrigine_2008 <- redbook_2008_data %>% 
  filter(
      grepl("lamotrigine", GENNME, ignore.case=TRUE) |
      grepl("lamotrigine", THRDTDS, ignore.case=TRUE) |
      grepl("lamotrigine", PRODNME, ignore.case=TRUE) |
      grepl("lamictal", PRODNME, ignore.case=TRUE) |
      grepl("subvenite", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lamotrigine_2008 <- as.numeric(codes_NDCNUM_lamotrigine_2008)


codes_NDCNUM_brivaracetam_2008 <- redbook_2008_data %>% 
  filter(
      grepl("brivaracetam", GENNME, ignore.case=TRUE) |
      grepl("brivaracetam", THRDTDS, ignore.case=TRUE) |
      grepl("brivaracetam", PRODNME, ignore.case=TRUE) |
      grepl("briviact", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_brivaracetam_2008 <- as.numeric(codes_NDCNUM_brivaracetam_2008)


codes_NDCNUM_cenobamate_2008 <- redbook_2008_data %>% 
  filter(
      grepl("cenobamate", GENNME, ignore.case=TRUE) |
      grepl("cenobamate", THRDTDS, ignore.case=TRUE) |
      grepl("cenobamate", PRODNME, ignore.case=TRUE) |
      grepl("xcopri", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cenobamate_2008 <- as.numeric(codes_NDCNUM_cenobamate_2008)


codes_NDCNUM_clobazam_2008 <- redbook_2008_data %>% 
  filter(
      grepl("clobazam", GENNME, ignore.case=TRUE) |
      grepl("clobazam", THRDTDS, ignore.case=TRUE) |
      grepl("clobazam", PRODNME, ignore.case=TRUE) |
      grepl("onfi", PRODNME, ignore.case=TRUE) |
      grepl("sympazan", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("HIV", GENNME, ignore.case=TRUE) &
    !grepl("pregnancy", GENNME, ignore.case=TRUE) &
    !grepl("denture", GENNME, ignore.case=TRUE) &
    !grepl("hyoscyamine", GENNME, ignore.case=TRUE) &
    !grepl("glucose", GENNME, ignore.case=TRUE) &
    !grepl("device", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_clobazam_2008 <- as.numeric(codes_NDCNUM_clobazam_2008)


codes_NDCNUM_eslicarbazepine_2008 <- redbook_2008_data %>% 
  filter(
      grepl("eslicarbazepine", GENNME, ignore.case=TRUE) |
      grepl("eslicarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("eslicarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("aptiom", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_eslicarbazepine_2008 <- as.numeric(codes_NDCNUM_eslicarbazepine_2008)


codes_NDCNUM_ethosuximide_2008 <- redbook_2008_data %>% 
  filter(
      grepl("ethosuximide", GENNME, ignore.case=TRUE) |
      grepl("ethosuximide", THRDTDS, ignore.case=TRUE) |
      grepl("ethosuximide", PRODNME, ignore.case=TRUE) |
      grepl("zarontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_ethosuximide_2008 <- as.numeric(codes_NDCNUM_ethosuximide_2008)


codes_NDCNUM_lacosamide_2008 <- redbook_2008_data %>% 
  filter(
      grepl("lacosamide", GENNME, ignore.case=TRUE) |
      grepl("lacosamide", THRDTDS, ignore.case=TRUE) |
      grepl("lacosamide", PRODNME, ignore.case=TRUE) |
      grepl("vimpat", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lacosamide_2008 <- as.numeric(codes_NDCNUM_lacosamide_2008)


codes_NDCNUM_perampanel_2008 <- redbook_2008_data %>% 
  filter(
      grepl("perampanel", GENNME, ignore.case=TRUE) |
      grepl("perampanel", THRDTDS, ignore.case=TRUE) |
      grepl("perampanel", PRODNME, ignore.case=TRUE) |
      grepl("fycompa", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_perampanel_2008 <- as.numeric(codes_NDCNUM_perampanel_2008)


codes_NDCNUM_stiripentol_2008 <- redbook_2008_data %>% 
  filter(
      grepl("stiripentol", GENNME, ignore.case=TRUE) |
      grepl("stiripentol", THRDTDS, ignore.case=TRUE) |
      grepl("stiripentol", PRODNME, ignore.case=TRUE) |
      grepl("diacomit", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_stiripentol_2008 <- as.numeric(codes_NDCNUM_stiripentol_2008)


codes_NDCNUM_topiramate_2008 <- redbook_2008_data %>% 
  filter(
      grepl("topiramate", GENNME, ignore.case=TRUE) |
      grepl("topiramate", THRDTDS, ignore.case=TRUE) |
      grepl("topiramate", PRODNME, ignore.case=TRUE) |
      grepl("eprontia", PRODNME, ignore.case=TRUE) |
      grepl("topamax", PRODNME, ignore.case=TRUE) |
      grepl("trokendi", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE) &
    !grepl("qudexy", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_topiramate_2008 <- as.numeric(codes_NDCNUM_topiramate_2008)


codes_NDCNUM_vigabatrin_2008 <- redbook_2008_data %>% 
  filter(
      grepl("vigabatrin", GENNME, ignore.case=TRUE) |
      grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |
      grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
      grepl("sabril", PRODNME, ignore.case=TRUE) |
      grepl("vigadrone", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_vigabatrin_2008 <- as.numeric(codes_NDCNUM_vigabatrin_2008)


codes_NDCNUM_zonisamide_2008 <- redbook_2008_data %>% 
  filter(
      grepl("zonisamide", GENNME, ignore.case=TRUE) |
      grepl("zonisamide", THRDTDS, ignore.case=TRUE) |
      grepl("zonisamide", PRODNME, ignore.case=TRUE) |
      grepl("zonegran", PRODNME, ignore.case=TRUE) |
      grepl("zonisade", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_zonisamide_2008 <- as.numeric(codes_NDCNUM_zonisamide_2008)


codes_NDCNUM_felbamate_2008 <- redbook_2008_data %>% 
  filter(
      grepl("felbamate", GENNME, ignore.case=TRUE) |
      grepl("felbamate", THRDTDS, ignore.case=TRUE) |
      grepl("felbamate", PRODNME, ignore.case=TRUE) |
      grepl("felbatol", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_felbamate_2008 <- as.numeric(codes_NDCNUM_felbamate_2008)


codes_NDCNUM_pregabalin_2008 <- redbook_2008_data %>% 
  filter(
      grepl("pregabalin", GENNME, ignore.case=TRUE) |
      grepl("pregabalin", THRDTDS, ignore.case=TRUE) |
      grepl("pregabalin", PRODNME, ignore.case=TRUE) |
      grepl("lyrica", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_pregabalin_2008 <- as.numeric(codes_NDCNUM_pregabalin_2008)


codes_NDCNUM_tiagabine_2008 <- redbook_2008_data %>% 
  filter(
      grepl("tiagabine", GENNME, ignore.case=TRUE) |
      grepl("tiagabine", THRDTDS, ignore.case=TRUE) |
      grepl("tiagabine", PRODNME, ignore.case=TRUE) |
      grepl("gabitril", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_tiagabine_2008 <- as.numeric(codes_NDCNUM_tiagabine_2008)


codes_NDCNUM_cannabidiol_2008 <- redbook_2008_data %>% 
  filter(
      grepl("epidiolex", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cannabidiol_2008 <- as.numeric(codes_NDCNUM_cannabidiol_2008)


codes_NDCNUM_gabapentin_2008 <- redbook_2008_data %>% 
  filter(
      grepl("gabapentin", GENNME, ignore.case=TRUE) |
      grepl("gabapentin", THRDTDS, ignore.case=TRUE) |
      grepl("gabapentin", PRODNME, ignore.case=TRUE) |
      grepl("gralise", PRODNME, ignore.case=TRUE) |
      grepl("neurontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl(";", GENNME, ignore.case=TRUE) &
    !grepl("enacarbil", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_gabapentin_2008 <- as.numeric(codes_NDCNUM_gabapentin_2008)


codes_NDCNUM_fenfluramine_2008 <- redbook_2008_data %>% 
  filter(
      grepl("fenfluramine", GENNME, ignore.case=TRUE) |
      grepl("fenfluramine", THRDTDS, ignore.case=TRUE) |
      grepl("fenfluramine", PRODNME, ignore.case=TRUE) |
      grepl("fintepla", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("dex", GENNME, ignore.case=TRUE) &
    !grepl("dex", THRDTDS, ignore.case=TRUE) &
    !grepl("hydrochloride", GENNME, ignore.case=TRUE) &    
    !grepl("hydrochloride", THRDTDS, ignore.case=TRUE) &
    !grepl("pondimin", PRODNME, ignore.case=TRUE) &
    !grepl("redux", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_fenfluramine_2008 <- as.numeric(codes_NDCNUM_fenfluramine_2008)


codes_NDCNUM_methsuximide_2008 <- redbook_2008_data %>% 
  filter(
      grepl("methsuximide", GENNME, ignore.case=TRUE) |
      grepl("methsuximide", THRDTDS, ignore.case=TRUE) |
      grepl("methsuximide", PRODNME, ignore.case=TRUE) |
      grepl("celontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_methsuximide_2008 <- as.numeric(codes_NDCNUM_methsuximide_2008)


codes_NDCNUM_ASM_2008 <- c(
  codes_NDCNUM_phenobarbital_2008,
  codes_NDCNUM_phenytoin_2008,
  codes_NDCNUM_valproate_2008,
  codes_NDCNUM_carbamazepine_2008,
  codes_NDCNUM_oxcarbazepine_2008,
  codes_NDCNUM_rufinamide_2008,
  codes_NDCNUM_levetiracetam_2008,
  codes_NDCNUM_lamotrigine_2008,
  codes_NDCNUM_brivaracetam_2008,
  codes_NDCNUM_cenobamate_2008,
  codes_NDCNUM_clobazam_2008,
  codes_NDCNUM_eslicarbazepine_2008,
  codes_NDCNUM_ethosuximide_2008,
  codes_NDCNUM_lacosamide_2008,
  codes_NDCNUM_perampanel_2008,
  codes_NDCNUM_stiripentol_2008,
  codes_NDCNUM_topiramate_2008,
  codes_NDCNUM_vigabatrin_2008,
  codes_NDCNUM_zonisamide_2008,
  codes_NDCNUM_felbamate_2008,
  codes_NDCNUM_pregabalin_2008,
  codes_NDCNUM_tiagabine_2008,
  codes_NDCNUM_cannabidiol_2008,
  codes_NDCNUM_gabapentin_2008,
  codes_NDCNUM_fenfluramine_2008,
  codes_NDCNUM_methsuximide_2008
)




############################################2009############################################
codes_NDCNUM_phenobarbital_2009 <- redbook_2009_data %>% 
  filter(
      grepl("phenobarb", GENNME, ignore.case=TRUE) |
      grepl("phenobarb", THRDTDS, ignore.case=TRUE) |
      grepl("phenobarb", PRODNME, ignore.case=TRUE) |
      grepl("luminal", PRODNME, ignore.case=TRUE) |
      grepl("solfoton", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenobarbital_2009 <- as.numeric(codes_NDCNUM_phenobarbital_2009)


codes_NDCNUM_phenytoin_2009 <- redbook_2009_data %>% 
  filter(
      grepl("phenytoin", GENNME, ignore.case=TRUE) |
      grepl("phenytoin", THRDTDS, ignore.case=TRUE) |
      grepl("phenytoin", PRODNME, ignore.case=TRUE) |
      grepl("dilantin", PRODNME, ignore.case=TRUE) |
      grepl("phenytek", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenytoin_2009 <- as.numeric(codes_NDCNUM_phenytoin_2009)


codes_NDCNUM_valproate_2009 <- redbook_2009_data %>% 
  filter(
      grepl("valpro", GENNME, ignore.case=TRUE) |
      grepl("valpro", THRDTDS, ignore.case=TRUE) |
      grepl("valpro", PRODNME, ignore.case=TRUE) |
      grepl("depakene", PRODNME, ignore.case=TRUE) |
      grepl("depakote", PRODNME, ignore.case=TRUE) |
      grepl("depacon", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_valproate_2009 <- as.numeric(codes_NDCNUM_valproate_2009)


codes_NDCNUM_carbamazepine_2009 <- redbook_2009_data %>% 
  filter(
      grepl("carbamazepine", GENNME, ignore.case=TRUE) |
      grepl("carbamazepine", THRDTDS, ignore.case=TRUE) |
      grepl("carbamazepine", PRODNME, ignore.case=TRUE) |
      grepl("tegretol", PRODNME, ignore.case=TRUE) |
      grepl("carbatrol", PRODNME, ignore.case=TRUE) |
      grepl("epitol", PRODNME, ignore.case=TRUE) |
      grepl("equetro", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("atretol", PRODNME, ignore.case=TRUE)
    ) %>%   
  pull(NDCNUM)
codes_NDCNUM_carbamazepine_2009 <- as.numeric(codes_NDCNUM_carbamazepine_2009)


codes_NDCNUM_oxcarbazepine_2009 <- redbook_2009_data %>% 
  filter(
      grepl("oxcarbazepine", GENNME, ignore.case=TRUE) |
      grepl("oxcarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("oxcarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("oxtellar", PRODNME, ignore.case=TRUE) |
      grepl("trileptal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_oxcarbazepine_2009 <- as.numeric(codes_NDCNUM_oxcarbazepine_2009)


codes_NDCNUM_rufinamide_2009 <- redbook_2009_data %>% 
  filter(
      grepl("rufinamide", GENNME, ignore.case=TRUE) |
      grepl("rufinamide", THRDTDS, ignore.case=TRUE) |
      grepl("rufinamide", PRODNME, ignore.case=TRUE) |
      grepl("banzel", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rufinamide_2009 <- as.numeric(codes_NDCNUM_rufinamide_2009)


codes_NDCNUM_levetiracetam_2009 <- redbook_2009_data %>% 
  filter(
      grepl("levetiracetam", GENNME, ignore.case=TRUE) |
      grepl("levetiracetam", THRDTDS, ignore.case=TRUE) |
      grepl("levetiracetam", PRODNME, ignore.case=TRUE) |
      grepl("elepsia", PRODNME, ignore.case=TRUE) |
      grepl("keppra", PRODNME, ignore.case=TRUE) |
      grepl("roweepra", PRODNME, ignore.case=TRUE) |
      grepl("spritam", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_levetiracetam_2009 <- as.numeric(codes_NDCNUM_levetiracetam_2009)


codes_NDCNUM_lamotrigine_2009 <- redbook_2009_data %>% 
  filter(
      grepl("lamotrigine", GENNME, ignore.case=TRUE) |
      grepl("lamotrigine", THRDTDS, ignore.case=TRUE) |
      grepl("lamotrigine", PRODNME, ignore.case=TRUE) |
      grepl("lamictal", PRODNME, ignore.case=TRUE) |
      grepl("subvenite", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lamotrigine_2009 <- as.numeric(codes_NDCNUM_lamotrigine_2009)


codes_NDCNUM_brivaracetam_2009 <- redbook_2009_data %>% 
  filter(
      grepl("brivaracetam", GENNME, ignore.case=TRUE) |
      grepl("brivaracetam", THRDTDS, ignore.case=TRUE) |
      grepl("brivaracetam", PRODNME, ignore.case=TRUE) |
      grepl("briviact", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_brivaracetam_2009 <- as.numeric(codes_NDCNUM_brivaracetam_2009)


codes_NDCNUM_cenobamate_2009 <- redbook_2009_data %>% 
  filter(
      grepl("cenobamate", GENNME, ignore.case=TRUE) |
      grepl("cenobamate", THRDTDS, ignore.case=TRUE) |
      grepl("cenobamate", PRODNME, ignore.case=TRUE) |
      grepl("xcopri", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cenobamate_2009 <- as.numeric(codes_NDCNUM_cenobamate_2009)


codes_NDCNUM_clobazam_2009 <- redbook_2009_data %>% 
  filter(
      grepl("clobazam", GENNME, ignore.case=TRUE) |
      grepl("clobazam", THRDTDS, ignore.case=TRUE) |
      grepl("clobazam", PRODNME, ignore.case=TRUE) |
      grepl("onfi", PRODNME, ignore.case=TRUE) |
      grepl("sympazan", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("HIV", GENNME, ignore.case=TRUE) &
    !grepl("pregnancy", GENNME, ignore.case=TRUE) &
    !grepl("denture", GENNME, ignore.case=TRUE) &
    !grepl("hyoscyamine", GENNME, ignore.case=TRUE) &
    !grepl("glucose", GENNME, ignore.case=TRUE) &
    !grepl("device", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_clobazam_2009 <- as.numeric(codes_NDCNUM_clobazam_2009)


codes_NDCNUM_eslicarbazepine_2009 <- redbook_2009_data %>% 
  filter(
      grepl("eslicarbazepine", GENNME, ignore.case=TRUE) |
      grepl("eslicarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("eslicarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("aptiom", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_eslicarbazepine_2009 <- as.numeric(codes_NDCNUM_eslicarbazepine_2009)


codes_NDCNUM_ethosuximide_2009 <- redbook_2009_data %>% 
  filter(
      grepl("ethosuximide", GENNME, ignore.case=TRUE) |
      grepl("ethosuximide", THRDTDS, ignore.case=TRUE) |
      grepl("ethosuximide", PRODNME, ignore.case=TRUE) |
      grepl("zarontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_ethosuximide_2009 <- as.numeric(codes_NDCNUM_ethosuximide_2009)


codes_NDCNUM_lacosamide_2009 <- redbook_2009_data %>% 
  filter(
      grepl("lacosamide", GENNME, ignore.case=TRUE) |
      grepl("lacosamide", THRDTDS, ignore.case=TRUE) |
      grepl("lacosamide", PRODNME, ignore.case=TRUE) |
      grepl("vimpat", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lacosamide_2009 <- as.numeric(codes_NDCNUM_lacosamide_2009)


codes_NDCNUM_perampanel_2009 <- redbook_2009_data %>% 
  filter(
      grepl("perampanel", GENNME, ignore.case=TRUE) |
      grepl("perampanel", THRDTDS, ignore.case=TRUE) |
      grepl("perampanel", PRODNME, ignore.case=TRUE) |
      grepl("fycompa", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_perampanel_2009 <- as.numeric(codes_NDCNUM_perampanel_2009)


codes_NDCNUM_stiripentol_2009 <- redbook_2009_data %>% 
  filter(
      grepl("stiripentol", GENNME, ignore.case=TRUE) |
      grepl("stiripentol", THRDTDS, ignore.case=TRUE) |
      grepl("stiripentol", PRODNME, ignore.case=TRUE) |
      grepl("diacomit", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_stiripentol_2009 <- as.numeric(codes_NDCNUM_stiripentol_2009)


codes_NDCNUM_topiramate_2009 <- redbook_2009_data %>% 
  filter(
      grepl("topiramate", GENNME, ignore.case=TRUE) |
      grepl("topiramate", THRDTDS, ignore.case=TRUE) |
      grepl("topiramate", PRODNME, ignore.case=TRUE) |
      grepl("eprontia", PRODNME, ignore.case=TRUE) |
      grepl("topamax", PRODNME, ignore.case=TRUE) |
      grepl("trokendi", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE) &
    !grepl("qudexy", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_topiramate_2009 <- as.numeric(codes_NDCNUM_topiramate_2009)


codes_NDCNUM_vigabatrin_2009 <- redbook_2009_data %>% 
  filter(
      grepl("vigabatrin", GENNME, ignore.case=TRUE) |
      grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |
      grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
      grepl("sabril", PRODNME, ignore.case=TRUE) |
      grepl("vigadrone", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_vigabatrin_2009 <- as.numeric(codes_NDCNUM_vigabatrin_2009)


codes_NDCNUM_zonisamide_2009 <- redbook_2009_data %>% 
  filter(
      grepl("zonisamide", GENNME, ignore.case=TRUE) |
      grepl("zonisamide", THRDTDS, ignore.case=TRUE) |
      grepl("zonisamide", PRODNME, ignore.case=TRUE) |
      grepl("zonegran", PRODNME, ignore.case=TRUE) |
      grepl("zonisade", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_zonisamide_2009 <- as.numeric(codes_NDCNUM_zonisamide_2009)


codes_NDCNUM_felbamate_2009 <- redbook_2009_data %>% 
  filter(
      grepl("felbamate", GENNME, ignore.case=TRUE) |
      grepl("felbamate", THRDTDS, ignore.case=TRUE) |
      grepl("felbamate", PRODNME, ignore.case=TRUE) |
      grepl("felbatol", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_felbamate_2009 <- as.numeric(codes_NDCNUM_felbamate_2009)


codes_NDCNUM_pregabalin_2009 <- redbook_2009_data %>% 
  filter(
      grepl("pregabalin", GENNME, ignore.case=TRUE) |
      grepl("pregabalin", THRDTDS, ignore.case=TRUE) |
      grepl("pregabalin", PRODNME, ignore.case=TRUE) |
      grepl("lyrica", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_pregabalin_2009 <- as.numeric(codes_NDCNUM_pregabalin_2009)


codes_NDCNUM_tiagabine_2009 <- redbook_2009_data %>% 
  filter(
      grepl("tiagabine", GENNME, ignore.case=TRUE) |
      grepl("tiagabine", THRDTDS, ignore.case=TRUE) |
      grepl("tiagabine", PRODNME, ignore.case=TRUE) |
      grepl("gabitril", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_tiagabine_2009 <- as.numeric(codes_NDCNUM_tiagabine_2009)


codes_NDCNUM_cannabidiol_2009 <- redbook_2009_data %>% 
  filter(
      grepl("epidiolex", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cannabidiol_2009 <- as.numeric(codes_NDCNUM_cannabidiol_2009)


codes_NDCNUM_gabapentin_2009 <- redbook_2009_data %>% 
  filter(
      grepl("gabapentin", GENNME, ignore.case=TRUE) |
      grepl("gabapentin", THRDTDS, ignore.case=TRUE) |
      grepl("gabapentin", PRODNME, ignore.case=TRUE) |
      grepl("gralise", PRODNME, ignore.case=TRUE) |
      grepl("neurontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl(";", GENNME, ignore.case=TRUE) &
    !grepl("enacarbil", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_gabapentin_2009 <- as.numeric(codes_NDCNUM_gabapentin_2009)


codes_NDCNUM_fenfluramine_2009 <- redbook_2009_data %>% 
  filter(
      grepl("fenfluramine", GENNME, ignore.case=TRUE) |
      grepl("fenfluramine", THRDTDS, ignore.case=TRUE) |
      grepl("fenfluramine", PRODNME, ignore.case=TRUE) |
      grepl("fintepla", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("dex", GENNME, ignore.case=TRUE) &
    !grepl("dex", THRDTDS, ignore.case=TRUE) &
    !grepl("hydrochloride", GENNME, ignore.case=TRUE) &    
    !grepl("hydrochloride", THRDTDS, ignore.case=TRUE) &
    !grepl("pondimin", PRODNME, ignore.case=TRUE) &
    !grepl("redux", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_fenfluramine_2009 <- as.numeric(codes_NDCNUM_fenfluramine_2009)


codes_NDCNUM_methsuximide_2009 <- redbook_2009_data %>% 
  filter(
      grepl("methsuximide", GENNME, ignore.case=TRUE) |
      grepl("methsuximide", THRDTDS, ignore.case=TRUE) |
      grepl("methsuximide", PRODNME, ignore.case=TRUE) |
      grepl("celontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_methsuximide_2009 <- as.numeric(codes_NDCNUM_methsuximide_2009)


codes_NDCNUM_ASM_2009 <- c(
  codes_NDCNUM_phenobarbital_2009,
  codes_NDCNUM_phenytoin_2009,
  codes_NDCNUM_valproate_2009,
  codes_NDCNUM_carbamazepine_2009,
  codes_NDCNUM_oxcarbazepine_2009,
  codes_NDCNUM_rufinamide_2009,
  codes_NDCNUM_levetiracetam_2009,
  codes_NDCNUM_lamotrigine_2009,
  codes_NDCNUM_brivaracetam_2009,
  codes_NDCNUM_cenobamate_2009,
  codes_NDCNUM_clobazam_2009,
  codes_NDCNUM_eslicarbazepine_2009,
  codes_NDCNUM_ethosuximide_2009,
  codes_NDCNUM_lacosamide_2009,
  codes_NDCNUM_perampanel_2009,
  codes_NDCNUM_stiripentol_2009,
  codes_NDCNUM_topiramate_2009,
  codes_NDCNUM_vigabatrin_2009,
  codes_NDCNUM_zonisamide_2009,
  codes_NDCNUM_felbamate_2009,
  codes_NDCNUM_pregabalin_2009,
  codes_NDCNUM_tiagabine_2009,
  codes_NDCNUM_cannabidiol_2009,
  codes_NDCNUM_gabapentin_2009,
  codes_NDCNUM_fenfluramine_2009,
  codes_NDCNUM_methsuximide_2009
)




############################################2010############################################
codes_NDCNUM_phenobarbital_2010 <- redbook_2010_data %>% 
  filter(
      grepl("phenobarb", GENNME, ignore.case=TRUE) |
      grepl("phenobarb", THRDTDS, ignore.case=TRUE) |
      grepl("phenobarb", PRODNME, ignore.case=TRUE) |
      grepl("luminal", PRODNME, ignore.case=TRUE) |
      grepl("solfoton", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenobarbital_2010 <- as.numeric(codes_NDCNUM_phenobarbital_2010)


codes_NDCNUM_phenytoin_2010 <- redbook_2010_data %>% 
  filter(
      grepl("phenytoin", GENNME, ignore.case=TRUE) |
      grepl("phenytoin", THRDTDS, ignore.case=TRUE) |
      grepl("phenytoin", PRODNME, ignore.case=TRUE) |
      grepl("dilantin", PRODNME, ignore.case=TRUE) |
      grepl("phenytek", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenytoin_2010 <- as.numeric(codes_NDCNUM_phenytoin_2010)


codes_NDCNUM_valproate_2010 <- redbook_2010_data %>% 
  filter(
      grepl("valpro", GENNME, ignore.case=TRUE) |
      grepl("valpro", THRDTDS, ignore.case=TRUE) |
      grepl("valpro", PRODNME, ignore.case=TRUE) |
      grepl("depakene", PRODNME, ignore.case=TRUE) |
      grepl("depakote", PRODNME, ignore.case=TRUE) |
      grepl("depacon", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_valproate_2010 <- as.numeric(codes_NDCNUM_valproate_2010)


codes_NDCNUM_carbamazepine_2010 <- redbook_2010_data %>% 
  filter(
      grepl("carbamazepine", GENNME, ignore.case=TRUE) |
      grepl("carbamazepine", THRDTDS, ignore.case=TRUE) |
      grepl("carbamazepine", PRODNME, ignore.case=TRUE) |
      grepl("tegretol", PRODNME, ignore.case=TRUE) |
      grepl("carbatrol", PRODNME, ignore.case=TRUE) |
      grepl("epitol", PRODNME, ignore.case=TRUE) |
      grepl("equetro", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("atretol", PRODNME, ignore.case=TRUE)
    ) %>%   
  pull(NDCNUM)
codes_NDCNUM_carbamazepine_2010 <- as.numeric(codes_NDCNUM_carbamazepine_2010)


codes_NDCNUM_oxcarbazepine_2010 <- redbook_2010_data %>% 
  filter(
      grepl("oxcarbazepine", GENNME, ignore.case=TRUE) |
      grepl("oxcarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("oxcarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("oxtellar", PRODNME, ignore.case=TRUE) |
      grepl("trileptal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_oxcarbazepine_2010 <- as.numeric(codes_NDCNUM_oxcarbazepine_2010)


codes_NDCNUM_rufinamide_2010 <- redbook_2010_data %>% 
  filter(
      grepl("rufinamide", GENNME, ignore.case=TRUE) |
      grepl("rufinamide", THRDTDS, ignore.case=TRUE) |
      grepl("rufinamide", PRODNME, ignore.case=TRUE) |
      grepl("banzel", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rufinamide_2010 <- as.numeric(codes_NDCNUM_rufinamide_2010)


codes_NDCNUM_levetiracetam_2010 <- redbook_2010_data %>% 
  filter(
      grepl("levetiracetam", GENNME, ignore.case=TRUE) |
      grepl("levetiracetam", THRDTDS, ignore.case=TRUE) |
      grepl("levetiracetam", PRODNME, ignore.case=TRUE) |
      grepl("elepsia", PRODNME, ignore.case=TRUE) |
      grepl("keppra", PRODNME, ignore.case=TRUE) |
      grepl("roweepra", PRODNME, ignore.case=TRUE) |
      grepl("spritam", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_levetiracetam_2010 <- as.numeric(codes_NDCNUM_levetiracetam_2010)


codes_NDCNUM_lamotrigine_2010 <- redbook_2010_data %>% 
  filter(
      grepl("lamotrigine", GENNME, ignore.case=TRUE) |
      grepl("lamotrigine", THRDTDS, ignore.case=TRUE) |
      grepl("lamotrigine", PRODNME, ignore.case=TRUE) |
      grepl("lamictal", PRODNME, ignore.case=TRUE) |
      grepl("subvenite", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lamotrigine_2010 <- as.numeric(codes_NDCNUM_lamotrigine_2010)


codes_NDCNUM_brivaracetam_2010 <- redbook_2010_data %>% 
  filter(
      grepl("brivaracetam", GENNME, ignore.case=TRUE) |
      grepl("brivaracetam", THRDTDS, ignore.case=TRUE) |
      grepl("brivaracetam", PRODNME, ignore.case=TRUE) |
      grepl("briviact", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_brivaracetam_2010 <- as.numeric(codes_NDCNUM_brivaracetam_2010)


codes_NDCNUM_cenobamate_2010 <- redbook_2010_data %>% 
  filter(
      grepl("cenobamate", GENNME, ignore.case=TRUE) |
      grepl("cenobamate", THRDTDS, ignore.case=TRUE) |
      grepl("cenobamate", PRODNME, ignore.case=TRUE) |
      grepl("xcopri", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cenobamate_2010 <- as.numeric(codes_NDCNUM_cenobamate_2010)


codes_NDCNUM_clobazam_2010 <- redbook_2010_data %>% 
  filter(
      grepl("clobazam", GENNME, ignore.case=TRUE) |
      grepl("clobazam", THRDTDS, ignore.case=TRUE) |
      grepl("clobazam", PRODNME, ignore.case=TRUE) |
      grepl("onfi", PRODNME, ignore.case=TRUE) |
      grepl("sympazan", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("HIV", GENNME, ignore.case=TRUE) &
    !grepl("pregnancy", GENNME, ignore.case=TRUE) &
    !grepl("denture", GENNME, ignore.case=TRUE) &
    !grepl("hyoscyamine", GENNME, ignore.case=TRUE) &
    !grepl("glucose", GENNME, ignore.case=TRUE) &
    !grepl("device", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_clobazam_2010 <- as.numeric(codes_NDCNUM_clobazam_2010)


codes_NDCNUM_eslicarbazepine_2010 <- redbook_2010_data %>% 
  filter(
      grepl("eslicarbazepine", GENNME, ignore.case=TRUE) |
      grepl("eslicarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("eslicarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("aptiom", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_eslicarbazepine_2010 <- as.numeric(codes_NDCNUM_eslicarbazepine_2010)


codes_NDCNUM_ethosuximide_2010 <- redbook_2010_data %>% 
  filter(
      grepl("ethosuximide", GENNME, ignore.case=TRUE) |
      grepl("ethosuximide", THRDTDS, ignore.case=TRUE) |
      grepl("ethosuximide", PRODNME, ignore.case=TRUE) |
      grepl("zarontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_ethosuximide_2010 <- as.numeric(codes_NDCNUM_ethosuximide_2010)


codes_NDCNUM_lacosamide_2010 <- redbook_2010_data %>% 
  filter(
      grepl("lacosamide", GENNME, ignore.case=TRUE) |
      grepl("lacosamide", THRDTDS, ignore.case=TRUE) |
      grepl("lacosamide", PRODNME, ignore.case=TRUE) |
      grepl("vimpat", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lacosamide_2010 <- as.numeric(codes_NDCNUM_lacosamide_2010)


codes_NDCNUM_perampanel_2010 <- redbook_2010_data %>% 
  filter(
      grepl("perampanel", GENNME, ignore.case=TRUE) |
      grepl("perampanel", THRDTDS, ignore.case=TRUE) |
      grepl("perampanel", PRODNME, ignore.case=TRUE) |
      grepl("fycompa", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_perampanel_2010 <- as.numeric(codes_NDCNUM_perampanel_2010)


codes_NDCNUM_stiripentol_2010 <- redbook_2010_data %>% 
  filter(
      grepl("stiripentol", GENNME, ignore.case=TRUE) |
      grepl("stiripentol", THRDTDS, ignore.case=TRUE) |
      grepl("stiripentol", PRODNME, ignore.case=TRUE) |
      grepl("diacomit", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_stiripentol_2010 <- as.numeric(codes_NDCNUM_stiripentol_2010)


codes_NDCNUM_topiramate_2010 <- redbook_2010_data %>% 
  filter(
      grepl("topiramate", GENNME, ignore.case=TRUE) |
      grepl("topiramate", THRDTDS, ignore.case=TRUE) |
      grepl("topiramate", PRODNME, ignore.case=TRUE) |
      grepl("eprontia", PRODNME, ignore.case=TRUE) |
      grepl("topamax", PRODNME, ignore.case=TRUE) |
      grepl("trokendi", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE) &
    !grepl("qudexy", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_topiramate_2010 <- as.numeric(codes_NDCNUM_topiramate_2010)


codes_NDCNUM_vigabatrin_2010 <- redbook_2010_data %>% 
  filter(
      grepl("vigabatrin", GENNME, ignore.case=TRUE) |
      grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |
      grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
      grepl("sabril", PRODNME, ignore.case=TRUE) |
      grepl("vigadrone", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_vigabatrin_2010 <- as.numeric(codes_NDCNUM_vigabatrin_2010)


codes_NDCNUM_zonisamide_2010 <- redbook_2010_data %>% 
  filter(
      grepl("zonisamide", GENNME, ignore.case=TRUE) |
      grepl("zonisamide", THRDTDS, ignore.case=TRUE) |
      grepl("zonisamide", PRODNME, ignore.case=TRUE) |
      grepl("zonegran", PRODNME, ignore.case=TRUE) |
      grepl("zonisade", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_zonisamide_2010 <- as.numeric(codes_NDCNUM_zonisamide_2010)


codes_NDCNUM_felbamate_2010 <- redbook_2010_data %>% 
  filter(
      grepl("felbamate", GENNME, ignore.case=TRUE) |
      grepl("felbamate", THRDTDS, ignore.case=TRUE) |
      grepl("felbamate", PRODNME, ignore.case=TRUE) |
      grepl("felbatol", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_felbamate_2010 <- as.numeric(codes_NDCNUM_felbamate_2010)


codes_NDCNUM_pregabalin_2010 <- redbook_2010_data %>% 
  filter(
      grepl("pregabalin", GENNME, ignore.case=TRUE) |
      grepl("pregabalin", THRDTDS, ignore.case=TRUE) |
      grepl("pregabalin", PRODNME, ignore.case=TRUE) |
      grepl("lyrica", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_pregabalin_2010 <- as.numeric(codes_NDCNUM_pregabalin_2010)


codes_NDCNUM_tiagabine_2010 <- redbook_2010_data %>% 
  filter(
      grepl("tiagabine", GENNME, ignore.case=TRUE) |
      grepl("tiagabine", THRDTDS, ignore.case=TRUE) |
      grepl("tiagabine", PRODNME, ignore.case=TRUE) |
      grepl("gabitril", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_tiagabine_2010 <- as.numeric(codes_NDCNUM_tiagabine_2010)


codes_NDCNUM_cannabidiol_2010 <- redbook_2010_data %>% 
  filter(
      grepl("epidiolex", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cannabidiol_2010 <- as.numeric(codes_NDCNUM_cannabidiol_2010)


codes_NDCNUM_gabapentin_2010 <- redbook_2010_data %>% 
  filter(
      grepl("gabapentin", GENNME, ignore.case=TRUE) |
      grepl("gabapentin", THRDTDS, ignore.case=TRUE) |
      grepl("gabapentin", PRODNME, ignore.case=TRUE) |
      grepl("gralise", PRODNME, ignore.case=TRUE) |
      grepl("neurontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl(";", GENNME, ignore.case=TRUE) &
    !grepl("enacarbil", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_gabapentin_2010 <- as.numeric(codes_NDCNUM_gabapentin_2010)


codes_NDCNUM_fenfluramine_2010 <- redbook_2010_data %>% 
  filter(
      grepl("fenfluramine", GENNME, ignore.case=TRUE) |
      grepl("fenfluramine", THRDTDS, ignore.case=TRUE) |
      grepl("fenfluramine", PRODNME, ignore.case=TRUE) |
      grepl("fintepla", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("dex", GENNME, ignore.case=TRUE) &
    !grepl("dex", THRDTDS, ignore.case=TRUE) &
    !grepl("hydrochloride", GENNME, ignore.case=TRUE) &    
    !grepl("hydrochloride", THRDTDS, ignore.case=TRUE) &
    !grepl("pondimin", PRODNME, ignore.case=TRUE) &
    !grepl("redux", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_fenfluramine_2010 <- as.numeric(codes_NDCNUM_fenfluramine_2010)


codes_NDCNUM_methsuximide_2010 <- redbook_2010_data %>% 
  filter(
      grepl("methsuximide", GENNME, ignore.case=TRUE) |
      grepl("methsuximide", THRDTDS, ignore.case=TRUE) |
      grepl("methsuximide", PRODNME, ignore.case=TRUE) |
      grepl("celontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_methsuximide_2010 <- as.numeric(codes_NDCNUM_methsuximide_2010)


codes_NDCNUM_ASM_2010 <- c(
  codes_NDCNUM_phenobarbital_2010,
  codes_NDCNUM_phenytoin_2010,
  codes_NDCNUM_valproate_2010,
  codes_NDCNUM_carbamazepine_2010,
  codes_NDCNUM_oxcarbazepine_2010,
  codes_NDCNUM_rufinamide_2010,
  codes_NDCNUM_levetiracetam_2010,
  codes_NDCNUM_lamotrigine_2010,
  codes_NDCNUM_brivaracetam_2010,
  codes_NDCNUM_cenobamate_2010,
  codes_NDCNUM_clobazam_2010,
  codes_NDCNUM_eslicarbazepine_2010,
  codes_NDCNUM_ethosuximide_2010,
  codes_NDCNUM_lacosamide_2010,
  codes_NDCNUM_perampanel_2010,
  codes_NDCNUM_stiripentol_2010,
  codes_NDCNUM_topiramate_2010,
  codes_NDCNUM_vigabatrin_2010,
  codes_NDCNUM_zonisamide_2010,
  codes_NDCNUM_felbamate_2010,
  codes_NDCNUM_pregabalin_2010,
  codes_NDCNUM_tiagabine_2010,
  codes_NDCNUM_cannabidiol_2010,
  codes_NDCNUM_gabapentin_2010,
  codes_NDCNUM_fenfluramine_2010,
  codes_NDCNUM_methsuximide_2010
)




############################################2011############################################
codes_NDCNUM_phenobarbital_2011 <- redbook_2011_data %>% 
  filter(
      grepl("phenobarb", GENNME, ignore.case=TRUE) |
      grepl("phenobarb", THRDTDS, ignore.case=TRUE) |
      grepl("phenobarb", PRODNME, ignore.case=TRUE) |
      grepl("luminal", PRODNME, ignore.case=TRUE) |
      grepl("solfoton", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenobarbital_2011 <- as.numeric(codes_NDCNUM_phenobarbital_2011)


codes_NDCNUM_phenytoin_2011 <- redbook_2011_data %>% 
  filter(
      grepl("phenytoin", GENNME, ignore.case=TRUE) |
      grepl("phenytoin", THRDTDS, ignore.case=TRUE) |
      grepl("phenytoin", PRODNME, ignore.case=TRUE) |
      grepl("dilantin", PRODNME, ignore.case=TRUE) |
      grepl("phenytek", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenytoin_2011 <- as.numeric(codes_NDCNUM_phenytoin_2011)


codes_NDCNUM_valproate_2011 <- redbook_2011_data %>% 
  filter(
      grepl("valpro", GENNME, ignore.case=TRUE) |
      grepl("valpro", THRDTDS, ignore.case=TRUE) |
      grepl("valpro", PRODNME, ignore.case=TRUE) |
      grepl("depakene", PRODNME, ignore.case=TRUE) |
      grepl("depakote", PRODNME, ignore.case=TRUE) |
      grepl("depacon", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_valproate_2011 <- as.numeric(codes_NDCNUM_valproate_2011)


codes_NDCNUM_carbamazepine_2011 <- redbook_2011_data %>% 
  filter(
      grepl("carbamazepine", GENNME, ignore.case=TRUE) |
      grepl("carbamazepine", THRDTDS, ignore.case=TRUE) |
      grepl("carbamazepine", PRODNME, ignore.case=TRUE) |
      grepl("tegretol", PRODNME, ignore.case=TRUE) |
      grepl("carbatrol", PRODNME, ignore.case=TRUE) |
      grepl("epitol", PRODNME, ignore.case=TRUE) |
      grepl("equetro", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("atretol", PRODNME, ignore.case=TRUE)
    ) %>%   
  pull(NDCNUM)
codes_NDCNUM_carbamazepine_2011 <- as.numeric(codes_NDCNUM_carbamazepine_2011)


codes_NDCNUM_oxcarbazepine_2011 <- redbook_2011_data %>% 
  filter(
      grepl("oxcarbazepine", GENNME, ignore.case=TRUE) |
      grepl("oxcarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("oxcarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("oxtellar", PRODNME, ignore.case=TRUE) |
      grepl("trileptal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_oxcarbazepine_2011 <- as.numeric(codes_NDCNUM_oxcarbazepine_2011)


codes_NDCNUM_rufinamide_2011 <- redbook_2011_data %>% 
  filter(
      grepl("rufinamide", GENNME, ignore.case=TRUE) |
      grepl("rufinamide", THRDTDS, ignore.case=TRUE) |
      grepl("rufinamide", PRODNME, ignore.case=TRUE) |
      grepl("banzel", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rufinamide_2011 <- as.numeric(codes_NDCNUM_rufinamide_2011)


codes_NDCNUM_levetiracetam_2011 <- redbook_2011_data %>% 
  filter(
      grepl("levetiracetam", GENNME, ignore.case=TRUE) |
      grepl("levetiracetam", THRDTDS, ignore.case=TRUE) |
      grepl("levetiracetam", PRODNME, ignore.case=TRUE) |
      grepl("elepsia", PRODNME, ignore.case=TRUE) |
      grepl("keppra", PRODNME, ignore.case=TRUE) |
      grepl("roweepra", PRODNME, ignore.case=TRUE) |
      grepl("spritam", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_levetiracetam_2011 <- as.numeric(codes_NDCNUM_levetiracetam_2011)


codes_NDCNUM_lamotrigine_2011 <- redbook_2011_data %>% 
  filter(
      grepl("lamotrigine", GENNME, ignore.case=TRUE) |
      grepl("lamotrigine", THRDTDS, ignore.case=TRUE) |
      grepl("lamotrigine", PRODNME, ignore.case=TRUE) |
      grepl("lamictal", PRODNME, ignore.case=TRUE) |
      grepl("subvenite", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lamotrigine_2011 <- as.numeric(codes_NDCNUM_lamotrigine_2011)


codes_NDCNUM_brivaracetam_2011 <- redbook_2011_data %>% 
  filter(
      grepl("brivaracetam", GENNME, ignore.case=TRUE) |
      grepl("brivaracetam", THRDTDS, ignore.case=TRUE) |
      grepl("brivaracetam", PRODNME, ignore.case=TRUE) |
      grepl("briviact", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_brivaracetam_2011 <- as.numeric(codes_NDCNUM_brivaracetam_2011)


codes_NDCNUM_cenobamate_2011 <- redbook_2011_data %>% 
  filter(
      grepl("cenobamate", GENNME, ignore.case=TRUE) |
      grepl("cenobamate", THRDTDS, ignore.case=TRUE) |
      grepl("cenobamate", PRODNME, ignore.case=TRUE) |
      grepl("xcopri", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cenobamate_2011 <- as.numeric(codes_NDCNUM_cenobamate_2011)


codes_NDCNUM_clobazam_2011 <- redbook_2011_data %>% 
  filter(
      grepl("clobazam", GENNME, ignore.case=TRUE) |
      grepl("clobazam", THRDTDS, ignore.case=TRUE) |
      grepl("clobazam", PRODNME, ignore.case=TRUE) |
      grepl("onfi", PRODNME, ignore.case=TRUE) |
      grepl("sympazan", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("HIV", GENNME, ignore.case=TRUE) &
    !grepl("pregnancy", GENNME, ignore.case=TRUE) &
    !grepl("denture", GENNME, ignore.case=TRUE) &
    !grepl("hyoscyamine", GENNME, ignore.case=TRUE) &
    !grepl("glucose", GENNME, ignore.case=TRUE) &
    !grepl("device", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_clobazam_2011 <- as.numeric(codes_NDCNUM_clobazam_2011)


codes_NDCNUM_eslicarbazepine_2011 <- redbook_2011_data %>% 
  filter(
      grepl("eslicarbazepine", GENNME, ignore.case=TRUE) |
      grepl("eslicarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("eslicarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("aptiom", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_eslicarbazepine_2011 <- as.numeric(codes_NDCNUM_eslicarbazepine_2011)


codes_NDCNUM_ethosuximide_2011 <- redbook_2011_data %>% 
  filter(
      grepl("ethosuximide", GENNME, ignore.case=TRUE) |
      grepl("ethosuximide", THRDTDS, ignore.case=TRUE) |
      grepl("ethosuximide", PRODNME, ignore.case=TRUE) |
      grepl("zarontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_ethosuximide_2011 <- as.numeric(codes_NDCNUM_ethosuximide_2011)


codes_NDCNUM_lacosamide_2011 <- redbook_2011_data %>% 
  filter(
      grepl("lacosamide", GENNME, ignore.case=TRUE) |
      grepl("lacosamide", THRDTDS, ignore.case=TRUE) |
      grepl("lacosamide", PRODNME, ignore.case=TRUE) |
      grepl("vimpat", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lacosamide_2011 <- as.numeric(codes_NDCNUM_lacosamide_2011)


codes_NDCNUM_perampanel_2011 <- redbook_2011_data %>% 
  filter(
      grepl("perampanel", GENNME, ignore.case=TRUE) |
      grepl("perampanel", THRDTDS, ignore.case=TRUE) |
      grepl("perampanel", PRODNME, ignore.case=TRUE) |
      grepl("fycompa", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_perampanel_2011 <- as.numeric(codes_NDCNUM_perampanel_2011)


codes_NDCNUM_stiripentol_2011 <- redbook_2011_data %>% 
  filter(
      grepl("stiripentol", GENNME, ignore.case=TRUE) |
      grepl("stiripentol", THRDTDS, ignore.case=TRUE) |
      grepl("stiripentol", PRODNME, ignore.case=TRUE) |
      grepl("diacomit", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_stiripentol_2011 <- as.numeric(codes_NDCNUM_stiripentol_2011)


codes_NDCNUM_topiramate_2011 <- redbook_2011_data %>% 
  filter(
      grepl("topiramate", GENNME, ignore.case=TRUE) |
      grepl("topiramate", THRDTDS, ignore.case=TRUE) |
      grepl("topiramate", PRODNME, ignore.case=TRUE) |
      grepl("eprontia", PRODNME, ignore.case=TRUE) |
      grepl("topamax", PRODNME, ignore.case=TRUE) |
      grepl("trokendi", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE) &
    !grepl("qudexy", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_topiramate_2011 <- as.numeric(codes_NDCNUM_topiramate_2011)


codes_NDCNUM_vigabatrin_2011 <- redbook_2011_data %>% 
  filter(
      grepl("vigabatrin", GENNME, ignore.case=TRUE) |
      grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |
      grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
      grepl("sabril", PRODNME, ignore.case=TRUE) |
      grepl("vigadrone", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_vigabatrin_2011 <- as.numeric(codes_NDCNUM_vigabatrin_2011)


codes_NDCNUM_zonisamide_2011 <- redbook_2011_data %>% 
  filter(
      grepl("zonisamide", GENNME, ignore.case=TRUE) |
      grepl("zonisamide", THRDTDS, ignore.case=TRUE) |
      grepl("zonisamide", PRODNME, ignore.case=TRUE) |
      grepl("zonegran", PRODNME, ignore.case=TRUE) |
      grepl("zonisade", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_zonisamide_2011 <- as.numeric(codes_NDCNUM_zonisamide_2011)


codes_NDCNUM_felbamate_2011 <- redbook_2011_data %>% 
  filter(
      grepl("felbamate", GENNME, ignore.case=TRUE) |
      grepl("felbamate", THRDTDS, ignore.case=TRUE) |
      grepl("felbamate", PRODNME, ignore.case=TRUE) |
      grepl("felbatol", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_felbamate_2011 <- as.numeric(codes_NDCNUM_felbamate_2011)


codes_NDCNUM_pregabalin_2011 <- redbook_2011_data %>% 
  filter(
      grepl("pregabalin", GENNME, ignore.case=TRUE) |
      grepl("pregabalin", THRDTDS, ignore.case=TRUE) |
      grepl("pregabalin", PRODNME, ignore.case=TRUE) |
      grepl("lyrica", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_pregabalin_2011 <- as.numeric(codes_NDCNUM_pregabalin_2011)


codes_NDCNUM_tiagabine_2011 <- redbook_2011_data %>% 
  filter(
      grepl("tiagabine", GENNME, ignore.case=TRUE) |
      grepl("tiagabine", THRDTDS, ignore.case=TRUE) |
      grepl("tiagabine", PRODNME, ignore.case=TRUE) |
      grepl("gabitril", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_tiagabine_2011 <- as.numeric(codes_NDCNUM_tiagabine_2011)


codes_NDCNUM_cannabidiol_2011 <- redbook_2011_data %>% 
  filter(
      grepl("epidiolex", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cannabidiol_2011 <- as.numeric(codes_NDCNUM_cannabidiol_2011)


codes_NDCNUM_gabapentin_2011 <- redbook_2011_data %>% 
  filter(
      grepl("gabapentin", GENNME, ignore.case=TRUE) |
      grepl("gabapentin", THRDTDS, ignore.case=TRUE) |
      grepl("gabapentin", PRODNME, ignore.case=TRUE) |
      grepl("gralise", PRODNME, ignore.case=TRUE) |
      grepl("neurontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl(";", GENNME, ignore.case=TRUE) &
    !grepl("enacarbil", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_gabapentin_2011 <- as.numeric(codes_NDCNUM_gabapentin_2011)


codes_NDCNUM_fenfluramine_2011 <- redbook_2011_data %>% 
  filter(
      grepl("fenfluramine", GENNME, ignore.case=TRUE) |
      grepl("fenfluramine", THRDTDS, ignore.case=TRUE) |
      grepl("fenfluramine", PRODNME, ignore.case=TRUE) |
      grepl("fintepla", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("dex", GENNME, ignore.case=TRUE) &
    !grepl("dex", THRDTDS, ignore.case=TRUE) &
    !grepl("hydrochloride", GENNME, ignore.case=TRUE) &    
    !grepl("hydrochloride", THRDTDS, ignore.case=TRUE) &
    !grepl("pondimin", PRODNME, ignore.case=TRUE) &
    !grepl("redux", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_fenfluramine_2011 <- as.numeric(codes_NDCNUM_fenfluramine_2011)


codes_NDCNUM_methsuximide_2011 <- redbook_2011_data %>% 
  filter(
      grepl("methsuximide", GENNME, ignore.case=TRUE) |
      grepl("methsuximide", THRDTDS, ignore.case=TRUE) |
      grepl("methsuximide", PRODNME, ignore.case=TRUE) |
      grepl("celontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_methsuximide_2011 <- as.numeric(codes_NDCNUM_methsuximide_2011)


codes_NDCNUM_ASM_2011 <- c(
  codes_NDCNUM_phenobarbital_2011,
  codes_NDCNUM_phenytoin_2011,
  codes_NDCNUM_valproate_2011,
  codes_NDCNUM_carbamazepine_2011,
  codes_NDCNUM_oxcarbazepine_2011,
  codes_NDCNUM_rufinamide_2011,
  codes_NDCNUM_levetiracetam_2011,
  codes_NDCNUM_lamotrigine_2011,
  codes_NDCNUM_brivaracetam_2011,
  codes_NDCNUM_cenobamate_2011,
  codes_NDCNUM_clobazam_2011,
  codes_NDCNUM_eslicarbazepine_2011,
  codes_NDCNUM_ethosuximide_2011,
  codes_NDCNUM_lacosamide_2011,
  codes_NDCNUM_perampanel_2011,
  codes_NDCNUM_stiripentol_2011,
  codes_NDCNUM_topiramate_2011,
  codes_NDCNUM_vigabatrin_2011,
  codes_NDCNUM_zonisamide_2011,
  codes_NDCNUM_felbamate_2011,
  codes_NDCNUM_pregabalin_2011,
  codes_NDCNUM_tiagabine_2011,
  codes_NDCNUM_cannabidiol_2011,
  codes_NDCNUM_gabapentin_2011,
  codes_NDCNUM_fenfluramine_2011,
  codes_NDCNUM_methsuximide_2011
)




############################################2012############################################
codes_NDCNUM_phenobarbital_2012 <- redbook_2012_data %>% 
  filter(
      grepl("phenobarb", GENNME, ignore.case=TRUE) |
      grepl("phenobarb", THRDTDS, ignore.case=TRUE) |
      grepl("phenobarb", PRODNME, ignore.case=TRUE) |
      grepl("luminal", PRODNME, ignore.case=TRUE) |
      grepl("solfoton", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenobarbital_2012 <- as.numeric(codes_NDCNUM_phenobarbital_2012)


codes_NDCNUM_phenytoin_2012 <- redbook_2012_data %>% 
  filter(
      grepl("phenytoin", GENNME, ignore.case=TRUE) |
      grepl("phenytoin", THRDTDS, ignore.case=TRUE) |
      grepl("phenytoin", PRODNME, ignore.case=TRUE) |
      grepl("dilantin", PRODNME, ignore.case=TRUE) |
      grepl("phenytek", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenytoin_2012 <- as.numeric(codes_NDCNUM_phenytoin_2012)


codes_NDCNUM_valproate_2012 <- redbook_2012_data %>% 
  filter(
      grepl("valpro", GENNME, ignore.case=TRUE) |
      grepl("valpro", THRDTDS, ignore.case=TRUE) |
      grepl("valpro", PRODNME, ignore.case=TRUE) |
      grepl("depakene", PRODNME, ignore.case=TRUE) |
      grepl("depakote", PRODNME, ignore.case=TRUE) |
      grepl("depacon", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_valproate_2012 <- as.numeric(codes_NDCNUM_valproate_2012)


codes_NDCNUM_carbamazepine_2012 <- redbook_2012_data %>% 
  filter(
      grepl("carbamazepine", GENNME, ignore.case=TRUE) |
      grepl("carbamazepine", THRDTDS, ignore.case=TRUE) |
      grepl("carbamazepine", PRODNME, ignore.case=TRUE) |
      grepl("tegretol", PRODNME, ignore.case=TRUE) |
      grepl("carbatrol", PRODNME, ignore.case=TRUE) |
      grepl("epitol", PRODNME, ignore.case=TRUE) |
      grepl("equetro", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("atretol", PRODNME, ignore.case=TRUE)
    ) %>%   
  pull(NDCNUM)
codes_NDCNUM_carbamazepine_2012 <- as.numeric(codes_NDCNUM_carbamazepine_2012)


codes_NDCNUM_oxcarbazepine_2012 <- redbook_2012_data %>% 
  filter(
      grepl("oxcarbazepine", GENNME, ignore.case=TRUE) |
      grepl("oxcarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("oxcarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("oxtellar", PRODNME, ignore.case=TRUE) |
      grepl("trileptal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_oxcarbazepine_2012 <- as.numeric(codes_NDCNUM_oxcarbazepine_2012)


codes_NDCNUM_rufinamide_2012 <- redbook_2012_data %>% 
  filter(
      grepl("rufinamide", GENNME, ignore.case=TRUE) |
      grepl("rufinamide", THRDTDS, ignore.case=TRUE) |
      grepl("rufinamide", PRODNME, ignore.case=TRUE) |
      grepl("banzel", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rufinamide_2012 <- as.numeric(codes_NDCNUM_rufinamide_2012)


codes_NDCNUM_levetiracetam_2012 <- redbook_2012_data %>% 
  filter(
      grepl("levetiracetam", GENNME, ignore.case=TRUE) |
      grepl("levetiracetam", THRDTDS, ignore.case=TRUE) |
      grepl("levetiracetam", PRODNME, ignore.case=TRUE) |
      grepl("elepsia", PRODNME, ignore.case=TRUE) |
      grepl("keppra", PRODNME, ignore.case=TRUE) |
      grepl("roweepra", PRODNME, ignore.case=TRUE) |
      grepl("spritam", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_levetiracetam_2012 <- as.numeric(codes_NDCNUM_levetiracetam_2012)


codes_NDCNUM_lamotrigine_2012 <- redbook_2012_data %>% 
  filter(
      grepl("lamotrigine", GENNME, ignore.case=TRUE) |
      grepl("lamotrigine", THRDTDS, ignore.case=TRUE) |
      grepl("lamotrigine", PRODNME, ignore.case=TRUE) |
      grepl("lamictal", PRODNME, ignore.case=TRUE) |
      grepl("subvenite", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lamotrigine_2012 <- as.numeric(codes_NDCNUM_lamotrigine_2012)


codes_NDCNUM_brivaracetam_2012 <- redbook_2012_data %>% 
  filter(
      grepl("brivaracetam", GENNME, ignore.case=TRUE) |
      grepl("brivaracetam", THRDTDS, ignore.case=TRUE) |
      grepl("brivaracetam", PRODNME, ignore.case=TRUE) |
      grepl("briviact", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_brivaracetam_2012 <- as.numeric(codes_NDCNUM_brivaracetam_2012)


codes_NDCNUM_cenobamate_2012 <- redbook_2012_data %>% 
  filter(
      grepl("cenobamate", GENNME, ignore.case=TRUE) |
      grepl("cenobamate", THRDTDS, ignore.case=TRUE) |
      grepl("cenobamate", PRODNME, ignore.case=TRUE) |
      grepl("xcopri", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cenobamate_2012 <- as.numeric(codes_NDCNUM_cenobamate_2012)


codes_NDCNUM_clobazam_2012 <- redbook_2012_data %>% 
  filter(
      grepl("clobazam", GENNME, ignore.case=TRUE) |
      grepl("clobazam", THRDTDS, ignore.case=TRUE) |
      grepl("clobazam", PRODNME, ignore.case=TRUE) |
      grepl("onfi", PRODNME, ignore.case=TRUE) |
      grepl("sympazan", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("HIV", GENNME, ignore.case=TRUE) &
    !grepl("pregnancy", GENNME, ignore.case=TRUE) &
    !grepl("denture", GENNME, ignore.case=TRUE) &
    !grepl("hyoscyamine", GENNME, ignore.case=TRUE) &
    !grepl("glucose", GENNME, ignore.case=TRUE) &
    !grepl("device", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_clobazam_2012 <- as.numeric(codes_NDCNUM_clobazam_2012)


codes_NDCNUM_eslicarbazepine_2012 <- redbook_2012_data %>% 
  filter(
      grepl("eslicarbazepine", GENNME, ignore.case=TRUE) |
      grepl("eslicarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("eslicarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("aptiom", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_eslicarbazepine_2012 <- as.numeric(codes_NDCNUM_eslicarbazepine_2012)


codes_NDCNUM_ethosuximide_2012 <- redbook_2012_data %>% 
  filter(
      grepl("ethosuximide", GENNME, ignore.case=TRUE) |
      grepl("ethosuximide", THRDTDS, ignore.case=TRUE) |
      grepl("ethosuximide", PRODNME, ignore.case=TRUE) |
      grepl("zarontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_ethosuximide_2012 <- as.numeric(codes_NDCNUM_ethosuximide_2012)


codes_NDCNUM_lacosamide_2012 <- redbook_2012_data %>% 
  filter(
      grepl("lacosamide", GENNME, ignore.case=TRUE) |
      grepl("lacosamide", THRDTDS, ignore.case=TRUE) |
      grepl("lacosamide", PRODNME, ignore.case=TRUE) |
      grepl("vimpat", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lacosamide_2012 <- as.numeric(codes_NDCNUM_lacosamide_2012)


codes_NDCNUM_perampanel_2012 <- redbook_2012_data %>% 
  filter(
      grepl("perampanel", GENNME, ignore.case=TRUE) |
      grepl("perampanel", THRDTDS, ignore.case=TRUE) |
      grepl("perampanel", PRODNME, ignore.case=TRUE) |
      grepl("fycompa", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_perampanel_2012 <- as.numeric(codes_NDCNUM_perampanel_2012)


codes_NDCNUM_stiripentol_2012 <- redbook_2012_data %>% 
  filter(
      grepl("stiripentol", GENNME, ignore.case=TRUE) |
      grepl("stiripentol", THRDTDS, ignore.case=TRUE) |
      grepl("stiripentol", PRODNME, ignore.case=TRUE) |
      grepl("diacomit", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_stiripentol_2012 <- as.numeric(codes_NDCNUM_stiripentol_2012)


codes_NDCNUM_topiramate_2012 <- redbook_2012_data %>% 
  filter(
      grepl("topiramate", GENNME, ignore.case=TRUE) |
      grepl("topiramate", THRDTDS, ignore.case=TRUE) |
      grepl("topiramate", PRODNME, ignore.case=TRUE) |
      grepl("eprontia", PRODNME, ignore.case=TRUE) |
      grepl("topamax", PRODNME, ignore.case=TRUE) |
      grepl("trokendi", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE) &
    !grepl("qudexy", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_topiramate_2012 <- as.numeric(codes_NDCNUM_topiramate_2012)


codes_NDCNUM_vigabatrin_2012 <- redbook_2012_data %>% 
  filter(
      grepl("vigabatrin", GENNME, ignore.case=TRUE) |
      grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |
      grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
      grepl("sabril", PRODNME, ignore.case=TRUE) |
      grepl("vigadrone", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_vigabatrin_2012 <- as.numeric(codes_NDCNUM_vigabatrin_2012)


codes_NDCNUM_zonisamide_2012 <- redbook_2012_data %>% 
  filter(
      grepl("zonisamide", GENNME, ignore.case=TRUE) |
      grepl("zonisamide", THRDTDS, ignore.case=TRUE) |
      grepl("zonisamide", PRODNME, ignore.case=TRUE) |
      grepl("zonegran", PRODNME, ignore.case=TRUE) |
      grepl("zonisade", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_zonisamide_2012 <- as.numeric(codes_NDCNUM_zonisamide_2012)


codes_NDCNUM_felbamate_2012 <- redbook_2012_data %>% 
  filter(
      grepl("felbamate", GENNME, ignore.case=TRUE) |
      grepl("felbamate", THRDTDS, ignore.case=TRUE) |
      grepl("felbamate", PRODNME, ignore.case=TRUE) |
      grepl("felbatol", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_felbamate_2012 <- as.numeric(codes_NDCNUM_felbamate_2012)


codes_NDCNUM_pregabalin_2012 <- redbook_2012_data %>% 
  filter(
      grepl("pregabalin", GENNME, ignore.case=TRUE) |
      grepl("pregabalin", THRDTDS, ignore.case=TRUE) |
      grepl("pregabalin", PRODNME, ignore.case=TRUE) |
      grepl("lyrica", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_pregabalin_2012 <- as.numeric(codes_NDCNUM_pregabalin_2012)


codes_NDCNUM_tiagabine_2012 <- redbook_2012_data %>% 
  filter(
      grepl("tiagabine", GENNME, ignore.case=TRUE) |
      grepl("tiagabine", THRDTDS, ignore.case=TRUE) |
      grepl("tiagabine", PRODNME, ignore.case=TRUE) |
      grepl("gabitril", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_tiagabine_2012 <- as.numeric(codes_NDCNUM_tiagabine_2012)


codes_NDCNUM_cannabidiol_2012 <- redbook_2012_data %>% 
  filter(
      grepl("epidiolex", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cannabidiol_2012 <- as.numeric(codes_NDCNUM_cannabidiol_2012)


codes_NDCNUM_gabapentin_2012 <- redbook_2012_data %>% 
  filter(
      grepl("gabapentin", GENNME, ignore.case=TRUE) |
      grepl("gabapentin", THRDTDS, ignore.case=TRUE) |
      grepl("gabapentin", PRODNME, ignore.case=TRUE) |
      grepl("gralise", PRODNME, ignore.case=TRUE) |
      grepl("neurontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl(";", GENNME, ignore.case=TRUE) &
    !grepl("enacarbil", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_gabapentin_2012 <- as.numeric(codes_NDCNUM_gabapentin_2012)


codes_NDCNUM_fenfluramine_2012 <- redbook_2012_data %>% 
  filter(
      grepl("fenfluramine", GENNME, ignore.case=TRUE) |
      grepl("fenfluramine", THRDTDS, ignore.case=TRUE) |
      grepl("fenfluramine", PRODNME, ignore.case=TRUE) |
      grepl("fintepla", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("dex", GENNME, ignore.case=TRUE) &
    !grepl("dex", THRDTDS, ignore.case=TRUE) &
    !grepl("hydrochloride", GENNME, ignore.case=TRUE) &    
    !grepl("hydrochloride", THRDTDS, ignore.case=TRUE) &
    !grepl("pondimin", PRODNME, ignore.case=TRUE) &
    !grepl("redux", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_fenfluramine_2012 <- as.numeric(codes_NDCNUM_fenfluramine_2012)


codes_NDCNUM_methsuximide_2012 <- redbook_2012_data %>% 
  filter(
      grepl("methsuximide", GENNME, ignore.case=TRUE) |
      grepl("methsuximide", THRDTDS, ignore.case=TRUE) |
      grepl("methsuximide", PRODNME, ignore.case=TRUE) |
      grepl("celontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_methsuximide_2012 <- as.numeric(codes_NDCNUM_methsuximide_2012)


codes_NDCNUM_ASM_2012 <- c(
  codes_NDCNUM_phenobarbital_2012,
  codes_NDCNUM_phenytoin_2012,
  codes_NDCNUM_valproate_2012,
  codes_NDCNUM_carbamazepine_2012,
  codes_NDCNUM_oxcarbazepine_2012,
  codes_NDCNUM_rufinamide_2012,
  codes_NDCNUM_levetiracetam_2012,
  codes_NDCNUM_lamotrigine_2012,
  codes_NDCNUM_brivaracetam_2012,
  codes_NDCNUM_cenobamate_2012,
  codes_NDCNUM_clobazam_2012,
  codes_NDCNUM_eslicarbazepine_2012,
  codes_NDCNUM_ethosuximide_2012,
  codes_NDCNUM_lacosamide_2012,
  codes_NDCNUM_perampanel_2012,
  codes_NDCNUM_stiripentol_2012,
  codes_NDCNUM_topiramate_2012,
  codes_NDCNUM_vigabatrin_2012,
  codes_NDCNUM_zonisamide_2012,
  codes_NDCNUM_felbamate_2012,
  codes_NDCNUM_pregabalin_2012,
  codes_NDCNUM_tiagabine_2012,
  codes_NDCNUM_cannabidiol_2012,
  codes_NDCNUM_gabapentin_2012,
  codes_NDCNUM_fenfluramine_2012,
  codes_NDCNUM_methsuximide_2012
)




############################################2013############################################
codes_NDCNUM_phenobarbital_2013 <- redbook_2013_data %>% 
  filter(
      grepl("phenobarb", GENNME, ignore.case=TRUE) |
      grepl("phenobarb", THRDTDS, ignore.case=TRUE) |
      grepl("phenobarb", PRODNME, ignore.case=TRUE) |
      grepl("luminal", PRODNME, ignore.case=TRUE) |
      grepl("solfoton", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenobarbital_2013 <- as.numeric(codes_NDCNUM_phenobarbital_2013)


codes_NDCNUM_phenytoin_2013 <- redbook_2013_data %>% 
  filter(
      grepl("phenytoin", GENNME, ignore.case=TRUE) |
      grepl("phenytoin", THRDTDS, ignore.case=TRUE) |
      grepl("phenytoin", PRODNME, ignore.case=TRUE) |
      grepl("dilantin", PRODNME, ignore.case=TRUE) |
      grepl("phenytek", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenytoin_2013 <- as.numeric(codes_NDCNUM_phenytoin_2013)


codes_NDCNUM_valproate_2013 <- redbook_2013_data %>% 
  filter(
      grepl("valpro", GENNME, ignore.case=TRUE) |
      grepl("valpro", THRDTDS, ignore.case=TRUE) |
      grepl("valpro", PRODNME, ignore.case=TRUE) |
      grepl("depakene", PRODNME, ignore.case=TRUE) |
      grepl("depakote", PRODNME, ignore.case=TRUE) |
      grepl("depacon", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_valproate_2013 <- as.numeric(codes_NDCNUM_valproate_2013)


codes_NDCNUM_carbamazepine_2013 <- redbook_2013_data %>% 
  filter(
      grepl("carbamazepine", GENNME, ignore.case=TRUE) |
      grepl("carbamazepine", THRDTDS, ignore.case=TRUE) |
      grepl("carbamazepine", PRODNME, ignore.case=TRUE) |
      grepl("tegretol", PRODNME, ignore.case=TRUE) |
      grepl("carbatrol", PRODNME, ignore.case=TRUE) |
      grepl("epitol", PRODNME, ignore.case=TRUE) |
      grepl("equetro", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("atretol", PRODNME, ignore.case=TRUE)
    ) %>%   
  pull(NDCNUM)
codes_NDCNUM_carbamazepine_2013 <- as.numeric(codes_NDCNUM_carbamazepine_2013)


codes_NDCNUM_oxcarbazepine_2013 <- redbook_2013_data %>% 
  filter(
      grepl("oxcarbazepine", GENNME, ignore.case=TRUE) |
      grepl("oxcarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("oxcarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("oxtellar", PRODNME, ignore.case=TRUE) |
      grepl("trileptal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_oxcarbazepine_2013 <- as.numeric(codes_NDCNUM_oxcarbazepine_2013)


codes_NDCNUM_rufinamide_2013 <- redbook_2013_data %>% 
  filter(
      grepl("rufinamide", GENNME, ignore.case=TRUE) |
      grepl("rufinamide", THRDTDS, ignore.case=TRUE) |
      grepl("rufinamide", PRODNME, ignore.case=TRUE) |
      grepl("banzel", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rufinamide_2013 <- as.numeric(codes_NDCNUM_rufinamide_2013)


codes_NDCNUM_levetiracetam_2013 <- redbook_2013_data %>% 
  filter(
      grepl("levetiracetam", GENNME, ignore.case=TRUE) |
      grepl("levetiracetam", THRDTDS, ignore.case=TRUE) |
      grepl("levetiracetam", PRODNME, ignore.case=TRUE) |
      grepl("elepsia", PRODNME, ignore.case=TRUE) |
      grepl("keppra", PRODNME, ignore.case=TRUE) |
      grepl("roweepra", PRODNME, ignore.case=TRUE) |
      grepl("spritam", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_levetiracetam_2013 <- as.numeric(codes_NDCNUM_levetiracetam_2013)


codes_NDCNUM_lamotrigine_2013 <- redbook_2013_data %>% 
  filter(
      grepl("lamotrigine", GENNME, ignore.case=TRUE) |
      grepl("lamotrigine", THRDTDS, ignore.case=TRUE) |
      grepl("lamotrigine", PRODNME, ignore.case=TRUE) |
      grepl("lamictal", PRODNME, ignore.case=TRUE) |
      grepl("subvenite", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lamotrigine_2013 <- as.numeric(codes_NDCNUM_lamotrigine_2013)


codes_NDCNUM_brivaracetam_2013 <- redbook_2013_data %>% 
  filter(
      grepl("brivaracetam", GENNME, ignore.case=TRUE) |
      grepl("brivaracetam", THRDTDS, ignore.case=TRUE) |
      grepl("brivaracetam", PRODNME, ignore.case=TRUE) |
      grepl("briviact", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_brivaracetam_2013 <- as.numeric(codes_NDCNUM_brivaracetam_2013)


codes_NDCNUM_cenobamate_2013 <- redbook_2013_data %>% 
  filter(
      grepl("cenobamate", GENNME, ignore.case=TRUE) |
      grepl("cenobamate", THRDTDS, ignore.case=TRUE) |
      grepl("cenobamate", PRODNME, ignore.case=TRUE) |
      grepl("xcopri", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cenobamate_2013 <- as.numeric(codes_NDCNUM_cenobamate_2013)


codes_NDCNUM_clobazam_2013 <- redbook_2013_data %>% 
  filter(
      grepl("clobazam", GENNME, ignore.case=TRUE) |
      grepl("clobazam", THRDTDS, ignore.case=TRUE) |
      grepl("clobazam", PRODNME, ignore.case=TRUE) |
      grepl("onfi", PRODNME, ignore.case=TRUE) |
      grepl("sympazan", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("HIV", GENNME, ignore.case=TRUE) &
    !grepl("pregnancy", GENNME, ignore.case=TRUE) &
    !grepl("denture", GENNME, ignore.case=TRUE) &
    !grepl("hyoscyamine", GENNME, ignore.case=TRUE) &
    !grepl("glucose", GENNME, ignore.case=TRUE) &
    !grepl("device", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_clobazam_2013 <- as.numeric(codes_NDCNUM_clobazam_2013)


codes_NDCNUM_eslicarbazepine_2013 <- redbook_2013_data %>% 
  filter(
      grepl("eslicarbazepine", GENNME, ignore.case=TRUE) |
      grepl("eslicarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("eslicarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("aptiom", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_eslicarbazepine_2013 <- as.numeric(codes_NDCNUM_eslicarbazepine_2013)


codes_NDCNUM_ethosuximide_2013 <- redbook_2013_data %>% 
  filter(
      grepl("ethosuximide", GENNME, ignore.case=TRUE) |
      grepl("ethosuximide", THRDTDS, ignore.case=TRUE) |
      grepl("ethosuximide", PRODNME, ignore.case=TRUE) |
      grepl("zarontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_ethosuximide_2013 <- as.numeric(codes_NDCNUM_ethosuximide_2013)


codes_NDCNUM_lacosamide_2013 <- redbook_2013_data %>% 
  filter(
      grepl("lacosamide", GENNME, ignore.case=TRUE) |
      grepl("lacosamide", THRDTDS, ignore.case=TRUE) |
      grepl("lacosamide", PRODNME, ignore.case=TRUE) |
      grepl("vimpat", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lacosamide_2013 <- as.numeric(codes_NDCNUM_lacosamide_2013)


codes_NDCNUM_perampanel_2013 <- redbook_2013_data %>% 
  filter(
      grepl("perampanel", GENNME, ignore.case=TRUE) |
      grepl("perampanel", THRDTDS, ignore.case=TRUE) |
      grepl("perampanel", PRODNME, ignore.case=TRUE) |
      grepl("fycompa", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_perampanel_2013 <- as.numeric(codes_NDCNUM_perampanel_2013)


codes_NDCNUM_stiripentol_2013 <- redbook_2013_data %>% 
  filter(
      grepl("stiripentol", GENNME, ignore.case=TRUE) |
      grepl("stiripentol", THRDTDS, ignore.case=TRUE) |
      grepl("stiripentol", PRODNME, ignore.case=TRUE) |
      grepl("diacomit", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_stiripentol_2013 <- as.numeric(codes_NDCNUM_stiripentol_2013)


codes_NDCNUM_topiramate_2013 <- redbook_2013_data %>% 
  filter(
      grepl("topiramate", GENNME, ignore.case=TRUE) |
      grepl("topiramate", THRDTDS, ignore.case=TRUE) |
      grepl("topiramate", PRODNME, ignore.case=TRUE) |
      grepl("eprontia", PRODNME, ignore.case=TRUE) |
      grepl("topamax", PRODNME, ignore.case=TRUE) |
      grepl("trokendi", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE) &
    !grepl("qudexy", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_topiramate_2013 <- as.numeric(codes_NDCNUM_topiramate_2013)


codes_NDCNUM_vigabatrin_2013 <- redbook_2013_data %>% 
  filter(
      grepl("vigabatrin", GENNME, ignore.case=TRUE) |
      grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |
      grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
      grepl("sabril", PRODNME, ignore.case=TRUE) |
      grepl("vigadrone", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_vigabatrin_2013 <- as.numeric(codes_NDCNUM_vigabatrin_2013)


codes_NDCNUM_zonisamide_2013 <- redbook_2013_data %>% 
  filter(
      grepl("zonisamide", GENNME, ignore.case=TRUE) |
      grepl("zonisamide", THRDTDS, ignore.case=TRUE) |
      grepl("zonisamide", PRODNME, ignore.case=TRUE) |
      grepl("zonegran", PRODNME, ignore.case=TRUE) |
      grepl("zonisade", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_zonisamide_2013 <- as.numeric(codes_NDCNUM_zonisamide_2013)


codes_NDCNUM_felbamate_2013 <- redbook_2013_data %>% 
  filter(
      grepl("felbamate", GENNME, ignore.case=TRUE) |
      grepl("felbamate", THRDTDS, ignore.case=TRUE) |
      grepl("felbamate", PRODNME, ignore.case=TRUE) |
      grepl("felbatol", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_felbamate_2013 <- as.numeric(codes_NDCNUM_felbamate_2013)


codes_NDCNUM_pregabalin_2013 <- redbook_2013_data %>% 
  filter(
      grepl("pregabalin", GENNME, ignore.case=TRUE) |
      grepl("pregabalin", THRDTDS, ignore.case=TRUE) |
      grepl("pregabalin", PRODNME, ignore.case=TRUE) |
      grepl("lyrica", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_pregabalin_2013 <- as.numeric(codes_NDCNUM_pregabalin_2013)


codes_NDCNUM_tiagabine_2013 <- redbook_2013_data %>% 
  filter(
      grepl("tiagabine", GENNME, ignore.case=TRUE) |
      grepl("tiagabine", THRDTDS, ignore.case=TRUE) |
      grepl("tiagabine", PRODNME, ignore.case=TRUE) |
      grepl("gabitril", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_tiagabine_2013 <- as.numeric(codes_NDCNUM_tiagabine_2013)


codes_NDCNUM_cannabidiol_2013 <- redbook_2013_data %>% 
  filter(
      grepl("epidiolex", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cannabidiol_2013 <- as.numeric(codes_NDCNUM_cannabidiol_2013)


codes_NDCNUM_gabapentin_2013 <- redbook_2013_data %>% 
  filter(
      grepl("gabapentin", GENNME, ignore.case=TRUE) |
      grepl("gabapentin", THRDTDS, ignore.case=TRUE) |
      grepl("gabapentin", PRODNME, ignore.case=TRUE) |
      grepl("gralise", PRODNME, ignore.case=TRUE) |
      grepl("neurontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl(";", GENNME, ignore.case=TRUE) &
    !grepl("enacarbil", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_gabapentin_2013 <- as.numeric(codes_NDCNUM_gabapentin_2013)


codes_NDCNUM_fenfluramine_2013 <- redbook_2013_data %>% 
  filter(
      grepl("fenfluramine", GENNME, ignore.case=TRUE) |
      grepl("fenfluramine", THRDTDS, ignore.case=TRUE) |
      grepl("fenfluramine", PRODNME, ignore.case=TRUE) |
      grepl("fintepla", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("dex", GENNME, ignore.case=TRUE) &
    !grepl("dex", THRDTDS, ignore.case=TRUE) &
    !grepl("hydrochloride", GENNME, ignore.case=TRUE) &    
    !grepl("hydrochloride", THRDTDS, ignore.case=TRUE) &
    !grepl("pondimin", PRODNME, ignore.case=TRUE) &
    !grepl("redux", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_fenfluramine_2013 <- as.numeric(codes_NDCNUM_fenfluramine_2013)


codes_NDCNUM_methsuximide_2013 <- redbook_2013_data %>% 
  filter(
      grepl("methsuximide", GENNME, ignore.case=TRUE) |
      grepl("methsuximide", THRDTDS, ignore.case=TRUE) |
      grepl("methsuximide", PRODNME, ignore.case=TRUE) |
      grepl("celontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_methsuximide_2013 <- as.numeric(codes_NDCNUM_methsuximide_2013)


codes_NDCNUM_ASM_2013 <- c(
  codes_NDCNUM_phenobarbital_2013,
  codes_NDCNUM_phenytoin_2013,
  codes_NDCNUM_valproate_2013,
  codes_NDCNUM_carbamazepine_2013,
  codes_NDCNUM_oxcarbazepine_2013,
  codes_NDCNUM_rufinamide_2013,
  codes_NDCNUM_levetiracetam_2013,
  codes_NDCNUM_lamotrigine_2013,
  codes_NDCNUM_brivaracetam_2013,
  codes_NDCNUM_cenobamate_2013,
  codes_NDCNUM_clobazam_2013,
  codes_NDCNUM_eslicarbazepine_2013,
  codes_NDCNUM_ethosuximide_2013,
  codes_NDCNUM_lacosamide_2013,
  codes_NDCNUM_perampanel_2013,
  codes_NDCNUM_stiripentol_2013,
  codes_NDCNUM_topiramate_2013,
  codes_NDCNUM_vigabatrin_2013,
  codes_NDCNUM_zonisamide_2013,
  codes_NDCNUM_felbamate_2013,
  codes_NDCNUM_pregabalin_2013,
  codes_NDCNUM_tiagabine_2013,
  codes_NDCNUM_cannabidiol_2013,
  codes_NDCNUM_gabapentin_2013,
  codes_NDCNUM_fenfluramine_2013,
  codes_NDCNUM_methsuximide_2013
)




############################################2014############################################
codes_NDCNUM_phenobarbital_2014 <- redbook_2014_data %>% 
  filter(
      grepl("phenobarb", GENNME, ignore.case=TRUE) |
      grepl("phenobarb", THRDTDS, ignore.case=TRUE) |
      grepl("phenobarb", PRODNME, ignore.case=TRUE) |
      grepl("luminal", PRODNME, ignore.case=TRUE) |
      grepl("solfoton", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenobarbital_2014 <- as.numeric(codes_NDCNUM_phenobarbital_2014)


codes_NDCNUM_phenytoin_2014 <- redbook_2014_data %>% 
  filter(
      grepl("phenytoin", GENNME, ignore.case=TRUE) |
      grepl("phenytoin", THRDTDS, ignore.case=TRUE) |
      grepl("phenytoin", PRODNME, ignore.case=TRUE) |
      grepl("dilantin", PRODNME, ignore.case=TRUE) |
      grepl("phenytek", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenytoin_2014 <- as.numeric(codes_NDCNUM_phenytoin_2014)


codes_NDCNUM_valproate_2014 <- redbook_2014_data %>% 
  filter(
      grepl("valpro", GENNME, ignore.case=TRUE) |
      grepl("valpro", THRDTDS, ignore.case=TRUE) |
      grepl("valpro", PRODNME, ignore.case=TRUE) |
      grepl("depakene", PRODNME, ignore.case=TRUE) |
      grepl("depakote", PRODNME, ignore.case=TRUE) |
      grepl("depacon", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_valproate_2014 <- as.numeric(codes_NDCNUM_valproate_2014)


codes_NDCNUM_carbamazepine_2014 <- redbook_2014_data %>% 
  filter(
      grepl("carbamazepine", GENNME, ignore.case=TRUE) |
      grepl("carbamazepine", THRDTDS, ignore.case=TRUE) |
      grepl("carbamazepine", PRODNME, ignore.case=TRUE) |
      grepl("tegretol", PRODNME, ignore.case=TRUE) |
      grepl("carbatrol", PRODNME, ignore.case=TRUE) |
      grepl("epitol", PRODNME, ignore.case=TRUE) |
      grepl("equetro", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("atretol", PRODNME, ignore.case=TRUE)
    ) %>%   
  pull(NDCNUM)
codes_NDCNUM_carbamazepine_2014 <- as.numeric(codes_NDCNUM_carbamazepine_2014)


codes_NDCNUM_oxcarbazepine_2014 <- redbook_2014_data %>% 
  filter(
      grepl("oxcarbazepine", GENNME, ignore.case=TRUE) |
      grepl("oxcarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("oxcarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("oxtellar", PRODNME, ignore.case=TRUE) |
      grepl("trileptal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_oxcarbazepine_2014 <- as.numeric(codes_NDCNUM_oxcarbazepine_2014)


codes_NDCNUM_rufinamide_2014 <- redbook_2014_data %>% 
  filter(
      grepl("rufinamide", GENNME, ignore.case=TRUE) |
      grepl("rufinamide", THRDTDS, ignore.case=TRUE) |
      grepl("rufinamide", PRODNME, ignore.case=TRUE) |
      grepl("banzel", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rufinamide_2014 <- as.numeric(codes_NDCNUM_rufinamide_2014)


codes_NDCNUM_levetiracetam_2014 <- redbook_2014_data %>% 
  filter(
      grepl("levetiracetam", GENNME, ignore.case=TRUE) |
      grepl("levetiracetam", THRDTDS, ignore.case=TRUE) |
      grepl("levetiracetam", PRODNME, ignore.case=TRUE) |
      grepl("elepsia", PRODNME, ignore.case=TRUE) |
      grepl("keppra", PRODNME, ignore.case=TRUE) |
      grepl("roweepra", PRODNME, ignore.case=TRUE) |
      grepl("spritam", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_levetiracetam_2014 <- as.numeric(codes_NDCNUM_levetiracetam_2014)


codes_NDCNUM_lamotrigine_2014 <- redbook_2014_data %>% 
  filter(
      grepl("lamotrigine", GENNME, ignore.case=TRUE) |
      grepl("lamotrigine", THRDTDS, ignore.case=TRUE) |
      grepl("lamotrigine", PRODNME, ignore.case=TRUE) |
      grepl("lamictal", PRODNME, ignore.case=TRUE) |
      grepl("subvenite", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lamotrigine_2014 <- as.numeric(codes_NDCNUM_lamotrigine_2014)


codes_NDCNUM_brivaracetam_2014 <- redbook_2014_data %>% 
  filter(
      grepl("brivaracetam", GENNME, ignore.case=TRUE) |
      grepl("brivaracetam", THRDTDS, ignore.case=TRUE) |
      grepl("brivaracetam", PRODNME, ignore.case=TRUE) |
      grepl("briviact", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_brivaracetam_2014 <- as.numeric(codes_NDCNUM_brivaracetam_2014)


codes_NDCNUM_cenobamate_2014 <- redbook_2014_data %>% 
  filter(
      grepl("cenobamate", GENNME, ignore.case=TRUE) |
      grepl("cenobamate", THRDTDS, ignore.case=TRUE) |
      grepl("cenobamate", PRODNME, ignore.case=TRUE) |
      grepl("xcopri", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cenobamate_2014 <- as.numeric(codes_NDCNUM_cenobamate_2014)


codes_NDCNUM_clobazam_2014 <- redbook_2014_data %>% 
  filter(
      grepl("clobazam", GENNME, ignore.case=TRUE) |
      grepl("clobazam", THRDTDS, ignore.case=TRUE) |
      grepl("clobazam", PRODNME, ignore.case=TRUE) |
      grepl("onfi", PRODNME, ignore.case=TRUE) |
      grepl("sympazan", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("HIV", GENNME, ignore.case=TRUE) &
    !grepl("pregnancy", GENNME, ignore.case=TRUE) &
    !grepl("denture", GENNME, ignore.case=TRUE) &
    !grepl("hyoscyamine", GENNME, ignore.case=TRUE) &
    !grepl("glucose", GENNME, ignore.case=TRUE) &
    !grepl("device", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_clobazam_2014 <- as.numeric(codes_NDCNUM_clobazam_2014)


codes_NDCNUM_eslicarbazepine_2014 <- redbook_2014_data %>% 
  filter(
      grepl("eslicarbazepine", GENNME, ignore.case=TRUE) |
      grepl("eslicarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("eslicarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("aptiom", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_eslicarbazepine_2014 <- as.numeric(codes_NDCNUM_eslicarbazepine_2014)


codes_NDCNUM_ethosuximide_2014 <- redbook_2014_data %>% 
  filter(
      grepl("ethosuximide", GENNME, ignore.case=TRUE) |
      grepl("ethosuximide", THRDTDS, ignore.case=TRUE) |
      grepl("ethosuximide", PRODNME, ignore.case=TRUE) |
      grepl("zarontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_ethosuximide_2014 <- as.numeric(codes_NDCNUM_ethosuximide_2014)


codes_NDCNUM_lacosamide_2014 <- redbook_2014_data %>% 
  filter(
      grepl("lacosamide", GENNME, ignore.case=TRUE) |
      grepl("lacosamide", THRDTDS, ignore.case=TRUE) |
      grepl("lacosamide", PRODNME, ignore.case=TRUE) |
      grepl("vimpat", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lacosamide_2014 <- as.numeric(codes_NDCNUM_lacosamide_2014)


codes_NDCNUM_perampanel_2014 <- redbook_2014_data %>% 
  filter(
      grepl("perampanel", GENNME, ignore.case=TRUE) |
      grepl("perampanel", THRDTDS, ignore.case=TRUE) |
      grepl("perampanel", PRODNME, ignore.case=TRUE) |
      grepl("fycompa", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_perampanel_2014 <- as.numeric(codes_NDCNUM_perampanel_2014)


codes_NDCNUM_stiripentol_2014 <- redbook_2014_data %>% 
  filter(
      grepl("stiripentol", GENNME, ignore.case=TRUE) |
      grepl("stiripentol", THRDTDS, ignore.case=TRUE) |
      grepl("stiripentol", PRODNME, ignore.case=TRUE) |
      grepl("diacomit", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_stiripentol_2014 <- as.numeric(codes_NDCNUM_stiripentol_2014)


codes_NDCNUM_topiramate_2014 <- redbook_2014_data %>% 
  filter(
      grepl("topiramate", GENNME, ignore.case=TRUE) |
      grepl("topiramate", THRDTDS, ignore.case=TRUE) |
      grepl("topiramate", PRODNME, ignore.case=TRUE) |
      grepl("eprontia", PRODNME, ignore.case=TRUE) |
      grepl("topamax", PRODNME, ignore.case=TRUE) |
      grepl("trokendi", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE) &
    !grepl("qudexy", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_topiramate_2014 <- as.numeric(codes_NDCNUM_topiramate_2014)


codes_NDCNUM_vigabatrin_2014 <- redbook_2014_data %>% 
  filter(
      grepl("vigabatrin", GENNME, ignore.case=TRUE) |
      grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |
      grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
      grepl("sabril", PRODNME, ignore.case=TRUE) |
      grepl("vigadrone", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_vigabatrin_2014 <- as.numeric(codes_NDCNUM_vigabatrin_2014)


codes_NDCNUM_zonisamide_2014 <- redbook_2014_data %>% 
  filter(
      grepl("zonisamide", GENNME, ignore.case=TRUE) |
      grepl("zonisamide", THRDTDS, ignore.case=TRUE) |
      grepl("zonisamide", PRODNME, ignore.case=TRUE) |
      grepl("zonegran", PRODNME, ignore.case=TRUE) |
      grepl("zonisade", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_zonisamide_2014 <- as.numeric(codes_NDCNUM_zonisamide_2014)


codes_NDCNUM_felbamate_2014 <- redbook_2014_data %>% 
  filter(
      grepl("felbamate", GENNME, ignore.case=TRUE) |
      grepl("felbamate", THRDTDS, ignore.case=TRUE) |
      grepl("felbamate", PRODNME, ignore.case=TRUE) |
      grepl("felbatol", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_felbamate_2014 <- as.numeric(codes_NDCNUM_felbamate_2014)


codes_NDCNUM_pregabalin_2014 <- redbook_2014_data %>% 
  filter(
      grepl("pregabalin", GENNME, ignore.case=TRUE) |
      grepl("pregabalin", THRDTDS, ignore.case=TRUE) |
      grepl("pregabalin", PRODNME, ignore.case=TRUE) |
      grepl("lyrica", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_pregabalin_2014 <- as.numeric(codes_NDCNUM_pregabalin_2014)


codes_NDCNUM_tiagabine_2014 <- redbook_2014_data %>% 
  filter(
      grepl("tiagabine", GENNME, ignore.case=TRUE) |
      grepl("tiagabine", THRDTDS, ignore.case=TRUE) |
      grepl("tiagabine", PRODNME, ignore.case=TRUE) |
      grepl("gabitril", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_tiagabine_2014 <- as.numeric(codes_NDCNUM_tiagabine_2014)


codes_NDCNUM_cannabidiol_2014 <- redbook_2014_data %>% 
  filter(
      grepl("epidiolex", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cannabidiol_2014 <- as.numeric(codes_NDCNUM_cannabidiol_2014)


codes_NDCNUM_gabapentin_2014 <- redbook_2014_data %>% 
  filter(
      grepl("gabapentin", GENNME, ignore.case=TRUE) |
      grepl("gabapentin", THRDTDS, ignore.case=TRUE) |
      grepl("gabapentin", PRODNME, ignore.case=TRUE) |
      grepl("gralise", PRODNME, ignore.case=TRUE) |
      grepl("neurontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl(";", GENNME, ignore.case=TRUE) &
    !grepl("enacarbil", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_gabapentin_2014 <- as.numeric(codes_NDCNUM_gabapentin_2014)


codes_NDCNUM_fenfluramine_2014 <- redbook_2014_data %>% 
  filter(
      grepl("fenfluramine", GENNME, ignore.case=TRUE) |
      grepl("fenfluramine", THRDTDS, ignore.case=TRUE) |
      grepl("fenfluramine", PRODNME, ignore.case=TRUE) |
      grepl("fintepla", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("dex", GENNME, ignore.case=TRUE) &
    !grepl("dex", THRDTDS, ignore.case=TRUE) &
    !grepl("hydrochloride", GENNME, ignore.case=TRUE) &    
    !grepl("hydrochloride", THRDTDS, ignore.case=TRUE) &
    !grepl("pondimin", PRODNME, ignore.case=TRUE) &
    !grepl("redux", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_fenfluramine_2014 <- as.numeric(codes_NDCNUM_fenfluramine_2014)


codes_NDCNUM_methsuximide_2014 <- redbook_2014_data %>% 
  filter(
      grepl("methsuximide", GENNME, ignore.case=TRUE) |
      grepl("methsuximide", THRDTDS, ignore.case=TRUE) |
      grepl("methsuximide", PRODNME, ignore.case=TRUE) |
      grepl("celontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_methsuximide_2014 <- as.numeric(codes_NDCNUM_methsuximide_2014)


codes_NDCNUM_ASM_2014 <- c(
  codes_NDCNUM_phenobarbital_2014,
  codes_NDCNUM_phenytoin_2014,
  codes_NDCNUM_valproate_2014,
  codes_NDCNUM_carbamazepine_2014,
  codes_NDCNUM_oxcarbazepine_2014,
  codes_NDCNUM_rufinamide_2014,
  codes_NDCNUM_levetiracetam_2014,
  codes_NDCNUM_lamotrigine_2014,
  codes_NDCNUM_brivaracetam_2014,
  codes_NDCNUM_cenobamate_2014,
  codes_NDCNUM_clobazam_2014,
  codes_NDCNUM_eslicarbazepine_2014,
  codes_NDCNUM_ethosuximide_2014,
  codes_NDCNUM_lacosamide_2014,
  codes_NDCNUM_perampanel_2014,
  codes_NDCNUM_stiripentol_2014,
  codes_NDCNUM_topiramate_2014,
  codes_NDCNUM_vigabatrin_2014,
  codes_NDCNUM_zonisamide_2014,
  codes_NDCNUM_felbamate_2014,
  codes_NDCNUM_pregabalin_2014,
  codes_NDCNUM_tiagabine_2014,
  codes_NDCNUM_cannabidiol_2014,
  codes_NDCNUM_gabapentin_2014,
  codes_NDCNUM_fenfluramine_2014,
  codes_NDCNUM_methsuximide_2014
)




############################################2015############################################
codes_NDCNUM_phenobarbital_2015 <- redbook_2015_data %>% 
  filter(
      grepl("phenobarb", GENNME, ignore.case=TRUE) |
      grepl("phenobarb", THRDTDS, ignore.case=TRUE) |
      grepl("phenobarb", PRODNME, ignore.case=TRUE) |
      grepl("luminal", PRODNME, ignore.case=TRUE) |
      grepl("solfoton", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenobarbital_2015 <- as.numeric(codes_NDCNUM_phenobarbital_2015)


codes_NDCNUM_phenytoin_2015 <- redbook_2015_data %>% 
  filter(
      grepl("phenytoin", GENNME, ignore.case=TRUE) |
      grepl("phenytoin", THRDTDS, ignore.case=TRUE) |
      grepl("phenytoin", PRODNME, ignore.case=TRUE) |
      grepl("dilantin", PRODNME, ignore.case=TRUE) |
      grepl("phenytek", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenytoin_2015 <- as.numeric(codes_NDCNUM_phenytoin_2015)


codes_NDCNUM_valproate_2015 <- redbook_2015_data %>% 
  filter(
      grepl("valpro", GENNME, ignore.case=TRUE) |
      grepl("valpro", THRDTDS, ignore.case=TRUE) |
      grepl("valpro", PRODNME, ignore.case=TRUE) |
      grepl("depakene", PRODNME, ignore.case=TRUE) |
      grepl("depakote", PRODNME, ignore.case=TRUE) |
      grepl("depacon", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_valproate_2015 <- as.numeric(codes_NDCNUM_valproate_2015)


codes_NDCNUM_carbamazepine_2015 <- redbook_2015_data %>% 
  filter(
      grepl("carbamazepine", GENNME, ignore.case=TRUE) |
      grepl("carbamazepine", THRDTDS, ignore.case=TRUE) |
      grepl("carbamazepine", PRODNME, ignore.case=TRUE) |
      grepl("tegretol", PRODNME, ignore.case=TRUE) |
      grepl("carbatrol", PRODNME, ignore.case=TRUE) |
      grepl("epitol", PRODNME, ignore.case=TRUE) |
      grepl("equetro", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("atretol", PRODNME, ignore.case=TRUE)
    ) %>%   
  pull(NDCNUM)
codes_NDCNUM_carbamazepine_2015 <- as.numeric(codes_NDCNUM_carbamazepine_2015)


codes_NDCNUM_oxcarbazepine_2015 <- redbook_2015_data %>% 
  filter(
      grepl("oxcarbazepine", GENNME, ignore.case=TRUE) |
      grepl("oxcarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("oxcarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("oxtellar", PRODNME, ignore.case=TRUE) |
      grepl("trileptal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_oxcarbazepine_2015 <- as.numeric(codes_NDCNUM_oxcarbazepine_2015)


codes_NDCNUM_rufinamide_2015 <- redbook_2015_data %>% 
  filter(
      grepl("rufinamide", GENNME, ignore.case=TRUE) |
      grepl("rufinamide", THRDTDS, ignore.case=TRUE) |
      grepl("rufinamide", PRODNME, ignore.case=TRUE) |
      grepl("banzel", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rufinamide_2015 <- as.numeric(codes_NDCNUM_rufinamide_2015)


codes_NDCNUM_levetiracetam_2015 <- redbook_2015_data %>% 
  filter(
      grepl("levetiracetam", GENNME, ignore.case=TRUE) |
      grepl("levetiracetam", THRDTDS, ignore.case=TRUE) |
      grepl("levetiracetam", PRODNME, ignore.case=TRUE) |
      grepl("elepsia", PRODNME, ignore.case=TRUE) |
      grepl("keppra", PRODNME, ignore.case=TRUE) |
      grepl("roweepra", PRODNME, ignore.case=TRUE) |
      grepl("spritam", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_levetiracetam_2015 <- as.numeric(codes_NDCNUM_levetiracetam_2015)


codes_NDCNUM_lamotrigine_2015 <- redbook_2015_data %>% 
  filter(
      grepl("lamotrigine", GENNME, ignore.case=TRUE) |
      grepl("lamotrigine", THRDTDS, ignore.case=TRUE) |
      grepl("lamotrigine", PRODNME, ignore.case=TRUE) |
      grepl("lamictal", PRODNME, ignore.case=TRUE) |
      grepl("subvenite", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lamotrigine_2015 <- as.numeric(codes_NDCNUM_lamotrigine_2015)


codes_NDCNUM_brivaracetam_2015 <- redbook_2015_data %>% 
  filter(
      grepl("brivaracetam", GENNME, ignore.case=TRUE) |
      grepl("brivaracetam", THRDTDS, ignore.case=TRUE) |
      grepl("brivaracetam", PRODNME, ignore.case=TRUE) |
      grepl("briviact", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_brivaracetam_2015 <- as.numeric(codes_NDCNUM_brivaracetam_2015)


codes_NDCNUM_cenobamate_2015 <- redbook_2015_data %>% 
  filter(
      grepl("cenobamate", GENNME, ignore.case=TRUE) |
      grepl("cenobamate", THRDTDS, ignore.case=TRUE) |
      grepl("cenobamate", PRODNME, ignore.case=TRUE) |
      grepl("xcopri", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cenobamate_2015 <- as.numeric(codes_NDCNUM_cenobamate_2015)


codes_NDCNUM_clobazam_2015 <- redbook_2015_data %>% 
  filter(
      grepl("clobazam", GENNME, ignore.case=TRUE) |
      grepl("clobazam", THRDTDS, ignore.case=TRUE) |
      grepl("clobazam", PRODNME, ignore.case=TRUE) |
      grepl("onfi", PRODNME, ignore.case=TRUE) |
      grepl("sympazan", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("HIV", GENNME, ignore.case=TRUE) &
    !grepl("pregnancy", GENNME, ignore.case=TRUE) &
    !grepl("denture", GENNME, ignore.case=TRUE) &
    !grepl("hyoscyamine", GENNME, ignore.case=TRUE) &
    !grepl("glucose", GENNME, ignore.case=TRUE) &
    !grepl("device", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_clobazam_2015 <- as.numeric(codes_NDCNUM_clobazam_2015)


codes_NDCNUM_eslicarbazepine_2015 <- redbook_2015_data %>% 
  filter(
      grepl("eslicarbazepine", GENNME, ignore.case=TRUE) |
      grepl("eslicarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("eslicarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("aptiom", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_eslicarbazepine_2015 <- as.numeric(codes_NDCNUM_eslicarbazepine_2015)


codes_NDCNUM_ethosuximide_2015 <- redbook_2015_data %>% 
  filter(
      grepl("ethosuximide", GENNME, ignore.case=TRUE) |
      grepl("ethosuximide", THRDTDS, ignore.case=TRUE) |
      grepl("ethosuximide", PRODNME, ignore.case=TRUE) |
      grepl("zarontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_ethosuximide_2015 <- as.numeric(codes_NDCNUM_ethosuximide_2015)


codes_NDCNUM_lacosamide_2015 <- redbook_2015_data %>% 
  filter(
      grepl("lacosamide", GENNME, ignore.case=TRUE) |
      grepl("lacosamide", THRDTDS, ignore.case=TRUE) |
      grepl("lacosamide", PRODNME, ignore.case=TRUE) |
      grepl("vimpat", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lacosamide_2015 <- as.numeric(codes_NDCNUM_lacosamide_2015)


codes_NDCNUM_perampanel_2015 <- redbook_2015_data %>% 
  filter(
      grepl("perampanel", GENNME, ignore.case=TRUE) |
      grepl("perampanel", THRDTDS, ignore.case=TRUE) |
      grepl("perampanel", PRODNME, ignore.case=TRUE) |
      grepl("fycompa", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_perampanel_2015 <- as.numeric(codes_NDCNUM_perampanel_2015)


codes_NDCNUM_stiripentol_2015 <- redbook_2015_data %>% 
  filter(
      grepl("stiripentol", GENNME, ignore.case=TRUE) |
      grepl("stiripentol", THRDTDS, ignore.case=TRUE) |
      grepl("stiripentol", PRODNME, ignore.case=TRUE) |
      grepl("diacomit", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_stiripentol_2015 <- as.numeric(codes_NDCNUM_stiripentol_2015)


codes_NDCNUM_topiramate_2015 <- redbook_2015_data %>% 
  filter(
      grepl("topiramate", GENNME, ignore.case=TRUE) |
      grepl("topiramate", THRDTDS, ignore.case=TRUE) |
      grepl("topiramate", PRODNME, ignore.case=TRUE) |
      grepl("eprontia", PRODNME, ignore.case=TRUE) |
      grepl("topamax", PRODNME, ignore.case=TRUE) |
      grepl("trokendi", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE) &
    !grepl("qudexy", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_topiramate_2015 <- as.numeric(codes_NDCNUM_topiramate_2015)


codes_NDCNUM_vigabatrin_2015 <- redbook_2015_data %>% 
  filter(
      grepl("vigabatrin", GENNME, ignore.case=TRUE) |
      grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |
      grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
      grepl("sabril", PRODNME, ignore.case=TRUE) |
      grepl("vigadrone", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_vigabatrin_2015 <- as.numeric(codes_NDCNUM_vigabatrin_2015)


codes_NDCNUM_zonisamide_2015 <- redbook_2015_data %>% 
  filter(
      grepl("zonisamide", GENNME, ignore.case=TRUE) |
      grepl("zonisamide", THRDTDS, ignore.case=TRUE) |
      grepl("zonisamide", PRODNME, ignore.case=TRUE) |
      grepl("zonegran", PRODNME, ignore.case=TRUE) |
      grepl("zonisade", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_zonisamide_2015 <- as.numeric(codes_NDCNUM_zonisamide_2015)


codes_NDCNUM_felbamate_2015 <- redbook_2015_data %>% 
  filter(
      grepl("felbamate", GENNME, ignore.case=TRUE) |
      grepl("felbamate", THRDTDS, ignore.case=TRUE) |
      grepl("felbamate", PRODNME, ignore.case=TRUE) |
      grepl("felbatol", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_felbamate_2015 <- as.numeric(codes_NDCNUM_felbamate_2015)


codes_NDCNUM_pregabalin_2015 <- redbook_2015_data %>% 
  filter(
      grepl("pregabalin", GENNME, ignore.case=TRUE) |
      grepl("pregabalin", THRDTDS, ignore.case=TRUE) |
      grepl("pregabalin", PRODNME, ignore.case=TRUE) |
      grepl("lyrica", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_pregabalin_2015 <- as.numeric(codes_NDCNUM_pregabalin_2015)


codes_NDCNUM_tiagabine_2015 <- redbook_2015_data %>% 
  filter(
      grepl("tiagabine", GENNME, ignore.case=TRUE) |
      grepl("tiagabine", THRDTDS, ignore.case=TRUE) |
      grepl("tiagabine", PRODNME, ignore.case=TRUE) |
      grepl("gabitril", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_tiagabine_2015 <- as.numeric(codes_NDCNUM_tiagabine_2015)


codes_NDCNUM_cannabidiol_2015 <- redbook_2015_data %>% 
  filter(
      grepl("epidiolex", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cannabidiol_2015 <- as.numeric(codes_NDCNUM_cannabidiol_2015)


codes_NDCNUM_gabapentin_2015 <- redbook_2015_data %>% 
  filter(
      grepl("gabapentin", GENNME, ignore.case=TRUE) |
      grepl("gabapentin", THRDTDS, ignore.case=TRUE) |
      grepl("gabapentin", PRODNME, ignore.case=TRUE) |
      grepl("gralise", PRODNME, ignore.case=TRUE) |
      grepl("neurontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl(";", GENNME, ignore.case=TRUE) &
    !grepl("enacarbil", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_gabapentin_2015 <- as.numeric(codes_NDCNUM_gabapentin_2015)


codes_NDCNUM_fenfluramine_2015 <- redbook_2015_data %>% 
  filter(
      grepl("fenfluramine", GENNME, ignore.case=TRUE) |
      grepl("fenfluramine", THRDTDS, ignore.case=TRUE) |
      grepl("fenfluramine", PRODNME, ignore.case=TRUE) |
      grepl("fintepla", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("dex", GENNME, ignore.case=TRUE) &
    !grepl("dex", THRDTDS, ignore.case=TRUE) &
    !grepl("hydrochloride", GENNME, ignore.case=TRUE) &    
    !grepl("hydrochloride", THRDTDS, ignore.case=TRUE) &
    !grepl("pondimin", PRODNME, ignore.case=TRUE) &
    !grepl("redux", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_fenfluramine_2015 <- as.numeric(codes_NDCNUM_fenfluramine_2015)


codes_NDCNUM_methsuximide_2015 <- redbook_2015_data %>% 
  filter(
      grepl("methsuximide", GENNME, ignore.case=TRUE) |
      grepl("methsuximide", THRDTDS, ignore.case=TRUE) |
      grepl("methsuximide", PRODNME, ignore.case=TRUE) |
      grepl("celontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_methsuximide_2015 <- as.numeric(codes_NDCNUM_methsuximide_2015)


codes_NDCNUM_ASM_2015 <- c(
  codes_NDCNUM_phenobarbital_2015,
  codes_NDCNUM_phenytoin_2015,
  codes_NDCNUM_valproate_2015,
  codes_NDCNUM_carbamazepine_2015,
  codes_NDCNUM_oxcarbazepine_2015,
  codes_NDCNUM_rufinamide_2015,
  codes_NDCNUM_levetiracetam_2015,
  codes_NDCNUM_lamotrigine_2015,
  codes_NDCNUM_brivaracetam_2015,
  codes_NDCNUM_cenobamate_2015,
  codes_NDCNUM_clobazam_2015,
  codes_NDCNUM_eslicarbazepine_2015,
  codes_NDCNUM_ethosuximide_2015,
  codes_NDCNUM_lacosamide_2015,
  codes_NDCNUM_perampanel_2015,
  codes_NDCNUM_stiripentol_2015,
  codes_NDCNUM_topiramate_2015,
  codes_NDCNUM_vigabatrin_2015,
  codes_NDCNUM_zonisamide_2015,
  codes_NDCNUM_felbamate_2015,
  codes_NDCNUM_pregabalin_2015,
  codes_NDCNUM_tiagabine_2015,
  codes_NDCNUM_cannabidiol_2015,
  codes_NDCNUM_gabapentin_2015,
  codes_NDCNUM_fenfluramine_2015,
  codes_NDCNUM_methsuximide_2015
)




############################################2016############################################
codes_NDCNUM_phenobarbital_2016 <- redbook_2016_data %>% 
  filter(
      grepl("phenobarb", GENNME, ignore.case=TRUE) |
      grepl("phenobarb", THRDTDS, ignore.case=TRUE) |
      grepl("phenobarb", PRODNME, ignore.case=TRUE) |
      grepl("luminal", PRODNME, ignore.case=TRUE) |
      grepl("solfoton", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenobarbital_2016 <- as.numeric(codes_NDCNUM_phenobarbital_2016)


codes_NDCNUM_phenytoin_2016 <- redbook_2016_data %>% 
  filter(
      grepl("phenytoin", GENNME, ignore.case=TRUE) |
      grepl("phenytoin", THRDTDS, ignore.case=TRUE) |
      grepl("phenytoin", PRODNME, ignore.case=TRUE) |
      grepl("dilantin", PRODNME, ignore.case=TRUE) |
      grepl("phenytek", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenytoin_2016 <- as.numeric(codes_NDCNUM_phenytoin_2016)


codes_NDCNUM_valproate_2016 <- redbook_2016_data %>% 
  filter(
      grepl("valpro", GENNME, ignore.case=TRUE) |
      grepl("valpro", THRDTDS, ignore.case=TRUE) |
      grepl("valpro", PRODNME, ignore.case=TRUE) |
      grepl("depakene", PRODNME, ignore.case=TRUE) |
      grepl("depakote", PRODNME, ignore.case=TRUE) |
      grepl("depacon", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_valproate_2016 <- as.numeric(codes_NDCNUM_valproate_2016)


codes_NDCNUM_carbamazepine_2016 <- redbook_2016_data %>% 
  filter(
      grepl("carbamazepine", GENNME, ignore.case=TRUE) |
      grepl("carbamazepine", THRDTDS, ignore.case=TRUE) |
      grepl("carbamazepine", PRODNME, ignore.case=TRUE) |
      grepl("tegretol", PRODNME, ignore.case=TRUE) |
      grepl("carbatrol", PRODNME, ignore.case=TRUE) |
      grepl("epitol", PRODNME, ignore.case=TRUE) |
      grepl("equetro", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("atretol", PRODNME, ignore.case=TRUE)
    ) %>%   
  pull(NDCNUM)
codes_NDCNUM_carbamazepine_2016 <- as.numeric(codes_NDCNUM_carbamazepine_2016)


codes_NDCNUM_oxcarbazepine_2016 <- redbook_2016_data %>% 
  filter(
      grepl("oxcarbazepine", GENNME, ignore.case=TRUE) |
      grepl("oxcarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("oxcarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("oxtellar", PRODNME, ignore.case=TRUE) |
      grepl("trileptal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_oxcarbazepine_2016 <- as.numeric(codes_NDCNUM_oxcarbazepine_2016)


codes_NDCNUM_rufinamide_2016 <- redbook_2016_data %>% 
  filter(
      grepl("rufinamide", GENNME, ignore.case=TRUE) |
      grepl("rufinamide", THRDTDS, ignore.case=TRUE) |
      grepl("rufinamide", PRODNME, ignore.case=TRUE) |
      grepl("banzel", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rufinamide_2016 <- as.numeric(codes_NDCNUM_rufinamide_2016)


codes_NDCNUM_levetiracetam_2016 <- redbook_2016_data %>% 
  filter(
      grepl("levetiracetam", GENNME, ignore.case=TRUE) |
      grepl("levetiracetam", THRDTDS, ignore.case=TRUE) |
      grepl("levetiracetam", PRODNME, ignore.case=TRUE) |
      grepl("elepsia", PRODNME, ignore.case=TRUE) |
      grepl("keppra", PRODNME, ignore.case=TRUE) |
      grepl("roweepra", PRODNME, ignore.case=TRUE) |
      grepl("spritam", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_levetiracetam_2016 <- as.numeric(codes_NDCNUM_levetiracetam_2016)


codes_NDCNUM_lamotrigine_2016 <- redbook_2016_data %>% 
  filter(
      grepl("lamotrigine", GENNME, ignore.case=TRUE) |
      grepl("lamotrigine", THRDTDS, ignore.case=TRUE) |
      grepl("lamotrigine", PRODNME, ignore.case=TRUE) |
      grepl("lamictal", PRODNME, ignore.case=TRUE) |
      grepl("subvenite", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lamotrigine_2016 <- as.numeric(codes_NDCNUM_lamotrigine_2016)


codes_NDCNUM_brivaracetam_2016 <- redbook_2016_data %>% 
  filter(
      grepl("brivaracetam", GENNME, ignore.case=TRUE) |
      grepl("brivaracetam", THRDTDS, ignore.case=TRUE) |
      grepl("brivaracetam", PRODNME, ignore.case=TRUE) |
      grepl("briviact", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_brivaracetam_2016 <- as.numeric(codes_NDCNUM_brivaracetam_2016)


codes_NDCNUM_cenobamate_2016 <- redbook_2016_data %>% 
  filter(
      grepl("cenobamate", GENNME, ignore.case=TRUE) |
      grepl("cenobamate", THRDTDS, ignore.case=TRUE) |
      grepl("cenobamate", PRODNME, ignore.case=TRUE) |
      grepl("xcopri", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cenobamate_2016 <- as.numeric(codes_NDCNUM_cenobamate_2016)


codes_NDCNUM_clobazam_2016 <- redbook_2016_data %>% 
  filter(
      grepl("clobazam", GENNME, ignore.case=TRUE) |
      grepl("clobazam", THRDTDS, ignore.case=TRUE) |
      grepl("clobazam", PRODNME, ignore.case=TRUE) |
      grepl("onfi", PRODNME, ignore.case=TRUE) |
      grepl("sympazan", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("HIV", GENNME, ignore.case=TRUE) &
    !grepl("pregnancy", GENNME, ignore.case=TRUE) &
    !grepl("denture", GENNME, ignore.case=TRUE) &
    !grepl("hyoscyamine", GENNME, ignore.case=TRUE) &
    !grepl("glucose", GENNME, ignore.case=TRUE) &
    !grepl("device", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_clobazam_2016 <- as.numeric(codes_NDCNUM_clobazam_2016)


codes_NDCNUM_eslicarbazepine_2016 <- redbook_2016_data %>% 
  filter(
      grepl("eslicarbazepine", GENNME, ignore.case=TRUE) |
      grepl("eslicarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("eslicarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("aptiom", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_eslicarbazepine_2016 <- as.numeric(codes_NDCNUM_eslicarbazepine_2016)


codes_NDCNUM_ethosuximide_2016 <- redbook_2016_data %>% 
  filter(
      grepl("ethosuximide", GENNME, ignore.case=TRUE) |
      grepl("ethosuximide", THRDTDS, ignore.case=TRUE) |
      grepl("ethosuximide", PRODNME, ignore.case=TRUE) |
      grepl("zarontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_ethosuximide_2016 <- as.numeric(codes_NDCNUM_ethosuximide_2016)


codes_NDCNUM_lacosamide_2016 <- redbook_2016_data %>% 
  filter(
      grepl("lacosamide", GENNME, ignore.case=TRUE) |
      grepl("lacosamide", THRDTDS, ignore.case=TRUE) |
      grepl("lacosamide", PRODNME, ignore.case=TRUE) |
      grepl("vimpat", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lacosamide_2016 <- as.numeric(codes_NDCNUM_lacosamide_2016)


codes_NDCNUM_perampanel_2016 <- redbook_2016_data %>% 
  filter(
      grepl("perampanel", GENNME, ignore.case=TRUE) |
      grepl("perampanel", THRDTDS, ignore.case=TRUE) |
      grepl("perampanel", PRODNME, ignore.case=TRUE) |
      grepl("fycompa", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_perampanel_2016 <- as.numeric(codes_NDCNUM_perampanel_2016)


codes_NDCNUM_stiripentol_2016 <- redbook_2016_data %>% 
  filter(
      grepl("stiripentol", GENNME, ignore.case=TRUE) |
      grepl("stiripentol", THRDTDS, ignore.case=TRUE) |
      grepl("stiripentol", PRODNME, ignore.case=TRUE) |
      grepl("diacomit", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_stiripentol_2016 <- as.numeric(codes_NDCNUM_stiripentol_2016)


codes_NDCNUM_topiramate_2016 <- redbook_2016_data %>% 
  filter(
      grepl("topiramate", GENNME, ignore.case=TRUE) |
      grepl("topiramate", THRDTDS, ignore.case=TRUE) |
      grepl("topiramate", PRODNME, ignore.case=TRUE) |
      grepl("eprontia", PRODNME, ignore.case=TRUE) |
      grepl("topamax", PRODNME, ignore.case=TRUE) |
      grepl("trokendi", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE) &
    !grepl("qudexy", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_topiramate_2016 <- as.numeric(codes_NDCNUM_topiramate_2016)


codes_NDCNUM_vigabatrin_2016 <- redbook_2016_data %>% 
  filter(
      grepl("vigabatrin", GENNME, ignore.case=TRUE) |
      grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |
      grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
      grepl("sabril", PRODNME, ignore.case=TRUE) |
      grepl("vigadrone", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_vigabatrin_2016 <- as.numeric(codes_NDCNUM_vigabatrin_2016)


codes_NDCNUM_zonisamide_2016 <- redbook_2016_data %>% 
  filter(
      grepl("zonisamide", GENNME, ignore.case=TRUE) |
      grepl("zonisamide", THRDTDS, ignore.case=TRUE) |
      grepl("zonisamide", PRODNME, ignore.case=TRUE) |
      grepl("zonegran", PRODNME, ignore.case=TRUE) |
      grepl("zonisade", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_zonisamide_2016 <- as.numeric(codes_NDCNUM_zonisamide_2016)


codes_NDCNUM_felbamate_2016 <- redbook_2016_data %>% 
  filter(
      grepl("felbamate", GENNME, ignore.case=TRUE) |
      grepl("felbamate", THRDTDS, ignore.case=TRUE) |
      grepl("felbamate", PRODNME, ignore.case=TRUE) |
      grepl("felbatol", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_felbamate_2016 <- as.numeric(codes_NDCNUM_felbamate_2016)


codes_NDCNUM_pregabalin_2016 <- redbook_2016_data %>% 
  filter(
      grepl("pregabalin", GENNME, ignore.case=TRUE) |
      grepl("pregabalin", THRDTDS, ignore.case=TRUE) |
      grepl("pregabalin", PRODNME, ignore.case=TRUE) |
      grepl("lyrica", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_pregabalin_2016 <- as.numeric(codes_NDCNUM_pregabalin_2016)


codes_NDCNUM_tiagabine_2016 <- redbook_2016_data %>% 
  filter(
      grepl("tiagabine", GENNME, ignore.case=TRUE) |
      grepl("tiagabine", THRDTDS, ignore.case=TRUE) |
      grepl("tiagabine", PRODNME, ignore.case=TRUE) |
      grepl("gabitril", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_tiagabine_2016 <- as.numeric(codes_NDCNUM_tiagabine_2016)


codes_NDCNUM_cannabidiol_2016 <- redbook_2016_data %>% 
  filter(
      grepl("epidiolex", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cannabidiol_2016 <- as.numeric(codes_NDCNUM_cannabidiol_2016)


codes_NDCNUM_gabapentin_2016 <- redbook_2016_data %>% 
  filter(
      grepl("gabapentin", GENNME, ignore.case=TRUE) |
      grepl("gabapentin", THRDTDS, ignore.case=TRUE) |
      grepl("gabapentin", PRODNME, ignore.case=TRUE) |
      grepl("gralise", PRODNME, ignore.case=TRUE) |
      grepl("neurontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl(";", GENNME, ignore.case=TRUE) &
    !grepl("enacarbil", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_gabapentin_2016 <- as.numeric(codes_NDCNUM_gabapentin_2016)


codes_NDCNUM_fenfluramine_2016 <- redbook_2016_data %>% 
  filter(
      grepl("fenfluramine", GENNME, ignore.case=TRUE) |
      grepl("fenfluramine", THRDTDS, ignore.case=TRUE) |
      grepl("fenfluramine", PRODNME, ignore.case=TRUE) |
      grepl("fintepla", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("dex", GENNME, ignore.case=TRUE) &
    !grepl("dex", THRDTDS, ignore.case=TRUE) &
    !grepl("hydrochloride", GENNME, ignore.case=TRUE) &    
    !grepl("hydrochloride", THRDTDS, ignore.case=TRUE) &
    !grepl("pondimin", PRODNME, ignore.case=TRUE) &
    !grepl("redux", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_fenfluramine_2016 <- as.numeric(codes_NDCNUM_fenfluramine_2016)


codes_NDCNUM_methsuximide_2016 <- redbook_2016_data %>% 
  filter(
      grepl("methsuximide", GENNME, ignore.case=TRUE) |
      grepl("methsuximide", THRDTDS, ignore.case=TRUE) |
      grepl("methsuximide", PRODNME, ignore.case=TRUE) |
      grepl("celontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_methsuximide_2016 <- as.numeric(codes_NDCNUM_methsuximide_2016)


codes_NDCNUM_ASM_2016 <- c(
  codes_NDCNUM_phenobarbital_2016,
  codes_NDCNUM_phenytoin_2016,
  codes_NDCNUM_valproate_2016,
  codes_NDCNUM_carbamazepine_2016,
  codes_NDCNUM_oxcarbazepine_2016,
  codes_NDCNUM_rufinamide_2016,
  codes_NDCNUM_levetiracetam_2016,
  codes_NDCNUM_lamotrigine_2016,
  codes_NDCNUM_brivaracetam_2016,
  codes_NDCNUM_cenobamate_2016,
  codes_NDCNUM_clobazam_2016,
  codes_NDCNUM_eslicarbazepine_2016,
  codes_NDCNUM_ethosuximide_2016,
  codes_NDCNUM_lacosamide_2016,
  codes_NDCNUM_perampanel_2016,
  codes_NDCNUM_stiripentol_2016,
  codes_NDCNUM_topiramate_2016,
  codes_NDCNUM_vigabatrin_2016,
  codes_NDCNUM_zonisamide_2016,
  codes_NDCNUM_felbamate_2016,
  codes_NDCNUM_pregabalin_2016,
  codes_NDCNUM_tiagabine_2016,
  codes_NDCNUM_cannabidiol_2016,
  codes_NDCNUM_gabapentin_2016,
  codes_NDCNUM_fenfluramine_2016,
  codes_NDCNUM_methsuximide_2016
)




############################################2017############################################
codes_NDCNUM_phenobarbital_2017 <- redbook_2017_data %>% 
  filter(
      grepl("phenobarb", GENNME, ignore.case=TRUE) |
      grepl("phenobarb", THRDTDS, ignore.case=TRUE) |
      grepl("phenobarb", PRODNME, ignore.case=TRUE) |
      grepl("luminal", PRODNME, ignore.case=TRUE) |
      grepl("solfoton", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenobarbital_2017 <- as.numeric(codes_NDCNUM_phenobarbital_2017)


codes_NDCNUM_phenytoin_2017 <- redbook_2017_data %>% 
  filter(
      grepl("phenytoin", GENNME, ignore.case=TRUE) |
      grepl("phenytoin", THRDTDS, ignore.case=TRUE) |
      grepl("phenytoin", PRODNME, ignore.case=TRUE) |
      grepl("dilantin", PRODNME, ignore.case=TRUE) |
      grepl("phenytek", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenytoin_2017 <- as.numeric(codes_NDCNUM_phenytoin_2017)


codes_NDCNUM_valproate_2017 <- redbook_2017_data %>% 
  filter(
      grepl("valpro", GENNME, ignore.case=TRUE) |
      grepl("valpro", THRDTDS, ignore.case=TRUE) |
      grepl("valpro", PRODNME, ignore.case=TRUE) |
      grepl("depakene", PRODNME, ignore.case=TRUE) |
      grepl("depakote", PRODNME, ignore.case=TRUE) |
      grepl("depacon", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_valproate_2017 <- as.numeric(codes_NDCNUM_valproate_2017)


codes_NDCNUM_carbamazepine_2017 <- redbook_2017_data %>% 
  filter(
      grepl("carbamazepine", GENNME, ignore.case=TRUE) |
      grepl("carbamazepine", THRDTDS, ignore.case=TRUE) |
      grepl("carbamazepine", PRODNME, ignore.case=TRUE) |
      grepl("tegretol", PRODNME, ignore.case=TRUE) |
      grepl("carbatrol", PRODNME, ignore.case=TRUE) |
      grepl("epitol", PRODNME, ignore.case=TRUE) |
      grepl("equetro", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("atretol", PRODNME, ignore.case=TRUE)
    ) %>%   
  pull(NDCNUM)
codes_NDCNUM_carbamazepine_2017 <- as.numeric(codes_NDCNUM_carbamazepine_2017)


codes_NDCNUM_oxcarbazepine_2017 <- redbook_2017_data %>% 
  filter(
      grepl("oxcarbazepine", GENNME, ignore.case=TRUE) |
      grepl("oxcarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("oxcarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("oxtellar", PRODNME, ignore.case=TRUE) |
      grepl("trileptal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_oxcarbazepine_2017 <- as.numeric(codes_NDCNUM_oxcarbazepine_2017)


codes_NDCNUM_rufinamide_2017 <- redbook_2017_data %>% 
  filter(
      grepl("rufinamide", GENNME, ignore.case=TRUE) |
      grepl("rufinamide", THRDTDS, ignore.case=TRUE) |
      grepl("rufinamide", PRODNME, ignore.case=TRUE) |
      grepl("banzel", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rufinamide_2017 <- as.numeric(codes_NDCNUM_rufinamide_2017)


codes_NDCNUM_levetiracetam_2017 <- redbook_2017_data %>% 
  filter(
      grepl("levetiracetam", GENNME, ignore.case=TRUE) |
      grepl("levetiracetam", THRDTDS, ignore.case=TRUE) |
      grepl("levetiracetam", PRODNME, ignore.case=TRUE) |
      grepl("elepsia", PRODNME, ignore.case=TRUE) |
      grepl("keppra", PRODNME, ignore.case=TRUE) |
      grepl("roweepra", PRODNME, ignore.case=TRUE) |
      grepl("spritam", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_levetiracetam_2017 <- as.numeric(codes_NDCNUM_levetiracetam_2017)


codes_NDCNUM_lamotrigine_2017 <- redbook_2017_data %>% 
  filter(
      grepl("lamotrigine", GENNME, ignore.case=TRUE) |
      grepl("lamotrigine", THRDTDS, ignore.case=TRUE) |
      grepl("lamotrigine", PRODNME, ignore.case=TRUE) |
      grepl("lamictal", PRODNME, ignore.case=TRUE) |
      grepl("subvenite", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lamotrigine_2017 <- as.numeric(codes_NDCNUM_lamotrigine_2017)


codes_NDCNUM_brivaracetam_2017 <- redbook_2017_data %>% 
  filter(
      grepl("brivaracetam", GENNME, ignore.case=TRUE) |
      grepl("brivaracetam", THRDTDS, ignore.case=TRUE) |
      grepl("brivaracetam", PRODNME, ignore.case=TRUE) |
      grepl("briviact", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_brivaracetam_2017 <- as.numeric(codes_NDCNUM_brivaracetam_2017)


codes_NDCNUM_cenobamate_2017 <- redbook_2017_data %>% 
  filter(
      grepl("cenobamate", GENNME, ignore.case=TRUE) |
      grepl("cenobamate", THRDTDS, ignore.case=TRUE) |
      grepl("cenobamate", PRODNME, ignore.case=TRUE) |
      grepl("xcopri", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cenobamate_2017 <- as.numeric(codes_NDCNUM_cenobamate_2017)


codes_NDCNUM_clobazam_2017 <- redbook_2017_data %>% 
  filter(
      grepl("clobazam", GENNME, ignore.case=TRUE) |
      grepl("clobazam", THRDTDS, ignore.case=TRUE) |
      grepl("clobazam", PRODNME, ignore.case=TRUE) |
      grepl("onfi", PRODNME, ignore.case=TRUE) |
      grepl("sympazan", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("HIV", GENNME, ignore.case=TRUE) &
    !grepl("pregnancy", GENNME, ignore.case=TRUE) &
    !grepl("denture", GENNME, ignore.case=TRUE) &
    !grepl("hyoscyamine", GENNME, ignore.case=TRUE) &
    !grepl("glucose", GENNME, ignore.case=TRUE) &
    !grepl("device", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_clobazam_2017 <- as.numeric(codes_NDCNUM_clobazam_2017)


codes_NDCNUM_eslicarbazepine_2017 <- redbook_2017_data %>% 
  filter(
      grepl("eslicarbazepine", GENNME, ignore.case=TRUE) |
      grepl("eslicarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("eslicarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("aptiom", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_eslicarbazepine_2017 <- as.numeric(codes_NDCNUM_eslicarbazepine_2017)


codes_NDCNUM_ethosuximide_2017 <- redbook_2017_data %>% 
  filter(
      grepl("ethosuximide", GENNME, ignore.case=TRUE) |
      grepl("ethosuximide", THRDTDS, ignore.case=TRUE) |
      grepl("ethosuximide", PRODNME, ignore.case=TRUE) |
      grepl("zarontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_ethosuximide_2017 <- as.numeric(codes_NDCNUM_ethosuximide_2017)


codes_NDCNUM_lacosamide_2017 <- redbook_2017_data %>% 
  filter(
      grepl("lacosamide", GENNME, ignore.case=TRUE) |
      grepl("lacosamide", THRDTDS, ignore.case=TRUE) |
      grepl("lacosamide", PRODNME, ignore.case=TRUE) |
      grepl("vimpat", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lacosamide_2017 <- as.numeric(codes_NDCNUM_lacosamide_2017)


codes_NDCNUM_perampanel_2017 <- redbook_2017_data %>% 
  filter(
      grepl("perampanel", GENNME, ignore.case=TRUE) |
      grepl("perampanel", THRDTDS, ignore.case=TRUE) |
      grepl("perampanel", PRODNME, ignore.case=TRUE) |
      grepl("fycompa", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_perampanel_2017 <- as.numeric(codes_NDCNUM_perampanel_2017)


codes_NDCNUM_stiripentol_2017 <- redbook_2017_data %>% 
  filter(
      grepl("stiripentol", GENNME, ignore.case=TRUE) |
      grepl("stiripentol", THRDTDS, ignore.case=TRUE) |
      grepl("stiripentol", PRODNME, ignore.case=TRUE) |
      grepl("diacomit", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_stiripentol_2017 <- as.numeric(codes_NDCNUM_stiripentol_2017)


codes_NDCNUM_topiramate_2017 <- redbook_2017_data %>% 
  filter(
      grepl("topiramate", GENNME, ignore.case=TRUE) |
      grepl("topiramate", THRDTDS, ignore.case=TRUE) |
      grepl("topiramate", PRODNME, ignore.case=TRUE) |
      grepl("eprontia", PRODNME, ignore.case=TRUE) |
      grepl("topamax", PRODNME, ignore.case=TRUE) |
      grepl("trokendi", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE) &
    !grepl("qudexy", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_topiramate_2017 <- as.numeric(codes_NDCNUM_topiramate_2017)


codes_NDCNUM_vigabatrin_2017 <- redbook_2017_data %>% 
  filter(
      grepl("vigabatrin", GENNME, ignore.case=TRUE) |
      grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |
      grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
      grepl("sabril", PRODNME, ignore.case=TRUE) |
      grepl("vigadrone", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_vigabatrin_2017 <- as.numeric(codes_NDCNUM_vigabatrin_2017)


codes_NDCNUM_zonisamide_2017 <- redbook_2017_data %>% 
  filter(
      grepl("zonisamide", GENNME, ignore.case=TRUE) |
      grepl("zonisamide", THRDTDS, ignore.case=TRUE) |
      grepl("zonisamide", PRODNME, ignore.case=TRUE) |
      grepl("zonegran", PRODNME, ignore.case=TRUE) |
      grepl("zonisade", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_zonisamide_2017 <- as.numeric(codes_NDCNUM_zonisamide_2017)


codes_NDCNUM_felbamate_2017 <- redbook_2017_data %>% 
  filter(
      grepl("felbamate", GENNME, ignore.case=TRUE) |
      grepl("felbamate", THRDTDS, ignore.case=TRUE) |
      grepl("felbamate", PRODNME, ignore.case=TRUE) |
      grepl("felbatol", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_felbamate_2017 <- as.numeric(codes_NDCNUM_felbamate_2017)


codes_NDCNUM_pregabalin_2017 <- redbook_2017_data %>% 
  filter(
      grepl("pregabalin", GENNME, ignore.case=TRUE) |
      grepl("pregabalin", THRDTDS, ignore.case=TRUE) |
      grepl("pregabalin", PRODNME, ignore.case=TRUE) |
      grepl("lyrica", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_pregabalin_2017 <- as.numeric(codes_NDCNUM_pregabalin_2017)


codes_NDCNUM_tiagabine_2017 <- redbook_2017_data %>% 
  filter(
      grepl("tiagabine", GENNME, ignore.case=TRUE) |
      grepl("tiagabine", THRDTDS, ignore.case=TRUE) |
      grepl("tiagabine", PRODNME, ignore.case=TRUE) |
      grepl("gabitril", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_tiagabine_2017 <- as.numeric(codes_NDCNUM_tiagabine_2017)


codes_NDCNUM_cannabidiol_2017 <- redbook_2017_data %>% 
  filter(
      grepl("epidiolex", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cannabidiol_2017 <- as.numeric(codes_NDCNUM_cannabidiol_2017)


codes_NDCNUM_gabapentin_2017 <- redbook_2017_data %>% 
  filter(
      grepl("gabapentin", GENNME, ignore.case=TRUE) |
      grepl("gabapentin", THRDTDS, ignore.case=TRUE) |
      grepl("gabapentin", PRODNME, ignore.case=TRUE) |
      grepl("gralise", PRODNME, ignore.case=TRUE) |
      grepl("neurontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl(";", GENNME, ignore.case=TRUE) &
    !grepl("enacarbil", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_gabapentin_2017 <- as.numeric(codes_NDCNUM_gabapentin_2017)


codes_NDCNUM_fenfluramine_2017 <- redbook_2017_data %>% 
  filter(
      grepl("fenfluramine", GENNME, ignore.case=TRUE) |
      grepl("fenfluramine", THRDTDS, ignore.case=TRUE) |
      grepl("fenfluramine", PRODNME, ignore.case=TRUE) |
      grepl("fintepla", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("dex", GENNME, ignore.case=TRUE) &
    !grepl("dex", THRDTDS, ignore.case=TRUE) &
    !grepl("hydrochloride", GENNME, ignore.case=TRUE) &    
    !grepl("hydrochloride", THRDTDS, ignore.case=TRUE) &
    !grepl("pondimin", PRODNME, ignore.case=TRUE) &
    !grepl("redux", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_fenfluramine_2017 <- as.numeric(codes_NDCNUM_fenfluramine_2017)


codes_NDCNUM_methsuximide_2017 <- redbook_2017_data %>% 
  filter(
      grepl("methsuximide", GENNME, ignore.case=TRUE) |
      grepl("methsuximide", THRDTDS, ignore.case=TRUE) |
      grepl("methsuximide", PRODNME, ignore.case=TRUE) |
      grepl("celontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_methsuximide_2017 <- as.numeric(codes_NDCNUM_methsuximide_2017)


codes_NDCNUM_ASM_2017 <- c(
  codes_NDCNUM_phenobarbital_2017,
  codes_NDCNUM_phenytoin_2017,
  codes_NDCNUM_valproate_2017,
  codes_NDCNUM_carbamazepine_2017,
  codes_NDCNUM_oxcarbazepine_2017,
  codes_NDCNUM_rufinamide_2017,
  codes_NDCNUM_levetiracetam_2017,
  codes_NDCNUM_lamotrigine_2017,
  codes_NDCNUM_brivaracetam_2017,
  codes_NDCNUM_cenobamate_2017,
  codes_NDCNUM_clobazam_2017,
  codes_NDCNUM_eslicarbazepine_2017,
  codes_NDCNUM_ethosuximide_2017,
  codes_NDCNUM_lacosamide_2017,
  codes_NDCNUM_perampanel_2017,
  codes_NDCNUM_stiripentol_2017,
  codes_NDCNUM_topiramate_2017,
  codes_NDCNUM_vigabatrin_2017,
  codes_NDCNUM_zonisamide_2017,
  codes_NDCNUM_felbamate_2017,
  codes_NDCNUM_pregabalin_2017,
  codes_NDCNUM_tiagabine_2017,
  codes_NDCNUM_cannabidiol_2017,
  codes_NDCNUM_gabapentin_2017,
  codes_NDCNUM_fenfluramine_2017,
  codes_NDCNUM_methsuximide_2017
)




############################################2018############################################
codes_NDCNUM_phenobarbital_2018 <- redbook_2018_data %>% 
  filter(
      grepl("phenobarb", GENNME, ignore.case=TRUE) |
      grepl("phenobarb", THRDTDS, ignore.case=TRUE) |
      grepl("phenobarb", PRODNME, ignore.case=TRUE) |
      grepl("luminal", PRODNME, ignore.case=TRUE) |
      grepl("solfoton", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenobarbital_2018 <- as.numeric(codes_NDCNUM_phenobarbital_2018)


codes_NDCNUM_phenytoin_2018 <- redbook_2018_data %>% 
  filter(
      grepl("phenytoin", GENNME, ignore.case=TRUE) |
      grepl("phenytoin", THRDTDS, ignore.case=TRUE) |
      grepl("phenytoin", PRODNME, ignore.case=TRUE) |
      grepl("dilantin", PRODNME, ignore.case=TRUE) |
      grepl("phenytek", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenytoin_2018 <- as.numeric(codes_NDCNUM_phenytoin_2018)


codes_NDCNUM_valproate_2018 <- redbook_2018_data %>% 
  filter(
      grepl("valpro", GENNME, ignore.case=TRUE) |
      grepl("valpro", THRDTDS, ignore.case=TRUE) |
      grepl("valpro", PRODNME, ignore.case=TRUE) |
      grepl("depakene", PRODNME, ignore.case=TRUE) |
      grepl("depakote", PRODNME, ignore.case=TRUE) |
      grepl("depacon", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_valproate_2018 <- as.numeric(codes_NDCNUM_valproate_2018)


codes_NDCNUM_carbamazepine_2018 <- redbook_2018_data %>% 
  filter(
      grepl("carbamazepine", GENNME, ignore.case=TRUE) |
      grepl("carbamazepine", THRDTDS, ignore.case=TRUE) |
      grepl("carbamazepine", PRODNME, ignore.case=TRUE) |
      grepl("tegretol", PRODNME, ignore.case=TRUE) |
      grepl("carbatrol", PRODNME, ignore.case=TRUE) |
      grepl("epitol", PRODNME, ignore.case=TRUE) |
      grepl("equetro", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("atretol", PRODNME, ignore.case=TRUE)
    ) %>%   
  pull(NDCNUM)
codes_NDCNUM_carbamazepine_2018 <- as.numeric(codes_NDCNUM_carbamazepine_2018)


codes_NDCNUM_oxcarbazepine_2018 <- redbook_2018_data %>% 
  filter(
      grepl("oxcarbazepine", GENNME, ignore.case=TRUE) |
      grepl("oxcarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("oxcarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("oxtellar", PRODNME, ignore.case=TRUE) |
      grepl("trileptal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_oxcarbazepine_2018 <- as.numeric(codes_NDCNUM_oxcarbazepine_2018)


codes_NDCNUM_rufinamide_2018 <- redbook_2018_data %>% 
  filter(
      grepl("rufinamide", GENNME, ignore.case=TRUE) |
      grepl("rufinamide", THRDTDS, ignore.case=TRUE) |
      grepl("rufinamide", PRODNME, ignore.case=TRUE) |
      grepl("banzel", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rufinamide_2018 <- as.numeric(codes_NDCNUM_rufinamide_2018)


codes_NDCNUM_levetiracetam_2018 <- redbook_2018_data %>% 
  filter(
      grepl("levetiracetam", GENNME, ignore.case=TRUE) |
      grepl("levetiracetam", THRDTDS, ignore.case=TRUE) |
      grepl("levetiracetam", PRODNME, ignore.case=TRUE) |
      grepl("elepsia", PRODNME, ignore.case=TRUE) |
      grepl("keppra", PRODNME, ignore.case=TRUE) |
      grepl("roweepra", PRODNME, ignore.case=TRUE) |
      grepl("spritam", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_levetiracetam_2018 <- as.numeric(codes_NDCNUM_levetiracetam_2018)


codes_NDCNUM_lamotrigine_2018 <- redbook_2018_data %>% 
  filter(
      grepl("lamotrigine", GENNME, ignore.case=TRUE) |
      grepl("lamotrigine", THRDTDS, ignore.case=TRUE) |
      grepl("lamotrigine", PRODNME, ignore.case=TRUE) |
      grepl("lamictal", PRODNME, ignore.case=TRUE) |
      grepl("subvenite", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lamotrigine_2018 <- as.numeric(codes_NDCNUM_lamotrigine_2018)


codes_NDCNUM_brivaracetam_2018 <- redbook_2018_data %>% 
  filter(
      grepl("brivaracetam", GENNME, ignore.case=TRUE) |
      grepl("brivaracetam", THRDTDS, ignore.case=TRUE) |
      grepl("brivaracetam", PRODNME, ignore.case=TRUE) |
      grepl("briviact", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_brivaracetam_2018 <- as.numeric(codes_NDCNUM_brivaracetam_2018)


codes_NDCNUM_cenobamate_2018 <- redbook_2018_data %>% 
  filter(
      grepl("cenobamate", GENNME, ignore.case=TRUE) |
      grepl("cenobamate", THRDTDS, ignore.case=TRUE) |
      grepl("cenobamate", PRODNME, ignore.case=TRUE) |
      grepl("xcopri", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cenobamate_2018 <- as.numeric(codes_NDCNUM_cenobamate_2018)


codes_NDCNUM_clobazam_2018 <- redbook_2018_data %>% 
  filter(
      grepl("clobazam", GENNME, ignore.case=TRUE) |
      grepl("clobazam", THRDTDS, ignore.case=TRUE) |
      grepl("clobazam", PRODNME, ignore.case=TRUE) |
      grepl("onfi", PRODNME, ignore.case=TRUE) |
      grepl("sympazan", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("HIV", GENNME, ignore.case=TRUE) &
    !grepl("pregnancy", GENNME, ignore.case=TRUE) &
    !grepl("denture", GENNME, ignore.case=TRUE) &
    !grepl("hyoscyamine", GENNME, ignore.case=TRUE) &
    !grepl("glucose", GENNME, ignore.case=TRUE) &
    !grepl("device", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_clobazam_2018 <- as.numeric(codes_NDCNUM_clobazam_2018)


codes_NDCNUM_eslicarbazepine_2018 <- redbook_2018_data %>% 
  filter(
      grepl("eslicarbazepine", GENNME, ignore.case=TRUE) |
      grepl("eslicarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("eslicarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("aptiom", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_eslicarbazepine_2018 <- as.numeric(codes_NDCNUM_eslicarbazepine_2018)


codes_NDCNUM_ethosuximide_2018 <- redbook_2018_data %>% 
  filter(
      grepl("ethosuximide", GENNME, ignore.case=TRUE) |
      grepl("ethosuximide", THRDTDS, ignore.case=TRUE) |
      grepl("ethosuximide", PRODNME, ignore.case=TRUE) |
      grepl("zarontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_ethosuximide_2018 <- as.numeric(codes_NDCNUM_ethosuximide_2018)


codes_NDCNUM_lacosamide_2018 <- redbook_2018_data %>% 
  filter(
      grepl("lacosamide", GENNME, ignore.case=TRUE) |
      grepl("lacosamide", THRDTDS, ignore.case=TRUE) |
      grepl("lacosamide", PRODNME, ignore.case=TRUE) |
      grepl("vimpat", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lacosamide_2018 <- as.numeric(codes_NDCNUM_lacosamide_2018)


codes_NDCNUM_perampanel_2018 <- redbook_2018_data %>% 
  filter(
      grepl("perampanel", GENNME, ignore.case=TRUE) |
      grepl("perampanel", THRDTDS, ignore.case=TRUE) |
      grepl("perampanel", PRODNME, ignore.case=TRUE) |
      grepl("fycompa", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_perampanel_2018 <- as.numeric(codes_NDCNUM_perampanel_2018)


codes_NDCNUM_stiripentol_2018 <- redbook_2018_data %>% 
  filter(
      grepl("stiripentol", GENNME, ignore.case=TRUE) |
      grepl("stiripentol", THRDTDS, ignore.case=TRUE) |
      grepl("stiripentol", PRODNME, ignore.case=TRUE) |
      grepl("diacomit", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_stiripentol_2018 <- as.numeric(codes_NDCNUM_stiripentol_2018)


codes_NDCNUM_topiramate_2018 <- redbook_2018_data %>% 
  filter(
      grepl("topiramate", GENNME, ignore.case=TRUE) |
      grepl("topiramate", THRDTDS, ignore.case=TRUE) |
      grepl("topiramate", PRODNME, ignore.case=TRUE) |
      grepl("eprontia", PRODNME, ignore.case=TRUE) |
      grepl("topamax", PRODNME, ignore.case=TRUE) |
      grepl("trokendi", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE) &
    !grepl("qudexy", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_topiramate_2018 <- as.numeric(codes_NDCNUM_topiramate_2018)


codes_NDCNUM_vigabatrin_2018 <- redbook_2018_data %>% 
  filter(
      grepl("vigabatrin", GENNME, ignore.case=TRUE) |
      grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |
      grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
      grepl("sabril", PRODNME, ignore.case=TRUE) |
      grepl("vigadrone", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_vigabatrin_2018 <- as.numeric(codes_NDCNUM_vigabatrin_2018)


codes_NDCNUM_zonisamide_2018 <- redbook_2018_data %>% 
  filter(
      grepl("zonisamide", GENNME, ignore.case=TRUE) |
      grepl("zonisamide", THRDTDS, ignore.case=TRUE) |
      grepl("zonisamide", PRODNME, ignore.case=TRUE) |
      grepl("zonegran", PRODNME, ignore.case=TRUE) |
      grepl("zonisade", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_zonisamide_2018 <- as.numeric(codes_NDCNUM_zonisamide_2018)


codes_NDCNUM_felbamate_2018 <- redbook_2018_data %>% 
  filter(
      grepl("felbamate", GENNME, ignore.case=TRUE) |
      grepl("felbamate", THRDTDS, ignore.case=TRUE) |
      grepl("felbamate", PRODNME, ignore.case=TRUE) |
      grepl("felbatol", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_felbamate_2018 <- as.numeric(codes_NDCNUM_felbamate_2018)


codes_NDCNUM_pregabalin_2018 <- redbook_2018_data %>% 
  filter(
      grepl("pregabalin", GENNME, ignore.case=TRUE) |
      grepl("pregabalin", THRDTDS, ignore.case=TRUE) |
      grepl("pregabalin", PRODNME, ignore.case=TRUE) |
      grepl("lyrica", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_pregabalin_2018 <- as.numeric(codes_NDCNUM_pregabalin_2018)


codes_NDCNUM_tiagabine_2018 <- redbook_2018_data %>% 
  filter(
      grepl("tiagabine", GENNME, ignore.case=TRUE) |
      grepl("tiagabine", THRDTDS, ignore.case=TRUE) |
      grepl("tiagabine", PRODNME, ignore.case=TRUE) |
      grepl("gabitril", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_tiagabine_2018 <- as.numeric(codes_NDCNUM_tiagabine_2018)


codes_NDCNUM_cannabidiol_2018 <- redbook_2018_data %>% 
  filter(
      grepl("epidiolex", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cannabidiol_2018 <- as.numeric(codes_NDCNUM_cannabidiol_2018)


codes_NDCNUM_gabapentin_2018 <- redbook_2018_data %>% 
  filter(
      grepl("gabapentin", GENNME, ignore.case=TRUE) |
      grepl("gabapentin", THRDTDS, ignore.case=TRUE) |
      grepl("gabapentin", PRODNME, ignore.case=TRUE) |
      grepl("gralise", PRODNME, ignore.case=TRUE) |
      grepl("neurontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl(";", GENNME, ignore.case=TRUE) &
    !grepl("enacarbil", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_gabapentin_2018 <- as.numeric(codes_NDCNUM_gabapentin_2018)


codes_NDCNUM_fenfluramine_2018 <- redbook_2018_data %>% 
  filter(
      grepl("fenfluramine", GENNME, ignore.case=TRUE) |
      grepl("fenfluramine", THRDTDS, ignore.case=TRUE) |
      grepl("fenfluramine", PRODNME, ignore.case=TRUE) |
      grepl("fintepla", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("dex", GENNME, ignore.case=TRUE) &
    !grepl("dex", THRDTDS, ignore.case=TRUE) &
    !grepl("hydrochloride", GENNME, ignore.case=TRUE) &    
    !grepl("hydrochloride", THRDTDS, ignore.case=TRUE) &
    !grepl("pondimin", PRODNME, ignore.case=TRUE) &
    !grepl("redux", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_fenfluramine_2018 <- as.numeric(codes_NDCNUM_fenfluramine_2018)


codes_NDCNUM_methsuximide_2018 <- redbook_2018_data %>% 
  filter(
      grepl("methsuximide", GENNME, ignore.case=TRUE) |
      grepl("methsuximide", THRDTDS, ignore.case=TRUE) |
      grepl("methsuximide", PRODNME, ignore.case=TRUE) |
      grepl("celontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_methsuximide_2018 <- as.numeric(codes_NDCNUM_methsuximide_2018)


codes_NDCNUM_ASM_2018 <- c(
  codes_NDCNUM_phenobarbital_2018,
  codes_NDCNUM_phenytoin_2018,
  codes_NDCNUM_valproate_2018,
  codes_NDCNUM_carbamazepine_2018,
  codes_NDCNUM_oxcarbazepine_2018,
  codes_NDCNUM_rufinamide_2018,
  codes_NDCNUM_levetiracetam_2018,
  codes_NDCNUM_lamotrigine_2018,
  codes_NDCNUM_brivaracetam_2018,
  codes_NDCNUM_cenobamate_2018,
  codes_NDCNUM_clobazam_2018,
  codes_NDCNUM_eslicarbazepine_2018,
  codes_NDCNUM_ethosuximide_2018,
  codes_NDCNUM_lacosamide_2018,
  codes_NDCNUM_perampanel_2018,
  codes_NDCNUM_stiripentol_2018,
  codes_NDCNUM_topiramate_2018,
  codes_NDCNUM_vigabatrin_2018,
  codes_NDCNUM_zonisamide_2018,
  codes_NDCNUM_felbamate_2018,
  codes_NDCNUM_pregabalin_2018,
  codes_NDCNUM_tiagabine_2018,
  codes_NDCNUM_cannabidiol_2018,
  codes_NDCNUM_gabapentin_2018,
  codes_NDCNUM_fenfluramine_2018,
  codes_NDCNUM_methsuximide_2018
)




############################################2019############################################
codes_NDCNUM_phenobarbital_2019 <- redbook_2019_data %>% 
  filter(
      grepl("phenobarb", GENNME, ignore.case=TRUE) |
      grepl("phenobarb", THRDTDS, ignore.case=TRUE) |
      grepl("phenobarb", PRODNME, ignore.case=TRUE) |
      grepl("luminal", PRODNME, ignore.case=TRUE) |
      grepl("solfoton", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenobarbital_2019 <- as.numeric(codes_NDCNUM_phenobarbital_2019)


codes_NDCNUM_phenytoin_2019 <- redbook_2019_data %>% 
  filter(
      grepl("phenytoin", GENNME, ignore.case=TRUE) |
      grepl("phenytoin", THRDTDS, ignore.case=TRUE) |
      grepl("phenytoin", PRODNME, ignore.case=TRUE) |
      grepl("dilantin", PRODNME, ignore.case=TRUE) |
      grepl("phenytek", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenytoin_2019 <- as.numeric(codes_NDCNUM_phenytoin_2019)


codes_NDCNUM_valproate_2019 <- redbook_2019_data %>% 
  filter(
      grepl("valpro", GENNME, ignore.case=TRUE) |
      grepl("valpro", THRDTDS, ignore.case=TRUE) |
      grepl("valpro", PRODNME, ignore.case=TRUE) |
      grepl("depakene", PRODNME, ignore.case=TRUE) |
      grepl("depakote", PRODNME, ignore.case=TRUE) |
      grepl("depacon", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_valproate_2019 <- as.numeric(codes_NDCNUM_valproate_2019)


codes_NDCNUM_carbamazepine_2019 <- redbook_2019_data %>% 
  filter(
      grepl("carbamazepine", GENNME, ignore.case=TRUE) |
      grepl("carbamazepine", THRDTDS, ignore.case=TRUE) |
      grepl("carbamazepine", PRODNME, ignore.case=TRUE) |
      grepl("tegretol", PRODNME, ignore.case=TRUE) |
      grepl("carbatrol", PRODNME, ignore.case=TRUE) |
      grepl("epitol", PRODNME, ignore.case=TRUE) |
      grepl("equetro", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("atretol", PRODNME, ignore.case=TRUE)
    ) %>%   
  pull(NDCNUM)
codes_NDCNUM_carbamazepine_2019 <- as.numeric(codes_NDCNUM_carbamazepine_2019)


codes_NDCNUM_oxcarbazepine_2019 <- redbook_2019_data %>% 
  filter(
      grepl("oxcarbazepine", GENNME, ignore.case=TRUE) |
      grepl("oxcarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("oxcarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("oxtellar", PRODNME, ignore.case=TRUE) |
      grepl("trileptal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_oxcarbazepine_2019 <- as.numeric(codes_NDCNUM_oxcarbazepine_2019)


codes_NDCNUM_rufinamide_2019 <- redbook_2019_data %>% 
  filter(
      grepl("rufinamide", GENNME, ignore.case=TRUE) |
      grepl("rufinamide", THRDTDS, ignore.case=TRUE) |
      grepl("rufinamide", PRODNME, ignore.case=TRUE) |
      grepl("banzel", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rufinamide_2019 <- as.numeric(codes_NDCNUM_rufinamide_2019)


codes_NDCNUM_levetiracetam_2019 <- redbook_2019_data %>% 
  filter(
      grepl("levetiracetam", GENNME, ignore.case=TRUE) |
      grepl("levetiracetam", THRDTDS, ignore.case=TRUE) |
      grepl("levetiracetam", PRODNME, ignore.case=TRUE) |
      grepl("elepsia", PRODNME, ignore.case=TRUE) |
      grepl("keppra", PRODNME, ignore.case=TRUE) |
      grepl("roweepra", PRODNME, ignore.case=TRUE) |
      grepl("spritam", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_levetiracetam_2019 <- as.numeric(codes_NDCNUM_levetiracetam_2019)


codes_NDCNUM_lamotrigine_2019 <- redbook_2019_data %>% 
  filter(
      grepl("lamotrigine", GENNME, ignore.case=TRUE) |
      grepl("lamotrigine", THRDTDS, ignore.case=TRUE) |
      grepl("lamotrigine", PRODNME, ignore.case=TRUE) |
      grepl("lamictal", PRODNME, ignore.case=TRUE) |
      grepl("subvenite", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lamotrigine_2019 <- as.numeric(codes_NDCNUM_lamotrigine_2019)


codes_NDCNUM_brivaracetam_2019 <- redbook_2019_data %>% 
  filter(
      grepl("brivaracetam", GENNME, ignore.case=TRUE) |
      grepl("brivaracetam", THRDTDS, ignore.case=TRUE) |
      grepl("brivaracetam", PRODNME, ignore.case=TRUE) |
      grepl("briviact", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_brivaracetam_2019 <- as.numeric(codes_NDCNUM_brivaracetam_2019)


codes_NDCNUM_cenobamate_2019 <- redbook_2019_data %>% 
  filter(
      grepl("cenobamate", GENNME, ignore.case=TRUE) |
      grepl("cenobamate", THRDTDS, ignore.case=TRUE) |
      grepl("cenobamate", PRODNME, ignore.case=TRUE) |
      grepl("xcopri", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cenobamate_2019 <- as.numeric(codes_NDCNUM_cenobamate_2019)


codes_NDCNUM_clobazam_2019 <- redbook_2019_data %>% 
  filter(
      grepl("clobazam", GENNME, ignore.case=TRUE) |
      grepl("clobazam", THRDTDS, ignore.case=TRUE) |
      grepl("clobazam", PRODNME, ignore.case=TRUE) |
      grepl("onfi", PRODNME, ignore.case=TRUE) |
      grepl("sympazan", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("HIV", GENNME, ignore.case=TRUE) &
    !grepl("pregnancy", GENNME, ignore.case=TRUE) &
    !grepl("denture", GENNME, ignore.case=TRUE) &
    !grepl("hyoscyamine", GENNME, ignore.case=TRUE) &
    !grepl("glucose", GENNME, ignore.case=TRUE) &
    !grepl("device", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_clobazam_2019 <- as.numeric(codes_NDCNUM_clobazam_2019)


codes_NDCNUM_eslicarbazepine_2019 <- redbook_2019_data %>% 
  filter(
      grepl("eslicarbazepine", GENNME, ignore.case=TRUE) |
      grepl("eslicarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("eslicarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("aptiom", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_eslicarbazepine_2019 <- as.numeric(codes_NDCNUM_eslicarbazepine_2019)


codes_NDCNUM_ethosuximide_2019 <- redbook_2019_data %>% 
  filter(
      grepl("ethosuximide", GENNME, ignore.case=TRUE) |
      grepl("ethosuximide", THRDTDS, ignore.case=TRUE) |
      grepl("ethosuximide", PRODNME, ignore.case=TRUE) |
      grepl("zarontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_ethosuximide_2019 <- as.numeric(codes_NDCNUM_ethosuximide_2019)


codes_NDCNUM_lacosamide_2019 <- redbook_2019_data %>% 
  filter(
      grepl("lacosamide", GENNME, ignore.case=TRUE) |
      grepl("lacosamide", THRDTDS, ignore.case=TRUE) |
      grepl("lacosamide", PRODNME, ignore.case=TRUE) |
      grepl("vimpat", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lacosamide_2019 <- as.numeric(codes_NDCNUM_lacosamide_2019)


codes_NDCNUM_perampanel_2019 <- redbook_2019_data %>% 
  filter(
      grepl("perampanel", GENNME, ignore.case=TRUE) |
      grepl("perampanel", THRDTDS, ignore.case=TRUE) |
      grepl("perampanel", PRODNME, ignore.case=TRUE) |
      grepl("fycompa", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_perampanel_2019 <- as.numeric(codes_NDCNUM_perampanel_2019)


codes_NDCNUM_stiripentol_2019 <- redbook_2019_data %>% 
  filter(
      grepl("stiripentol", GENNME, ignore.case=TRUE) |
      grepl("stiripentol", THRDTDS, ignore.case=TRUE) |
      grepl("stiripentol", PRODNME, ignore.case=TRUE) |
      grepl("diacomit", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_stiripentol_2019 <- as.numeric(codes_NDCNUM_stiripentol_2019)


codes_NDCNUM_topiramate_2019 <- redbook_2019_data %>% 
  filter(
      grepl("topiramate", GENNME, ignore.case=TRUE) |
      grepl("topiramate", THRDTDS, ignore.case=TRUE) |
      grepl("topiramate", PRODNME, ignore.case=TRUE) |
      grepl("eprontia", PRODNME, ignore.case=TRUE) |
      grepl("topamax", PRODNME, ignore.case=TRUE) |
      grepl("trokendi", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE) &
    !grepl("qudexy", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_topiramate_2019 <- as.numeric(codes_NDCNUM_topiramate_2019)


codes_NDCNUM_vigabatrin_2019 <- redbook_2019_data %>% 
  filter(
      grepl("vigabatrin", GENNME, ignore.case=TRUE) |
      grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |
      grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
      grepl("sabril", PRODNME, ignore.case=TRUE) |
      grepl("vigadrone", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_vigabatrin_2019 <- as.numeric(codes_NDCNUM_vigabatrin_2019)


codes_NDCNUM_zonisamide_2019 <- redbook_2019_data %>% 
  filter(
      grepl("zonisamide", GENNME, ignore.case=TRUE) |
      grepl("zonisamide", THRDTDS, ignore.case=TRUE) |
      grepl("zonisamide", PRODNME, ignore.case=TRUE) |
      grepl("zonegran", PRODNME, ignore.case=TRUE) |
      grepl("zonisade", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_zonisamide_2019 <- as.numeric(codes_NDCNUM_zonisamide_2019)


codes_NDCNUM_felbamate_2019 <- redbook_2019_data %>% 
  filter(
      grepl("felbamate", GENNME, ignore.case=TRUE) |
      grepl("felbamate", THRDTDS, ignore.case=TRUE) |
      grepl("felbamate", PRODNME, ignore.case=TRUE) |
      grepl("felbatol", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_felbamate_2019 <- as.numeric(codes_NDCNUM_felbamate_2019)


codes_NDCNUM_pregabalin_2019 <- redbook_2019_data %>% 
  filter(
      grepl("pregabalin", GENNME, ignore.case=TRUE) |
      grepl("pregabalin", THRDTDS, ignore.case=TRUE) |
      grepl("pregabalin", PRODNME, ignore.case=TRUE) |
      grepl("lyrica", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_pregabalin_2019 <- as.numeric(codes_NDCNUM_pregabalin_2019)


codes_NDCNUM_tiagabine_2019 <- redbook_2019_data %>% 
  filter(
      grepl("tiagabine", GENNME, ignore.case=TRUE) |
      grepl("tiagabine", THRDTDS, ignore.case=TRUE) |
      grepl("tiagabine", PRODNME, ignore.case=TRUE) |
      grepl("gabitril", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_tiagabine_2019 <- as.numeric(codes_NDCNUM_tiagabine_2019)


codes_NDCNUM_cannabidiol_2019 <- redbook_2019_data %>% 
  filter(
      grepl("epidiolex", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cannabidiol_2019 <- as.numeric(codes_NDCNUM_cannabidiol_2019)


codes_NDCNUM_gabapentin_2019 <- redbook_2019_data %>% 
  filter(
      grepl("gabapentin", GENNME, ignore.case=TRUE) |
      grepl("gabapentin", THRDTDS, ignore.case=TRUE) |
      grepl("gabapentin", PRODNME, ignore.case=TRUE) |
      grepl("gralise", PRODNME, ignore.case=TRUE) |
      grepl("neurontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl(";", GENNME, ignore.case=TRUE) &
    !grepl("enacarbil", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_gabapentin_2019 <- as.numeric(codes_NDCNUM_gabapentin_2019)


codes_NDCNUM_fenfluramine_2019 <- redbook_2019_data %>% 
  filter(
      grepl("fenfluramine", GENNME, ignore.case=TRUE) |
      grepl("fenfluramine", THRDTDS, ignore.case=TRUE) |
      grepl("fenfluramine", PRODNME, ignore.case=TRUE) |
      grepl("fintepla", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("dex", GENNME, ignore.case=TRUE) &
    !grepl("dex", THRDTDS, ignore.case=TRUE) &
    !grepl("hydrochloride", GENNME, ignore.case=TRUE) &    
    !grepl("hydrochloride", THRDTDS, ignore.case=TRUE) &
    !grepl("pondimin", PRODNME, ignore.case=TRUE) &
    !grepl("redux", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_fenfluramine_2019 <- as.numeric(codes_NDCNUM_fenfluramine_2019)


codes_NDCNUM_methsuximide_2019 <- redbook_2019_data %>% 
  filter(
      grepl("methsuximide", GENNME, ignore.case=TRUE) |
      grepl("methsuximide", THRDTDS, ignore.case=TRUE) |
      grepl("methsuximide", PRODNME, ignore.case=TRUE) |
      grepl("celontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_methsuximide_2019 <- as.numeric(codes_NDCNUM_methsuximide_2019)


codes_NDCNUM_ASM_2019 <- c(
  codes_NDCNUM_phenobarbital_2019,
  codes_NDCNUM_phenytoin_2019,
  codes_NDCNUM_valproate_2019,
  codes_NDCNUM_carbamazepine_2019,
  codes_NDCNUM_oxcarbazepine_2019,
  codes_NDCNUM_rufinamide_2019,
  codes_NDCNUM_levetiracetam_2019,
  codes_NDCNUM_lamotrigine_2019,
  codes_NDCNUM_brivaracetam_2019,
  codes_NDCNUM_cenobamate_2019,
  codes_NDCNUM_clobazam_2019,
  codes_NDCNUM_eslicarbazepine_2019,
  codes_NDCNUM_ethosuximide_2019,
  codes_NDCNUM_lacosamide_2019,
  codes_NDCNUM_perampanel_2019,
  codes_NDCNUM_stiripentol_2019,
  codes_NDCNUM_topiramate_2019,
  codes_NDCNUM_vigabatrin_2019,
  codes_NDCNUM_zonisamide_2019,
  codes_NDCNUM_felbamate_2019,
  codes_NDCNUM_pregabalin_2019,
  codes_NDCNUM_tiagabine_2019,
  codes_NDCNUM_cannabidiol_2019,
  codes_NDCNUM_gabapentin_2019,
  codes_NDCNUM_fenfluramine_2019,
  codes_NDCNUM_methsuximide_2019
)




############################################2020############################################
codes_NDCNUM_phenobarbital_2020 <- redbook_2020_data %>% 
  filter(
      grepl("phenobarb", GENNME, ignore.case=TRUE) |
      grepl("phenobarb", THRDTDS, ignore.case=TRUE) |
      grepl("phenobarb", PRODNME, ignore.case=TRUE) |
      grepl("luminal", PRODNME, ignore.case=TRUE) |
      grepl("solfoton", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenobarbital_2020 <- as.numeric(codes_NDCNUM_phenobarbital_2020)


codes_NDCNUM_phenytoin_2020 <- redbook_2020_data %>% 
  filter(
      grepl("phenytoin", GENNME, ignore.case=TRUE) |
      grepl("phenytoin", THRDTDS, ignore.case=TRUE) |
      grepl("phenytoin", PRODNME, ignore.case=TRUE) |
      grepl("dilantin", PRODNME, ignore.case=TRUE) |
      grepl("phenytek", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenytoin_2020 <- as.numeric(codes_NDCNUM_phenytoin_2020)


codes_NDCNUM_valproate_2020 <- redbook_2020_data %>% 
  filter(
      grepl("valpro", GENNME, ignore.case=TRUE) |
      grepl("valpro", THRDTDS, ignore.case=TRUE) |
      grepl("valpro", PRODNME, ignore.case=TRUE) |
      grepl("depakene", PRODNME, ignore.case=TRUE) |
      grepl("depakote", PRODNME, ignore.case=TRUE) |
      grepl("depacon", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_valproate_2020 <- as.numeric(codes_NDCNUM_valproate_2020)


codes_NDCNUM_carbamazepine_2020 <- redbook_2020_data %>% 
  filter(
      grepl("carbamazepine", GENNME, ignore.case=TRUE) |
      grepl("carbamazepine", THRDTDS, ignore.case=TRUE) |
      grepl("carbamazepine", PRODNME, ignore.case=TRUE) |
      grepl("tegretol", PRODNME, ignore.case=TRUE) |
      grepl("carbatrol", PRODNME, ignore.case=TRUE) |
      grepl("epitol", PRODNME, ignore.case=TRUE) |
      grepl("equetro", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("atretol", PRODNME, ignore.case=TRUE)
    ) %>%   
  pull(NDCNUM)
codes_NDCNUM_carbamazepine_2020 <- as.numeric(codes_NDCNUM_carbamazepine_2020)


codes_NDCNUM_oxcarbazepine_2020 <- redbook_2020_data %>% 
  filter(
      grepl("oxcarbazepine", GENNME, ignore.case=TRUE) |
      grepl("oxcarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("oxcarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("oxtellar", PRODNME, ignore.case=TRUE) |
      grepl("trileptal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_oxcarbazepine_2020 <- as.numeric(codes_NDCNUM_oxcarbazepine_2020)


codes_NDCNUM_rufinamide_2020 <- redbook_2020_data %>% 
  filter(
      grepl("rufinamide", GENNME, ignore.case=TRUE) |
      grepl("rufinamide", THRDTDS, ignore.case=TRUE) |
      grepl("rufinamide", PRODNME, ignore.case=TRUE) |
      grepl("banzel", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rufinamide_2020 <- as.numeric(codes_NDCNUM_rufinamide_2020)


codes_NDCNUM_levetiracetam_2020 <- redbook_2020_data %>% 
  filter(
      grepl("levetiracetam", GENNME, ignore.case=TRUE) |
      grepl("levetiracetam", THRDTDS, ignore.case=TRUE) |
      grepl("levetiracetam", PRODNME, ignore.case=TRUE) |
      grepl("elepsia", PRODNME, ignore.case=TRUE) |
      grepl("keppra", PRODNME, ignore.case=TRUE) |
      grepl("roweepra", PRODNME, ignore.case=TRUE) |
      grepl("spritam", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_levetiracetam_2020 <- as.numeric(codes_NDCNUM_levetiracetam_2020)


codes_NDCNUM_lamotrigine_2020 <- redbook_2020_data %>% 
  filter(
      grepl("lamotrigine", GENNME, ignore.case=TRUE) |
      grepl("lamotrigine", THRDTDS, ignore.case=TRUE) |
      grepl("lamotrigine", PRODNME, ignore.case=TRUE) |
      grepl("lamictal", PRODNME, ignore.case=TRUE) |
      grepl("subvenite", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lamotrigine_2020 <- as.numeric(codes_NDCNUM_lamotrigine_2020)


codes_NDCNUM_brivaracetam_2020 <- redbook_2020_data %>% 
  filter(
      grepl("brivaracetam", GENNME, ignore.case=TRUE) |
      grepl("brivaracetam", THRDTDS, ignore.case=TRUE) |
      grepl("brivaracetam", PRODNME, ignore.case=TRUE) |
      grepl("briviact", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_brivaracetam_2020 <- as.numeric(codes_NDCNUM_brivaracetam_2020)


codes_NDCNUM_cenobamate_2020 <- redbook_2020_data %>% 
  filter(
      grepl("cenobamate", GENNME, ignore.case=TRUE) |
      grepl("cenobamate", THRDTDS, ignore.case=TRUE) |
      grepl("cenobamate", PRODNME, ignore.case=TRUE) |
      grepl("xcopri", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cenobamate_2020 <- as.numeric(codes_NDCNUM_cenobamate_2020)


codes_NDCNUM_clobazam_2020 <- redbook_2020_data %>% 
  filter(
      grepl("clobazam", GENNME, ignore.case=TRUE) |
      grepl("clobazam", THRDTDS, ignore.case=TRUE) |
      grepl("clobazam", PRODNME, ignore.case=TRUE) |
      grepl("onfi", PRODNME, ignore.case=TRUE) |
      grepl("sympazan", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("HIV", GENNME, ignore.case=TRUE) &
    !grepl("pregnancy", GENNME, ignore.case=TRUE) &
    !grepl("denture", GENNME, ignore.case=TRUE) &
    !grepl("hyoscyamine", GENNME, ignore.case=TRUE) &
    !grepl("glucose", GENNME, ignore.case=TRUE) &
    !grepl("device", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_clobazam_2020 <- as.numeric(codes_NDCNUM_clobazam_2020)


codes_NDCNUM_eslicarbazepine_2020 <- redbook_2020_data %>% 
  filter(
      grepl("eslicarbazepine", GENNME, ignore.case=TRUE) |
      grepl("eslicarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("eslicarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("aptiom", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_eslicarbazepine_2020 <- as.numeric(codes_NDCNUM_eslicarbazepine_2020)


codes_NDCNUM_ethosuximide_2020 <- redbook_2020_data %>% 
  filter(
      grepl("ethosuximide", GENNME, ignore.case=TRUE) |
      grepl("ethosuximide", THRDTDS, ignore.case=TRUE) |
      grepl("ethosuximide", PRODNME, ignore.case=TRUE) |
      grepl("zarontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_ethosuximide_2020 <- as.numeric(codes_NDCNUM_ethosuximide_2020)


codes_NDCNUM_lacosamide_2020 <- redbook_2020_data %>% 
  filter(
      grepl("lacosamide", GENNME, ignore.case=TRUE) |
      grepl("lacosamide", THRDTDS, ignore.case=TRUE) |
      grepl("lacosamide", PRODNME, ignore.case=TRUE) |
      grepl("vimpat", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lacosamide_2020 <- as.numeric(codes_NDCNUM_lacosamide_2020)


codes_NDCNUM_perampanel_2020 <- redbook_2020_data %>% 
  filter(
      grepl("perampanel", GENNME, ignore.case=TRUE) |
      grepl("perampanel", THRDTDS, ignore.case=TRUE) |
      grepl("perampanel", PRODNME, ignore.case=TRUE) |
      grepl("fycompa", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_perampanel_2020 <- as.numeric(codes_NDCNUM_perampanel_2020)


codes_NDCNUM_stiripentol_2020 <- redbook_2020_data %>% 
  filter(
      grepl("stiripentol", GENNME, ignore.case=TRUE) |
      grepl("stiripentol", THRDTDS, ignore.case=TRUE) |
      grepl("stiripentol", PRODNME, ignore.case=TRUE) |
      grepl("diacomit", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_stiripentol_2020 <- as.numeric(codes_NDCNUM_stiripentol_2020)


codes_NDCNUM_topiramate_2020 <- redbook_2020_data %>% 
  filter(
      grepl("topiramate", GENNME, ignore.case=TRUE) |
      grepl("topiramate", THRDTDS, ignore.case=TRUE) |
      grepl("topiramate", PRODNME, ignore.case=TRUE) |
      grepl("eprontia", PRODNME, ignore.case=TRUE) |
      grepl("topamax", PRODNME, ignore.case=TRUE) |
      grepl("trokendi", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE) &
    !grepl("qudexy", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_topiramate_2020 <- as.numeric(codes_NDCNUM_topiramate_2020)


codes_NDCNUM_vigabatrin_2020 <- redbook_2020_data %>% 
  filter(
      grepl("vigabatrin", GENNME, ignore.case=TRUE) |
      grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |
      grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
      grepl("sabril", PRODNME, ignore.case=TRUE) |
      grepl("vigadrone", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_vigabatrin_2020 <- as.numeric(codes_NDCNUM_vigabatrin_2020)


codes_NDCNUM_zonisamide_2020 <- redbook_2020_data %>% 
  filter(
      grepl("zonisamide", GENNME, ignore.case=TRUE) |
      grepl("zonisamide", THRDTDS, ignore.case=TRUE) |
      grepl("zonisamide", PRODNME, ignore.case=TRUE) |
      grepl("zonegran", PRODNME, ignore.case=TRUE) |
      grepl("zonisade", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_zonisamide_2020 <- as.numeric(codes_NDCNUM_zonisamide_2020)


codes_NDCNUM_felbamate_2020 <- redbook_2020_data %>% 
  filter(
      grepl("felbamate", GENNME, ignore.case=TRUE) |
      grepl("felbamate", THRDTDS, ignore.case=TRUE) |
      grepl("felbamate", PRODNME, ignore.case=TRUE) |
      grepl("felbatol", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_felbamate_2020 <- as.numeric(codes_NDCNUM_felbamate_2020)


codes_NDCNUM_pregabalin_2020 <- redbook_2020_data %>% 
  filter(
      grepl("pregabalin", GENNME, ignore.case=TRUE) |
      grepl("pregabalin", THRDTDS, ignore.case=TRUE) |
      grepl("pregabalin", PRODNME, ignore.case=TRUE) |
      grepl("lyrica", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_pregabalin_2020 <- as.numeric(codes_NDCNUM_pregabalin_2020)


codes_NDCNUM_tiagabine_2020 <- redbook_2020_data %>% 
  filter(
      grepl("tiagabine", GENNME, ignore.case=TRUE) |
      grepl("tiagabine", THRDTDS, ignore.case=TRUE) |
      grepl("tiagabine", PRODNME, ignore.case=TRUE) |
      grepl("gabitril", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_tiagabine_2020 <- as.numeric(codes_NDCNUM_tiagabine_2020)


codes_NDCNUM_cannabidiol_2020 <- redbook_2020_data %>% 
  filter(
      grepl("epidiolex", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cannabidiol_2020 <- as.numeric(codes_NDCNUM_cannabidiol_2020)


codes_NDCNUM_gabapentin_2020 <- redbook_2020_data %>% 
  filter(
      grepl("gabapentin", GENNME, ignore.case=TRUE) |
      grepl("gabapentin", THRDTDS, ignore.case=TRUE) |
      grepl("gabapentin", PRODNME, ignore.case=TRUE) |
      grepl("gralise", PRODNME, ignore.case=TRUE) |
      grepl("neurontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl(";", GENNME, ignore.case=TRUE) &
    !grepl("enacarbil", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_gabapentin_2020 <- as.numeric(codes_NDCNUM_gabapentin_2020)


codes_NDCNUM_fenfluramine_2020 <- redbook_2020_data %>% 
  filter(
      grepl("fenfluramine", GENNME, ignore.case=TRUE) |
      grepl("fenfluramine", THRDTDS, ignore.case=TRUE) |
      grepl("fenfluramine", PRODNME, ignore.case=TRUE) |
      grepl("fintepla", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("dex", GENNME, ignore.case=TRUE) &
    !grepl("dex", THRDTDS, ignore.case=TRUE) &
    !grepl("hydrochloride", GENNME, ignore.case=TRUE) &    
    !grepl("hydrochloride", THRDTDS, ignore.case=TRUE) &
    !grepl("pondimin", PRODNME, ignore.case=TRUE) &
    !grepl("redux", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_fenfluramine_2020 <- as.numeric(codes_NDCNUM_fenfluramine_2020)


codes_NDCNUM_methsuximide_2020 <- redbook_2020_data %>% 
  filter(
      grepl("methsuximide", GENNME, ignore.case=TRUE) |
      grepl("methsuximide", THRDTDS, ignore.case=TRUE) |
      grepl("methsuximide", PRODNME, ignore.case=TRUE) |
      grepl("celontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_methsuximide_2020 <- as.numeric(codes_NDCNUM_methsuximide_2020)


codes_NDCNUM_ASM_2020 <- c(
  codes_NDCNUM_phenobarbital_2020,
  codes_NDCNUM_phenytoin_2020,
  codes_NDCNUM_valproate_2020,
  codes_NDCNUM_carbamazepine_2020,
  codes_NDCNUM_oxcarbazepine_2020,
  codes_NDCNUM_rufinamide_2020,
  codes_NDCNUM_levetiracetam_2020,
  codes_NDCNUM_lamotrigine_2020,
  codes_NDCNUM_brivaracetam_2020,
  codes_NDCNUM_cenobamate_2020,
  codes_NDCNUM_clobazam_2020,
  codes_NDCNUM_eslicarbazepine_2020,
  codes_NDCNUM_ethosuximide_2020,
  codes_NDCNUM_lacosamide_2020,
  codes_NDCNUM_perampanel_2020,
  codes_NDCNUM_stiripentol_2020,
  codes_NDCNUM_topiramate_2020,
  codes_NDCNUM_vigabatrin_2020,
  codes_NDCNUM_zonisamide_2020,
  codes_NDCNUM_felbamate_2020,
  codes_NDCNUM_pregabalin_2020,
  codes_NDCNUM_tiagabine_2020,
  codes_NDCNUM_cannabidiol_2020,
  codes_NDCNUM_gabapentin_2020,
  codes_NDCNUM_fenfluramine_2020,
  codes_NDCNUM_methsuximide_2020
)




############################################2021############################################
codes_NDCNUM_phenobarbital_2021 <- redbook_2021_data %>% 
  filter(
      grepl("phenobarb", GENNME, ignore.case=TRUE) |
      grepl("phenobarb", THRDTDS, ignore.case=TRUE) |
      grepl("phenobarb", PRODNME, ignore.case=TRUE) |
      grepl("luminal", PRODNME, ignore.case=TRUE) |
      grepl("solfoton", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenobarbital_2021 <- as.numeric(codes_NDCNUM_phenobarbital_2021)


codes_NDCNUM_phenytoin_2021 <- redbook_2021_data %>% 
  filter(
      grepl("phenytoin", GENNME, ignore.case=TRUE) |
      grepl("phenytoin", THRDTDS, ignore.case=TRUE) |
      grepl("phenytoin", PRODNME, ignore.case=TRUE) |
      grepl("dilantin", PRODNME, ignore.case=TRUE) |
      grepl("phenytek", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenytoin_2021 <- as.numeric(codes_NDCNUM_phenytoin_2021)


codes_NDCNUM_valproate_2021 <- redbook_2021_data %>% 
  filter(
      grepl("valpro", GENNME, ignore.case=TRUE) |
      grepl("valpro", THRDTDS, ignore.case=TRUE) |
      grepl("valpro", PRODNME, ignore.case=TRUE) |
      grepl("depakene", PRODNME, ignore.case=TRUE) |
      grepl("depakote", PRODNME, ignore.case=TRUE) |
      grepl("depacon", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_valproate_2021 <- as.numeric(codes_NDCNUM_valproate_2021)


codes_NDCNUM_carbamazepine_2021 <- redbook_2021_data %>% 
  filter(
      grepl("carbamazepine", GENNME, ignore.case=TRUE) |
      grepl("carbamazepine", THRDTDS, ignore.case=TRUE) |
      grepl("carbamazepine", PRODNME, ignore.case=TRUE) |
      grepl("tegretol", PRODNME, ignore.case=TRUE) |
      grepl("carbatrol", PRODNME, ignore.case=TRUE) |
      grepl("epitol", PRODNME, ignore.case=TRUE) |
      grepl("equetro", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("atretol", PRODNME, ignore.case=TRUE)
    ) %>%   
  pull(NDCNUM)
codes_NDCNUM_carbamazepine_2021 <- as.numeric(codes_NDCNUM_carbamazepine_2021)


codes_NDCNUM_oxcarbazepine_2021 <- redbook_2021_data %>% 
  filter(
      grepl("oxcarbazepine", GENNME, ignore.case=TRUE) |
      grepl("oxcarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("oxcarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("oxtellar", PRODNME, ignore.case=TRUE) |
      grepl("trileptal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_oxcarbazepine_2021 <- as.numeric(codes_NDCNUM_oxcarbazepine_2021)


codes_NDCNUM_rufinamide_2021 <- redbook_2021_data %>% 
  filter(
      grepl("rufinamide", GENNME, ignore.case=TRUE) |
      grepl("rufinamide", THRDTDS, ignore.case=TRUE) |
      grepl("rufinamide", PRODNME, ignore.case=TRUE) |
      grepl("banzel", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rufinamide_2021 <- as.numeric(codes_NDCNUM_rufinamide_2021)


codes_NDCNUM_levetiracetam_2021 <- redbook_2021_data %>% 
  filter(
      grepl("levetiracetam", GENNME, ignore.case=TRUE) |
      grepl("levetiracetam", THRDTDS, ignore.case=TRUE) |
      grepl("levetiracetam", PRODNME, ignore.case=TRUE) |
      grepl("elepsia", PRODNME, ignore.case=TRUE) |
      grepl("keppra", PRODNME, ignore.case=TRUE) |
      grepl("roweepra", PRODNME, ignore.case=TRUE) |
      grepl("spritam", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_levetiracetam_2021 <- as.numeric(codes_NDCNUM_levetiracetam_2021)


codes_NDCNUM_lamotrigine_2021 <- redbook_2021_data %>% 
  filter(
      grepl("lamotrigine", GENNME, ignore.case=TRUE) |
      grepl("lamotrigine", THRDTDS, ignore.case=TRUE) |
      grepl("lamotrigine", PRODNME, ignore.case=TRUE) |
      grepl("lamictal", PRODNME, ignore.case=TRUE) |
      grepl("subvenite", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lamotrigine_2021 <- as.numeric(codes_NDCNUM_lamotrigine_2021)


codes_NDCNUM_brivaracetam_2021 <- redbook_2021_data %>% 
  filter(
      grepl("brivaracetam", GENNME, ignore.case=TRUE) |
      grepl("brivaracetam", THRDTDS, ignore.case=TRUE) |
      grepl("brivaracetam", PRODNME, ignore.case=TRUE) |
      grepl("briviact", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_brivaracetam_2021 <- as.numeric(codes_NDCNUM_brivaracetam_2021)


codes_NDCNUM_cenobamate_2021 <- redbook_2021_data %>% 
  filter(
      grepl("cenobamate", GENNME, ignore.case=TRUE) |
      grepl("cenobamate", THRDTDS, ignore.case=TRUE) |
      grepl("cenobamate", PRODNME, ignore.case=TRUE) |
      grepl("xcopri", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cenobamate_2021 <- as.numeric(codes_NDCNUM_cenobamate_2021)


codes_NDCNUM_clobazam_2021 <- redbook_2021_data %>% 
  filter(
      grepl("clobazam", GENNME, ignore.case=TRUE) |
      grepl("clobazam", THRDTDS, ignore.case=TRUE) |
      grepl("clobazam", PRODNME, ignore.case=TRUE) |
      grepl("onfi", PRODNME, ignore.case=TRUE) |
      grepl("sympazan", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("HIV", GENNME, ignore.case=TRUE) &
    !grepl("pregnancy", GENNME, ignore.case=TRUE) &
    !grepl("denture", GENNME, ignore.case=TRUE) &
    !grepl("hyoscyamine", GENNME, ignore.case=TRUE) &
    !grepl("glucose", GENNME, ignore.case=TRUE) &
    !grepl("device", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_clobazam_2021 <- as.numeric(codes_NDCNUM_clobazam_2021)


codes_NDCNUM_eslicarbazepine_2021 <- redbook_2021_data %>% 
  filter(
      grepl("eslicarbazepine", GENNME, ignore.case=TRUE) |
      grepl("eslicarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("eslicarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("aptiom", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_eslicarbazepine_2021 <- as.numeric(codes_NDCNUM_eslicarbazepine_2021)


codes_NDCNUM_ethosuximide_2021 <- redbook_2021_data %>% 
  filter(
      grepl("ethosuximide", GENNME, ignore.case=TRUE) |
      grepl("ethosuximide", THRDTDS, ignore.case=TRUE) |
      grepl("ethosuximide", PRODNME, ignore.case=TRUE) |
      grepl("zarontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_ethosuximide_2021 <- as.numeric(codes_NDCNUM_ethosuximide_2021)


codes_NDCNUM_lacosamide_2021 <- redbook_2021_data %>% 
  filter(
      grepl("lacosamide", GENNME, ignore.case=TRUE) |
      grepl("lacosamide", THRDTDS, ignore.case=TRUE) |
      grepl("lacosamide", PRODNME, ignore.case=TRUE) |
      grepl("vimpat", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lacosamide_2021 <- as.numeric(codes_NDCNUM_lacosamide_2021)


codes_NDCNUM_perampanel_2021 <- redbook_2021_data %>% 
  filter(
      grepl("perampanel", GENNME, ignore.case=TRUE) |
      grepl("perampanel", THRDTDS, ignore.case=TRUE) |
      grepl("perampanel", PRODNME, ignore.case=TRUE) |
      grepl("fycompa", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_perampanel_2021 <- as.numeric(codes_NDCNUM_perampanel_2021)


codes_NDCNUM_stiripentol_2021 <- redbook_2021_data %>% 
  filter(
      grepl("stiripentol", GENNME, ignore.case=TRUE) |
      grepl("stiripentol", THRDTDS, ignore.case=TRUE) |
      grepl("stiripentol", PRODNME, ignore.case=TRUE) |
      grepl("diacomit", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_stiripentol_2021 <- as.numeric(codes_NDCNUM_stiripentol_2021)


codes_NDCNUM_topiramate_2021 <- redbook_2021_data %>% 
  filter(
      grepl("topiramate", GENNME, ignore.case=TRUE) |
      grepl("topiramate", THRDTDS, ignore.case=TRUE) |
      grepl("topiramate", PRODNME, ignore.case=TRUE) |
      grepl("eprontia", PRODNME, ignore.case=TRUE) |
      grepl("topamax", PRODNME, ignore.case=TRUE) |
      grepl("trokendi", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE) &
    !grepl("qudexy", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_topiramate_2021 <- as.numeric(codes_NDCNUM_topiramate_2021)


codes_NDCNUM_vigabatrin_2021 <- redbook_2021_data %>% 
  filter(
      grepl("vigabatrin", GENNME, ignore.case=TRUE) |
      grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |
      grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
      grepl("sabril", PRODNME, ignore.case=TRUE) |
      grepl("vigadrone", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_vigabatrin_2021 <- as.numeric(codes_NDCNUM_vigabatrin_2021)


codes_NDCNUM_zonisamide_2021 <- redbook_2021_data %>% 
  filter(
      grepl("zonisamide", GENNME, ignore.case=TRUE) |
      grepl("zonisamide", THRDTDS, ignore.case=TRUE) |
      grepl("zonisamide", PRODNME, ignore.case=TRUE) |
      grepl("zonegran", PRODNME, ignore.case=TRUE) |
      grepl("zonisade", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_zonisamide_2021 <- as.numeric(codes_NDCNUM_zonisamide_2021)


codes_NDCNUM_felbamate_2021 <- redbook_2021_data %>% 
  filter(
      grepl("felbamate", GENNME, ignore.case=TRUE) |
      grepl("felbamate", THRDTDS, ignore.case=TRUE) |
      grepl("felbamate", PRODNME, ignore.case=TRUE) |
      grepl("felbatol", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_felbamate_2021 <- as.numeric(codes_NDCNUM_felbamate_2021)


codes_NDCNUM_pregabalin_2021 <- redbook_2021_data %>% 
  filter(
      grepl("pregabalin", GENNME, ignore.case=TRUE) |
      grepl("pregabalin", THRDTDS, ignore.case=TRUE) |
      grepl("pregabalin", PRODNME, ignore.case=TRUE) |
      grepl("lyrica", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_pregabalin_2021 <- as.numeric(codes_NDCNUM_pregabalin_2021)


codes_NDCNUM_tiagabine_2021 <- redbook_2021_data %>% 
  filter(
      grepl("tiagabine", GENNME, ignore.case=TRUE) |
      grepl("tiagabine", THRDTDS, ignore.case=TRUE) |
      grepl("tiagabine", PRODNME, ignore.case=TRUE) |
      grepl("gabitril", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_tiagabine_2021 <- as.numeric(codes_NDCNUM_tiagabine_2021)


codes_NDCNUM_cannabidiol_2021 <- redbook_2021_data %>% 
  filter(
      grepl("epidiolex", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cannabidiol_2021 <- as.numeric(codes_NDCNUM_cannabidiol_2021)


codes_NDCNUM_gabapentin_2021 <- redbook_2021_data %>% 
  filter(
      grepl("gabapentin", GENNME, ignore.case=TRUE) |
      grepl("gabapentin", THRDTDS, ignore.case=TRUE) |
      grepl("gabapentin", PRODNME, ignore.case=TRUE) |
      grepl("gralise", PRODNME, ignore.case=TRUE) |
      grepl("neurontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl(";", GENNME, ignore.case=TRUE) &
    !grepl("enacarbil", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_gabapentin_2021 <- as.numeric(codes_NDCNUM_gabapentin_2021)


codes_NDCNUM_fenfluramine_2021 <- redbook_2021_data %>% 
  filter(
      grepl("fenfluramine", GENNME, ignore.case=TRUE) |
      grepl("fenfluramine", THRDTDS, ignore.case=TRUE) |
      grepl("fenfluramine", PRODNME, ignore.case=TRUE) |
      grepl("fintepla", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("dex", GENNME, ignore.case=TRUE) &
    !grepl("dex", THRDTDS, ignore.case=TRUE) &
    !grepl("hydrochloride", GENNME, ignore.case=TRUE) &    
    !grepl("hydrochloride", THRDTDS, ignore.case=TRUE) &
    !grepl("pondimin", PRODNME, ignore.case=TRUE) &
    !grepl("redux", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_fenfluramine_2021 <- as.numeric(codes_NDCNUM_fenfluramine_2021)


codes_NDCNUM_methsuximide_2021 <- redbook_2021_data %>% 
  filter(
      grepl("methsuximide", GENNME, ignore.case=TRUE) |
      grepl("methsuximide", THRDTDS, ignore.case=TRUE) |
      grepl("methsuximide", PRODNME, ignore.case=TRUE) |
      grepl("celontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_methsuximide_2021 <- as.numeric(codes_NDCNUM_methsuximide_2021)


codes_NDCNUM_ASM_2021 <- c(
  codes_NDCNUM_phenobarbital_2021,
  codes_NDCNUM_phenytoin_2021,
  codes_NDCNUM_valproate_2021,
  codes_NDCNUM_carbamazepine_2021,
  codes_NDCNUM_oxcarbazepine_2021,
  codes_NDCNUM_rufinamide_2021,
  codes_NDCNUM_levetiracetam_2021,
  codes_NDCNUM_lamotrigine_2021,
  codes_NDCNUM_brivaracetam_2021,
  codes_NDCNUM_cenobamate_2021,
  codes_NDCNUM_clobazam_2021,
  codes_NDCNUM_eslicarbazepine_2021,
  codes_NDCNUM_ethosuximide_2021,
  codes_NDCNUM_lacosamide_2021,
  codes_NDCNUM_perampanel_2021,
  codes_NDCNUM_stiripentol_2021,
  codes_NDCNUM_topiramate_2021,
  codes_NDCNUM_vigabatrin_2021,
  codes_NDCNUM_zonisamide_2021,
  codes_NDCNUM_felbamate_2021,
  codes_NDCNUM_pregabalin_2021,
  codes_NDCNUM_tiagabine_2021,
  codes_NDCNUM_cannabidiol_2021,
  codes_NDCNUM_gabapentin_2021,
  codes_NDCNUM_fenfluramine_2021,
  codes_NDCNUM_methsuximide_2021
)




############################################2022############################################
codes_NDCNUM_phenobarbital_2022 <- redbook_2022_data %>% 
  filter(
      grepl("phenobarb", GENNME, ignore.case=TRUE) |
      grepl("phenobarb", THRDTDS, ignore.case=TRUE) |
      grepl("phenobarb", PRODNME, ignore.case=TRUE) |
      grepl("luminal", PRODNME, ignore.case=TRUE) |
      grepl("solfoton", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenobarbital_2022 <- as.numeric(codes_NDCNUM_phenobarbital_2022)


codes_NDCNUM_phenytoin_2022 <- redbook_2022_data %>% 
  filter(
      grepl("phenytoin", GENNME, ignore.case=TRUE) |
      grepl("phenytoin", THRDTDS, ignore.case=TRUE) |
      grepl("phenytoin", PRODNME, ignore.case=TRUE) |
      grepl("dilantin", PRODNME, ignore.case=TRUE) |
      grepl("phenytek", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_phenytoin_2022 <- as.numeric(codes_NDCNUM_phenytoin_2022)


codes_NDCNUM_valproate_2022 <- redbook_2022_data %>% 
  filter(
      grepl("valpro", GENNME, ignore.case=TRUE) |
      grepl("valpro", THRDTDS, ignore.case=TRUE) |
      grepl("valpro", PRODNME, ignore.case=TRUE) |
      grepl("depakene", PRODNME, ignore.case=TRUE) |
      grepl("depakote", PRODNME, ignore.case=TRUE) |
      grepl("depacon", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_valproate_2022 <- as.numeric(codes_NDCNUM_valproate_2022)


codes_NDCNUM_carbamazepine_2022 <- redbook_2022_data %>% 
  filter(
      grepl("carbamazepine", GENNME, ignore.case=TRUE) |
      grepl("carbamazepine", THRDTDS, ignore.case=TRUE) |
      grepl("carbamazepine", PRODNME, ignore.case=TRUE) |
      grepl("tegretol", PRODNME, ignore.case=TRUE) |
      grepl("carbatrol", PRODNME, ignore.case=TRUE) |
      grepl("epitol", PRODNME, ignore.case=TRUE) |
      grepl("equetro", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("atretol", PRODNME, ignore.case=TRUE)
    ) %>%   
  pull(NDCNUM)
codes_NDCNUM_carbamazepine_2022 <- as.numeric(codes_NDCNUM_carbamazepine_2022)


codes_NDCNUM_oxcarbazepine_2022 <- redbook_2022_data %>% 
  filter(
      grepl("oxcarbazepine", GENNME, ignore.case=TRUE) |
      grepl("oxcarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("oxcarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("oxtellar", PRODNME, ignore.case=TRUE) |
      grepl("trileptal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_oxcarbazepine_2022 <- as.numeric(codes_NDCNUM_oxcarbazepine_2022)


codes_NDCNUM_rufinamide_2022 <- redbook_2022_data %>% 
  filter(
      grepl("rufinamide", GENNME, ignore.case=TRUE) |
      grepl("rufinamide", THRDTDS, ignore.case=TRUE) |
      grepl("rufinamide", PRODNME, ignore.case=TRUE) |
      grepl("banzel", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rufinamide_2022 <- as.numeric(codes_NDCNUM_rufinamide_2022)


codes_NDCNUM_levetiracetam_2022 <- redbook_2022_data %>% 
  filter(
      grepl("levetiracetam", GENNME, ignore.case=TRUE) |
      grepl("levetiracetam", THRDTDS, ignore.case=TRUE) |
      grepl("levetiracetam", PRODNME, ignore.case=TRUE) |
      grepl("elepsia", PRODNME, ignore.case=TRUE) |
      grepl("keppra", PRODNME, ignore.case=TRUE) |
      grepl("roweepra", PRODNME, ignore.case=TRUE) |
      grepl("spritam", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_levetiracetam_2022 <- as.numeric(codes_NDCNUM_levetiracetam_2022)


codes_NDCNUM_lamotrigine_2022 <- redbook_2022_data %>% 
  filter(
      grepl("lamotrigine", GENNME, ignore.case=TRUE) |
      grepl("lamotrigine", THRDTDS, ignore.case=TRUE) |
      grepl("lamotrigine", PRODNME, ignore.case=TRUE) |
      grepl("lamictal", PRODNME, ignore.case=TRUE) |
      grepl("subvenite", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lamotrigine_2022 <- as.numeric(codes_NDCNUM_lamotrigine_2022)


codes_NDCNUM_brivaracetam_2022 <- redbook_2022_data %>% 
  filter(
      grepl("brivaracetam", GENNME, ignore.case=TRUE) |
      grepl("brivaracetam", THRDTDS, ignore.case=TRUE) |
      grepl("brivaracetam", PRODNME, ignore.case=TRUE) |
      grepl("briviact", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_brivaracetam_2022 <- as.numeric(codes_NDCNUM_brivaracetam_2022)


codes_NDCNUM_cenobamate_2022 <- redbook_2022_data %>% 
  filter(
      grepl("cenobamate", GENNME, ignore.case=TRUE) |
      grepl("cenobamate", THRDTDS, ignore.case=TRUE) |
      grepl("cenobamate", PRODNME, ignore.case=TRUE) |
      grepl("xcopri", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cenobamate_2022 <- as.numeric(codes_NDCNUM_cenobamate_2022)


codes_NDCNUM_clobazam_2022 <- redbook_2022_data %>% 
  filter(
      grepl("clobazam", GENNME, ignore.case=TRUE) |
      grepl("clobazam", THRDTDS, ignore.case=TRUE) |
      grepl("clobazam", PRODNME, ignore.case=TRUE) |
      grepl("onfi", PRODNME, ignore.case=TRUE) |
      grepl("sympazan", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("HIV", GENNME, ignore.case=TRUE) &
    !grepl("pregnancy", GENNME, ignore.case=TRUE) &
    !grepl("denture", GENNME, ignore.case=TRUE) &
    !grepl("hyoscyamine", GENNME, ignore.case=TRUE) &
    !grepl("glucose", GENNME, ignore.case=TRUE) &
    !grepl("device", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_clobazam_2022 <- as.numeric(codes_NDCNUM_clobazam_2022)


codes_NDCNUM_eslicarbazepine_2022 <- redbook_2022_data %>% 
  filter(
      grepl("eslicarbazepine", GENNME, ignore.case=TRUE) |
      grepl("eslicarbazepine", THRDTDS, ignore.case=TRUE) |
      grepl("eslicarbazepine", PRODNME, ignore.case=TRUE) |
      grepl("aptiom", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_eslicarbazepine_2022 <- as.numeric(codes_NDCNUM_eslicarbazepine_2022)


codes_NDCNUM_ethosuximide_2022 <- redbook_2022_data %>% 
  filter(
      grepl("ethosuximide", GENNME, ignore.case=TRUE) |
      grepl("ethosuximide", THRDTDS, ignore.case=TRUE) |
      grepl("ethosuximide", PRODNME, ignore.case=TRUE) |
      grepl("zarontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_ethosuximide_2022 <- as.numeric(codes_NDCNUM_ethosuximide_2022)


codes_NDCNUM_lacosamide_2022 <- redbook_2022_data %>% 
  filter(
      grepl("lacosamide", GENNME, ignore.case=TRUE) |
      grepl("lacosamide", THRDTDS, ignore.case=TRUE) |
      grepl("lacosamide", PRODNME, ignore.case=TRUE) |
      grepl("vimpat", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_lacosamide_2022 <- as.numeric(codes_NDCNUM_lacosamide_2022)


codes_NDCNUM_perampanel_2022 <- redbook_2022_data %>% 
  filter(
      grepl("perampanel", GENNME, ignore.case=TRUE) |
      grepl("perampanel", THRDTDS, ignore.case=TRUE) |
      grepl("perampanel", PRODNME, ignore.case=TRUE) |
      grepl("fycompa", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_perampanel_2022 <- as.numeric(codes_NDCNUM_perampanel_2022)


codes_NDCNUM_stiripentol_2022 <- redbook_2022_data %>% 
  filter(
      grepl("stiripentol", GENNME, ignore.case=TRUE) |
      grepl("stiripentol", THRDTDS, ignore.case=TRUE) |
      grepl("stiripentol", PRODNME, ignore.case=TRUE) |
      grepl("diacomit", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_stiripentol_2022 <- as.numeric(codes_NDCNUM_stiripentol_2022)


codes_NDCNUM_topiramate_2022 <- redbook_2022_data %>% 
  filter(
      grepl("topiramate", GENNME, ignore.case=TRUE) |
      grepl("topiramate", THRDTDS, ignore.case=TRUE) |
      grepl("topiramate", PRODNME, ignore.case=TRUE) |
      grepl("eprontia", PRODNME, ignore.case=TRUE) |
      grepl("topamax", PRODNME, ignore.case=TRUE) |
      grepl("trokendi", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("/", GENNME, ignore.case=TRUE) &
    !grepl("/", PRODNME, ignore.case=TRUE) &
    !grepl("/", THRDTDS, ignore.case=TRUE) &
    !grepl("&", GENNME, ignore.case=TRUE) &
    !grepl("&", PRODNME, ignore.case=TRUE) &
    !grepl("&", THRDTDS, ignore.case=TRUE) &
    !grepl("-", GENNME, ignore.case=TRUE) &
    !grepl("-", PRODNME, ignore.case=TRUE) &
    !grepl("-", THRDTDS, ignore.case=TRUE) &
    !grepl("qudexy", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_topiramate_2022 <- as.numeric(codes_NDCNUM_topiramate_2022)


codes_NDCNUM_vigabatrin_2022 <- redbook_2022_data %>% 
  filter(
      grepl("vigabatrin", GENNME, ignore.case=TRUE) |
      grepl("vigabatrin", THRDTDS, ignore.case=TRUE) |
      grepl("vigabatrin", PRODNME, ignore.case=TRUE) |
      grepl("sabril", PRODNME, ignore.case=TRUE) |
      grepl("vigadrone", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_vigabatrin_2022 <- as.numeric(codes_NDCNUM_vigabatrin_2022)


codes_NDCNUM_zonisamide_2022 <- redbook_2022_data %>% 
  filter(
      grepl("zonisamide", GENNME, ignore.case=TRUE) |
      grepl("zonisamide", THRDTDS, ignore.case=TRUE) |
      grepl("zonisamide", PRODNME, ignore.case=TRUE) |
      grepl("zonegran", PRODNME, ignore.case=TRUE) |
      grepl("zonisade", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_zonisamide_2022 <- as.numeric(codes_NDCNUM_zonisamide_2022)


codes_NDCNUM_felbamate_2022 <- redbook_2022_data %>% 
  filter(
      grepl("felbamate", GENNME, ignore.case=TRUE) |
      grepl("felbamate", THRDTDS, ignore.case=TRUE) |
      grepl("felbamate", PRODNME, ignore.case=TRUE) |
      grepl("felbatol", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_felbamate_2022 <- as.numeric(codes_NDCNUM_felbamate_2022)


codes_NDCNUM_pregabalin_2022 <- redbook_2022_data %>% 
  filter(
      grepl("pregabalin", GENNME, ignore.case=TRUE) |
      grepl("pregabalin", THRDTDS, ignore.case=TRUE) |
      grepl("pregabalin", PRODNME, ignore.case=TRUE) |
      grepl("lyrica", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_pregabalin_2022 <- as.numeric(codes_NDCNUM_pregabalin_2022)


codes_NDCNUM_tiagabine_2022 <- redbook_2022_data %>% 
  filter(
      grepl("tiagabine", GENNME, ignore.case=TRUE) |
      grepl("tiagabine", THRDTDS, ignore.case=TRUE) |
      grepl("tiagabine", PRODNME, ignore.case=TRUE) |
      grepl("gabitril", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_tiagabine_2022 <- as.numeric(codes_NDCNUM_tiagabine_2022)


codes_NDCNUM_cannabidiol_2022 <- redbook_2022_data %>% 
  filter(
      grepl("epidiolex", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_cannabidiol_2022 <- as.numeric(codes_NDCNUM_cannabidiol_2022)


codes_NDCNUM_gabapentin_2022 <- redbook_2022_data %>% 
  filter(
      grepl("gabapentin", GENNME, ignore.case=TRUE) |
      grepl("gabapentin", THRDTDS, ignore.case=TRUE) |
      grepl("gabapentin", PRODNME, ignore.case=TRUE) |
      grepl("gralise", PRODNME, ignore.case=TRUE) |
      grepl("neurontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl(";", GENNME, ignore.case=TRUE) &
    !grepl("enacarbil", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_gabapentin_2022 <- as.numeric(codes_NDCNUM_gabapentin_2022)


codes_NDCNUM_fenfluramine_2022 <- redbook_2022_data %>% 
  filter(
      grepl("fenfluramine", GENNME, ignore.case=TRUE) |
      grepl("fenfluramine", THRDTDS, ignore.case=TRUE) |
      grepl("fenfluramine", PRODNME, ignore.case=TRUE) |
      grepl("fintepla", PRODNME, ignore.case=TRUE)
    ) %>% 
  filter(
    !grepl("dex", GENNME, ignore.case=TRUE) &
    !grepl("dex", THRDTDS, ignore.case=TRUE) &
    !grepl("hydrochloride", GENNME, ignore.case=TRUE) &    
    !grepl("hydrochloride", THRDTDS, ignore.case=TRUE) &
    !grepl("pondimin", PRODNME, ignore.case=TRUE) &
    !grepl("redux", GENNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_fenfluramine_2022 <- as.numeric(codes_NDCNUM_fenfluramine_2022)


codes_NDCNUM_methsuximide_2022 <- redbook_2022_data %>% 
  filter(
      grepl("methsuximide", GENNME, ignore.case=TRUE) |
      grepl("methsuximide", THRDTDS, ignore.case=TRUE) |
      grepl("methsuximide", PRODNME, ignore.case=TRUE) |
      grepl("celontin", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_methsuximide_2022 <- as.numeric(codes_NDCNUM_methsuximide_2022)


codes_NDCNUM_ASM_2022 <- c(
  codes_NDCNUM_phenobarbital_2022,
  codes_NDCNUM_phenytoin_2022,
  codes_NDCNUM_valproate_2022,
  codes_NDCNUM_carbamazepine_2022,
  codes_NDCNUM_oxcarbazepine_2022,
  codes_NDCNUM_rufinamide_2022,
  codes_NDCNUM_levetiracetam_2022,
  codes_NDCNUM_lamotrigine_2022,
  codes_NDCNUM_brivaracetam_2022,
  codes_NDCNUM_cenobamate_2022,
  codes_NDCNUM_clobazam_2022,
  codes_NDCNUM_eslicarbazepine_2022,
  codes_NDCNUM_ethosuximide_2022,
  codes_NDCNUM_lacosamide_2022,
  codes_NDCNUM_perampanel_2022,
  codes_NDCNUM_stiripentol_2022,
  codes_NDCNUM_topiramate_2022,
  codes_NDCNUM_vigabatrin_2022,
  codes_NDCNUM_zonisamide_2022,
  codes_NDCNUM_felbamate_2022,
  codes_NDCNUM_pregabalin_2022,
  codes_NDCNUM_tiagabine_2022,
  codes_NDCNUM_cannabidiol_2022,
  codes_NDCNUM_gabapentin_2022,
  codes_NDCNUM_fenfluramine_2022,
  codes_NDCNUM_methsuximide_2022
)
```




Rescue medications
```{r}
# NDCNUM codes for rectal diazepam
codes_NDCNUM_rectal_DZP_2006 <- redbook_2006_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2006 <- as.numeric(codes_NDCNUM_rectal_DZP_2006)


codes_NDCNUM_rectal_DZP_2007 <- redbook_2007_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2007 <- as.numeric(codes_NDCNUM_rectal_DZP_2007)


codes_NDCNUM_rectal_DZP_2008 <- redbook_2008_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2008 <- as.numeric(codes_NDCNUM_rectal_DZP_2008)


codes_NDCNUM_rectal_DZP_2009 <- redbook_2009_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2009 <- as.numeric(codes_NDCNUM_rectal_DZP_2009)


codes_NDCNUM_rectal_DZP_2010 <- redbook_2010_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2010 <- as.numeric(codes_NDCNUM_rectal_DZP_2010)


codes_NDCNUM_rectal_DZP_2011 <- redbook_2011_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2011 <- as.numeric(codes_NDCNUM_rectal_DZP_2011)


codes_NDCNUM_rectal_DZP_2012 <- redbook_2012_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2012 <- as.numeric(codes_NDCNUM_rectal_DZP_2012)


codes_NDCNUM_rectal_DZP_2013 <- redbook_2013_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2013 <- as.numeric(codes_NDCNUM_rectal_DZP_2013)


codes_NDCNUM_rectal_DZP_2014 <- redbook_2014_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2014 <- as.numeric(codes_NDCNUM_rectal_DZP_2014)


codes_NDCNUM_rectal_DZP_2015 <- redbook_2015_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2015 <- as.numeric(codes_NDCNUM_rectal_DZP_2015)


codes_NDCNUM_rectal_DZP_2016 <- redbook_2016_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2016 <- as.numeric(codes_NDCNUM_rectal_DZP_2016)


codes_NDCNUM_rectal_DZP_2017 <- redbook_2017_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2017 <- as.numeric(codes_NDCNUM_rectal_DZP_2017)


codes_NDCNUM_rectal_DZP_2018 <- redbook_2018_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2018 <- as.numeric(codes_NDCNUM_rectal_DZP_2018)


codes_NDCNUM_rectal_DZP_2019 <- redbook_2019_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2019 <- as.numeric(codes_NDCNUM_rectal_DZP_2019)


codes_NDCNUM_rectal_DZP_2020 <- redbook_2020_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2020 <- as.numeric(codes_NDCNUM_rectal_DZP_2020)


codes_NDCNUM_rectal_DZP_2021 <- redbook_2021_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2021 <- as.numeric(codes_NDCNUM_rectal_DZP_2021)


codes_NDCNUM_rectal_DZP_2022 <- redbook_2022_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2022 <- as.numeric(codes_NDCNUM_rectal_DZP_2022)




# NDCNUM codes for intranasal midazolam
codes_NDCNUM_intranasal_MDZ_2006 <- redbook_2006_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2006 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2006)


codes_NDCNUM_intranasal_MDZ_2007 <- redbook_2007_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2007 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2007)


codes_NDCNUM_intranasal_MDZ_2008 <- redbook_2008_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2008 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2008)


codes_NDCNUM_intranasal_MDZ_2009 <- redbook_2009_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2009 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2009)


codes_NDCNUM_intranasal_MDZ_2010 <- redbook_2010_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2010 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2010)


codes_NDCNUM_intranasal_MDZ_2011 <- redbook_2011_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2011 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2011)


codes_NDCNUM_intranasal_MDZ_2012 <- redbook_2012_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2012 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2012)


codes_NDCNUM_intranasal_MDZ_2013 <- redbook_2013_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2013 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2013)


codes_NDCNUM_intranasal_MDZ_2014 <- redbook_2014_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2014 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2014)


codes_NDCNUM_intranasal_MDZ_2015 <- redbook_2015_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2015 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2015)


codes_NDCNUM_intranasal_MDZ_2016 <- redbook_2016_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2016 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2016)


codes_NDCNUM_intranasal_MDZ_2017 <- redbook_2017_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2017 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2017)


codes_NDCNUM_intranasal_MDZ_2018 <- redbook_2018_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2018 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2018)


codes_NDCNUM_intranasal_MDZ_2019 <- redbook_2019_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2019 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2019)


codes_NDCNUM_intranasal_MDZ_2020 <- redbook_2020_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2020 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2020)


codes_NDCNUM_intranasal_MDZ_2021 <- redbook_2021_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2021 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2021)


codes_NDCNUM_intranasal_MDZ_2022 <- redbook_2022_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2022 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2022)




# NDCNUM codes for intranasal diazepam
codes_NDCNUM_intranasal_DZP_2006 <- redbook_2006_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2006 <- as.numeric(codes_NDCNUM_intranasal_DZP_2006)


codes_NDCNUM_intranasal_DZP_2007 <- redbook_2007_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2007 <- as.numeric(codes_NDCNUM_intranasal_DZP_2007)


codes_NDCNUM_intranasal_DZP_2008 <- redbook_2008_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2008 <- as.numeric(codes_NDCNUM_intranasal_DZP_2008)


codes_NDCNUM_intranasal_DZP_2009 <- redbook_2009_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2009 <- as.numeric(codes_NDCNUM_intranasal_DZP_2009)


codes_NDCNUM_intranasal_DZP_2010 <- redbook_2010_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2010 <- as.numeric(codes_NDCNUM_intranasal_DZP_2010)


codes_NDCNUM_intranasal_DZP_2011 <- redbook_2011_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2011 <- as.numeric(codes_NDCNUM_intranasal_DZP_2011)


codes_NDCNUM_intranasal_DZP_2012 <- redbook_2012_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2012 <- as.numeric(codes_NDCNUM_intranasal_DZP_2012)


codes_NDCNUM_intranasal_DZP_2013 <- redbook_2013_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2013 <- as.numeric(codes_NDCNUM_intranasal_DZP_2013)


codes_NDCNUM_intranasal_DZP_2014 <- redbook_2014_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2014 <- as.numeric(codes_NDCNUM_intranasal_DZP_2014)


codes_NDCNUM_intranasal_DZP_2015 <- redbook_2015_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2015 <- as.numeric(codes_NDCNUM_intranasal_DZP_2015)


codes_NDCNUM_intranasal_DZP_2016 <- redbook_2016_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2016 <- as.numeric(codes_NDCNUM_intranasal_DZP_2016)


codes_NDCNUM_intranasal_DZP_2017 <- redbook_2017_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2017 <- as.numeric(codes_NDCNUM_intranasal_DZP_2017)


codes_NDCNUM_intranasal_DZP_2018 <- redbook_2018_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2018 <- as.numeric(codes_NDCNUM_intranasal_DZP_2018)


codes_NDCNUM_intranasal_DZP_2019 <- redbook_2019_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2019 <- as.numeric(codes_NDCNUM_intranasal_DZP_2019)


codes_NDCNUM_intranasal_DZP_2020 <- redbook_2020_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2020 <- as.numeric(codes_NDCNUM_intranasal_DZP_2020)


codes_NDCNUM_intranasal_DZP_2021 <- redbook_2021_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2021 <- as.numeric(codes_NDCNUM_intranasal_DZP_2021)


codes_NDCNUM_intranasal_DZP_2022 <- redbook_2022_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2022 <- as.numeric(codes_NDCNUM_intranasal_DZP_2022)
```




Patients with epilepsy with at least 6 months between first and last chronic antiseizure medication prescription
```{r}
# Antiseizure medications in patients with epilepsy with at least 6 months of chronic antiseizure medications

####################################2006####################################
patients_with_epilepsy_and_ASM_2006 <- ms_d_2006 %>% 
  filter(ENROLID %in% !!epilepsy$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ASM_2006) %>%
  select(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP, SVCDATE) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


####################################2007####################################
patients_with_epilepsy_and_ASM_2007 <- ms_d_2007 %>% 
  filter(ENROLID %in% !!epilepsy$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ASM_2007) %>%
  select(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP, SVCDATE) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


####################################2008####################################
patients_with_epilepsy_and_ASM_2008 <- ms_d_2008 %>% 
  filter(ENROLID %in% !!epilepsy$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ASM_2008) %>%
  select(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP, SVCDATE) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


####################################2009####################################
patients_with_epilepsy_and_ASM_2009 <- ms_d_2009 %>% 
  filter(ENROLID %in% !!epilepsy$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ASM_2009) %>%
  select(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP, SVCDATE) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


####################################2010####################################
patients_with_epilepsy_and_ASM_2010 <- ms_d_2010 %>% 
  filter(ENROLID %in% !!epilepsy$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ASM_2010) %>%
  select(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP, SVCDATE) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


####################################2011####################################
patients_with_epilepsy_and_ASM_2011 <- ms_d_2011 %>% 
  filter(ENROLID %in% !!epilepsy$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ASM_2011) %>%
  select(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP, SVCDATE) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


####################################2012####################################
patients_with_epilepsy_and_ASM_2012 <- ms_d_2012 %>% 
  filter(ENROLID %in% !!epilepsy$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ASM_2012) %>%
  select(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP, SVCDATE) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


####################################2013####################################
patients_with_epilepsy_and_ASM_2013 <- ms_d_2013 %>% 
  filter(ENROLID %in% !!epilepsy$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ASM_2013) %>%
  select(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP, SVCDATE) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


####################################2014####################################
patients_with_epilepsy_and_ASM_2014 <- ms_d_2014 %>% 
  filter(ENROLID %in% !!epilepsy$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ASM_2014) %>%
  select(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP, SVCDATE) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


####################################2015####################################
patients_with_epilepsy_and_ASM_2015 <- ms_d_2015 %>% 
  filter(ENROLID %in% !!epilepsy$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ASM_2015) %>%
  select(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP, SVCDATE) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) 


####################################2016####################################
patients_with_epilepsy_and_ASM_2016 <- ms_d_2016 %>% 
  filter(ENROLID %in% !!epilepsy$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ASM_2016) %>%
  select(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP, SVCDATE) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


####################################2017####################################
patients_with_epilepsy_and_ASM_2017 <- ms_d_2017 %>% 
  filter(ENROLID %in% !!epilepsy$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ASM_2017) %>%
  select(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP, SVCDATE) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


####################################2018####################################
patients_with_epilepsy_and_ASM_2018 <- ms_d_2018 %>% 
  filter(ENROLID %in% !!epilepsy$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ASM_2018) %>%
  select(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP, SVCDATE) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


####################################2019####################################
patients_with_epilepsy_and_ASM_2019 <- ms_d_2019 %>% 
  filter(ENROLID %in% !!epilepsy$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ASM_2019) %>%
  select(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP, SVCDATE) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


####################################2020####################################
patients_with_epilepsy_and_ASM_2020 <- ms_d_2020 %>% 
  filter(ENROLID %in% !!epilepsy$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ASM_2020) %>%
  select(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP, SVCDATE) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


####################################2021####################################
patients_with_epilepsy_and_ASM_2021 <- ms_d_2021 %>% 
  filter(ENROLID %in% !!epilepsy$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ASM_2021) %>%
  select(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP, SVCDATE) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))


####################################2022####################################
patients_with_epilepsy_and_ASM_2022 <- ms_d_2022 %>% 
  filter(ENROLID %in% !!epilepsy$ENROLID) %>% 
  filter(NDCNUM %in% codes_NDCNUM_ASM_2022) %>%
  select(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP, SVCDATE) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, DOBYR, YEAR, AGE, PLANTYP), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy))



# Patients with epilepsy and on chronic antiseizure medications
patients_with_epilepsy_and_ASM <- bind_rows(patients_with_epilepsy_and_ASM_2006, patients_with_epilepsy_and_ASM_2007, patients_with_epilepsy_and_ASM_2008, patients_with_epilepsy_and_ASM_2009, patients_with_epilepsy_and_ASM_2010, patients_with_epilepsy_and_ASM_2011, patients_with_epilepsy_and_ASM_2012, patients_with_epilepsy_and_ASM_2013, patients_with_epilepsy_and_ASM_2014, patients_with_epilepsy_and_ASM_2015, patients_with_epilepsy_and_ASM_2016, patients_with_epilepsy_and_ASM_2017, patients_with_epilepsy_and_ASM_2018, patients_with_epilepsy_and_ASM_2019, patients_with_epilepsy_and_ASM_2020, patients_with_epilepsy_and_ASM_2021, patients_with_epilepsy_and_ASM_2022) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  arrange(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  mutate(maximum_days_between_ASM_prescriptions = max(SVCDATE) - min(SVCDATE)) %>% 
  mutate(gap_between_prescriptions = ymd(SVCDATE) - (ymd(lag(SVCDATE)) + days(lag(DAYSUPP)))) %>% 
  mutate(total_supply = sum(DAYSUPP)) %>% 
  mutate(ASM_supply_gap = maximum_days_between_ASM_prescriptions - total_supply) %>% 
  filter(maximum_days_between_ASM_prescriptions>=180) %>% 
  collect()


# Patients with epilepsy and chronic antiseizure medications
patients_with_epilepsy_and_ASM_n <- patients_with_epilepsy_and_ASM %>% distinct(ENROLID) %>% nrow()
patients_with_epilepsy_and_ASM_n


# Keep only patients who had no gaps in ASM prescriptions for more than 30 days
patients_with_30_days_ASM_gap <- patients_with_epilepsy_and_ASM %>% filter(ASM_supply_gap > 30) %>% distinct(ENROLID)

patients_with_epilepsy_and_ASM_no_gaps <- patients_with_epilepsy_and_ASM %>% 
  anti_join(patients_with_30_days_ASM_gap, by="ENROLID")

patients_with_epilepsy_and_ASM_no_gaps_n <- patients_with_epilepsy_and_ASM_no_gaps %>% distinct(ENROLID) %>% nrow()
patients_with_epilepsy_and_ASM_no_gaps_n
```




Determination of inpatient visits and emergency visits for epilepsy
```{r}
# Resource utilization
revenue_codes_EDvisits <- c("0450", "0451", "0452", "0456", "0459", "0981")
place_of_service_codes_EDvisits <- c("20", "23", "41", "42")
CPT_codes_EDvisits <- c("99281", "99282", "99283", "99284", "99285")
service_subcategory_codes_EDvisits <- c("10120", "10220", "10320", "10420", "10520", "12220", "20120", "20220", "21120", "21220", "22120", "22320")
PROCGRP_codes_EDvisits <- c("111", "114")

revenue_codes_inpatient <- c("0100", "0101", "0110", "0111", "0112", "0113", "0114", "0115", "0116", "0117", "0118", "0119", "0120", "0121", "0122", "0123", "0124", "0125", "0126", "0127", "0128", "0129", "0130", "0131", "0132", "0133", "0134", "0135", "0136", "0137", "0138", "0139", "0140", "0141", "0142", "0143", "0144", "0145", "0146", "0147", "0148", "0149", "0150", "0151", "0152", "0153", "0154", "0155", "0156", "0157", "0158", "0159", "0160", "0161", "0162", "0164", "0166", "0167", "0168", "0169", "0170", "0171", "0172", "0173", "0174", "0175", "0179", "0180", "0182", "0183", "0184", "0185", "0189", "0190", "0191", "0192", "0193", "0194", "0199", "0200", "0201", "0202", "0203", "0204", "0206", "0207", "0208", "0209", "0210", "0211", "0212", "0213", "0214", "0219", "0720", "0721", "0722", "0723", "0724", "0729", "0760", "0761", "0762", "0769", "0800", "0801", "0802", "0803", "0804", "0809")
place_of_service_codes_inpatient <- c("21", "27", "28")
CPT_codes_inpatient <- c("99217", "99218", "99219", "99220", "99224", "99225", "99226", "99234", "99235", "99236")




# Inpatient and emergency visits 
#################################2006#################################
IP_ED_2006_i <- ms_i_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(epilepsy_encounter = case_when(
  DX1 %in% codes_epilepsy_ICD9 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2006_o <- ms_o_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2006_s <- ms_s_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)


#################################2007#################################
IP_ED_2007_i <- ms_i_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(epilepsy_encounter = case_when(
  DX1 %in% codes_epilepsy_ICD9 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2007_o <- ms_o_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2007_s <- ms_s_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)


#################################2008#################################
IP_ED_2008_i <- ms_i_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(epilepsy_encounter = case_when(
  DX1 %in% codes_epilepsy_ICD9 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2008_o <- ms_o_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2008_s <- ms_s_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)


#################################2009#################################
IP_ED_2009_i <- ms_i_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(epilepsy_encounter = case_when(
  DX1 %in% codes_epilepsy_ICD9 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2009_o <- ms_o_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2009_s <- ms_s_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)


#################################2010#################################
IP_ED_2010_i <- ms_i_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(epilepsy_encounter = case_when(
  DX1 %in% codes_epilepsy_ICD9 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2010_o <- ms_o_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2010_s <- ms_s_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)


#################################2011#################################
IP_ED_2011_i <- ms_i_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(epilepsy_encounter = case_when(
  DX1 %in% codes_epilepsy_ICD9 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2011_o <- ms_o_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2011_s <- ms_s_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)


#################################2012#################################
IP_ED_2012_i <- ms_i_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(epilepsy_encounter = case_when(
  DX1 %in% codes_epilepsy_ICD9 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2012_o <- ms_o_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2012_s <- ms_s_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)


#################################2013#################################
IP_ED_2013_i <- ms_i_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(epilepsy_encounter = case_when(
  DX1 %in% codes_epilepsy_ICD9 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2013_o <- ms_o_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2013_s <- ms_s_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)


#################################2014#################################
IP_ED_2014_i <- ms_i_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(epilepsy_encounter = case_when(
  DX1 %in% codes_epilepsy_ICD9 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2014_o <- ms_o_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2014_s <- ms_s_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)


#################################2015#################################
IP_ED_2015_i <- ms_i_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(epilepsy_encounter = case_when(
  (DX1 %in% codes_epilepsy_ICD9 | DX1 %in% codes_epilepsy_ICD10) ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2015_o <- ms_o_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(epilepsy_encounter = case_when(
    (DX1 %in% codes_epilepsy_ICD9 | DX1 %in% codes_epilepsy_ICD10) ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2015_s <- ms_s_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(epilepsy_encounter = case_when(
    (DX1 %in% codes_epilepsy_ICD9 | DX1 %in% codes_epilepsy_ICD10) ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)


#################################2016#################################
IP_ED_2016_i <- ms_i_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(epilepsy_encounter = case_when(
  DX1 %in% codes_epilepsy_ICD10 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2016_o <- ms_o_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2016_s <- ms_s_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)


#################################2017#################################
IP_ED_2017_i <- ms_i_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(epilepsy_encounter = case_when(
  DX1 %in% codes_epilepsy_ICD10 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2017_o <- ms_o_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2017_s <- ms_s_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)


#################################2018#################################
IP_ED_2018_i <- ms_i_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(epilepsy_encounter = case_when(
  DX1 %in% codes_epilepsy_ICD10 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2018_o <- ms_o_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2018_s <- ms_s_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)


#################################2019#################################
IP_ED_2019_i <- ms_i_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(epilepsy_encounter = case_when(
  DX1 %in% codes_epilepsy_ICD10 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2019_o <- ms_o_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2019_s <- ms_s_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)


#################################2020#################################
IP_ED_2020_i <- ms_i_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(epilepsy_encounter = case_when(
  DX1 %in% codes_epilepsy_ICD10 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2020_o <- ms_o_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2020_s <- ms_s_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)


#################################2021#################################
IP_ED_2021_i <- ms_i_2021 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(epilepsy_encounter = case_when(
  DX1 %in% codes_epilepsy_ICD10 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2021_o <- ms_o_2021 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2021_s <- ms_s_2021 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)


#################################2022#################################
IP_ED_2022_i <- ms_i_2022 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(epilepsy_encounter = case_when(
  DX1 %in% codes_epilepsy_ICD10 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2022_o <- ms_o_2022 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)

IP_ED_2022_s <- ms_s_2022 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(epilepsy_encounter = case_when(
    DX1 %in% codes_epilepsy_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, epilepsy_encounter)




# Patients with inpatient or emergency events
IP_ED <- bind_rows(IP_ED_2006_i, IP_ED_2006_o, IP_ED_2006_s, IP_ED_2007_i, IP_ED_2007_o, IP_ED_2007_s, IP_ED_2008_i, IP_ED_2008_o, IP_ED_2008_s, IP_ED_2009_i, IP_ED_2009_o, IP_ED_2009_s, IP_ED_2010_i, IP_ED_2010_o, IP_ED_2010_s, IP_ED_2011_i, IP_ED_2011_o, IP_ED_2011_s, IP_ED_2012_i, IP_ED_2012_o, IP_ED_2012_s, IP_ED_2013_i, IP_ED_2013_o, IP_ED_2013_s, IP_ED_2014_i, IP_ED_2014_o, IP_ED_2014_s, IP_ED_2015_i, IP_ED_2015_o, IP_ED_2015_s, IP_ED_2016_i, IP_ED_2016_o, IP_ED_2016_s, IP_ED_2017_i, IP_ED_2017_o, IP_ED_2017_s, IP_ED_2018_i, IP_ED_2018_o, IP_ED_2018_s, IP_ED_2019_i, IP_ED_2019_o, IP_ED_2019_s, IP_ED_2020_i, IP_ED_2020_o, IP_ED_2020_s, IP_ED_2021_i, IP_ED_2021_o, IP_ED_2021_s, IP_ED_2022_i, IP_ED_2022_o, IP_ED_2022_s) %>% 
  mutate(type = factor(type)) %>% 
  collect()




# Epilepsy encounters data
epilepsy_encounters_data <- IP_ED %>% 
  rename(encounter_date = SVCDATE) %>% 
  filter(epilepsy_encounter==1) %>% 
  filter(type=="inpatient" | type=="emergency") %>% 
  distinct(ENROLID, encounter_date, .keep_all=TRUE) %>% 
  group_by(ENROLID) %>% 
  mutate(total_epilepsy_encounters=sum(epilepsy_encounter)) %>% 
  ungroup() %>% 
  arrange(ENROLID, encounter_date) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, encounter_date, type, total_epilepsy_encounters) %>% 
  collect()




# Epilepsy all encounters data
all_epilepsy_encounters_data <- IP_ED %>% 
  rename(encounter_date = SVCDATE) %>% 
  filter(epilepsy_encounter==1) %>% 
  filter(type=="inpatient" | type=="emergency") %>% 
  distinct(ENROLID, encounter_date, .keep_all=TRUE) %>% 
  arrange(ENROLID, encounter_date) %>% 
  select(ENROLID, encounter_date, type) %>% 
  collect()
```




Patients with epilepsy with at least 6 months between first and last chronic antiseizure medication prescription and at least one rescue medication prescribed
```{r}
# Rescue medications

####################################2006####################################
rescue_medication_epilepsy_2006 <- ms_d_2006 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2006) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2006) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2006) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2006 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2006 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2006 ~ "intranasal diazepam"
  ))


####################################2007####################################
rescue_medication_epilepsy_2007 <- ms_d_2007 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2007) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2007) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2007) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2007 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2007 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2007 ~ "intranasal diazepam"
  ))


####################################2008####################################
rescue_medication_epilepsy_2008 <- ms_d_2008 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2008) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2008) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2008) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2008 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2008 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2008 ~ "intranasal diazepam"
  ))


####################################2009####################################
rescue_medication_epilepsy_2009 <- ms_d_2009 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2009) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2009) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2009) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2009 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2009 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2009 ~ "intranasal diazepam"
  ))


####################################2010####################################
rescue_medication_epilepsy_2010 <- ms_d_2010 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2010) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2010) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2010) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2010 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2010 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2010 ~ "intranasal diazepam"
  ))


####################################2011####################################
rescue_medication_epilepsy_2011 <- ms_d_2011 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2011) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2011) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2011) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2011 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2011 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2011 ~ "intranasal diazepam"
  ))


####################################2012####################################
rescue_medication_epilepsy_2012 <- ms_d_2012 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2012) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2012) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2012) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2012 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2012 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2012 ~ "intranasal diazepam"
  ))


####################################2013####################################
rescue_medication_epilepsy_2013 <- ms_d_2013 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2013) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2013) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2013) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2013 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2013 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2013 ~ "intranasal diazepam"
  ))


####################################2014####################################
rescue_medication_epilepsy_2014 <- ms_d_2014 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2014) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2014) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2014) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2014 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2014 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2014 ~ "intranasal diazepam"
  ))


####################################2015####################################
rescue_medication_epilepsy_2015 <- ms_d_2015 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2015) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2015) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2015) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2015 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2015 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2015 ~ "intranasal diazepam"
  ))


####################################2016####################################
rescue_medication_epilepsy_2016 <- ms_d_2016 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2016) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2016) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2016) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2016 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2016 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2016 ~ "intranasal diazepam"
  ))


####################################2017####################################
rescue_medication_epilepsy_2017 <- ms_d_2017 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2017) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2017) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2017) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2017 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2017 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2017 ~ "intranasal diazepam"
  ))


####################################2018####################################
rescue_medication_epilepsy_2018 <- ms_d_2018 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2018) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2018) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2018) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2018 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2018 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2018 ~ "intranasal diazepam"
  ))


####################################2019####################################
rescue_medication_epilepsy_2019 <- ms_d_2019 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2019) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2019) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2019) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2019 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2019 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2019 ~ "intranasal diazepam"
  ))


####################################2020####################################
rescue_medication_epilepsy_2020 <- ms_d_2020 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2020) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2020) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2020) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2020 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2020 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2020 ~ "intranasal diazepam"
  ))


####################################2021####################################
rescue_medication_epilepsy_2021 <- ms_d_2021 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2021) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2021) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2021) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2021 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2021 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2021 ~ "intranasal diazepam"
  ))


####################################2022####################################
rescue_medication_epilepsy_2022 <- ms_d_2022 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2022) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2022) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2022) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2022 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2022 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2022 ~ "intranasal diazepam"
  ))




# Rescue medication
rescue_medication_epilepsy <- bind_rows(rescue_medication_epilepsy_2006, rescue_medication_epilepsy_2007, rescue_medication_epilepsy_2008, rescue_medication_epilepsy_2009, rescue_medication_epilepsy_2010, rescue_medication_epilepsy_2011, rescue_medication_epilepsy_2012, rescue_medication_epilepsy_2013, rescue_medication_epilepsy_2014, rescue_medication_epilepsy_2015, rescue_medication_epilepsy_2016, rescue_medication_epilepsy_2017, rescue_medication_epilepsy_2018, rescue_medication_epilepsy_2019, rescue_medication_epilepsy_2020, rescue_medication_epilepsy_2021, rescue_medication_epilepsy_2022) %>% 
  mutate(rescue_medication = factor(rescue_medication)) %>%    
  mutate(GENIND = factor(GENIND)) %>% 
  mutate(RXMR = factor(RXMR)) %>%           
  arrange(ENROLID, SVCDATE) %>% 
  mutate(year_rescue_medication=year(SVCDATE)) %>% 
  collect()


# Patients with rescue medication
rescue_medication_patients_n <- rescue_medication_epilepsy %>% distinct(ENROLID) %>% nrow()
rescue_medication_patients_n


# Proportion of patients with rescue medication among patients with epilepsy on chronic antiseizure medications
rescue_medication_patients_n / patients_with_epilepsy_and_ASM_no_gaps_n
```




Adjustment for inflation
```{r}
# Inflation calculations (https://apps.bea.gov/iTable/?reqid=19&step=2&isuri=1&categories=survey&_gl=1*1piml3m*_ga*NDg1MDgzODA2LjE3MDg0OTgxMjg.*_ga_J4698JNNFT*MTcwODQ5ODQ5Mi4xLjEuMTcwODQ5ODUzNi4xNi4wLjA.#eyJhcHBpZCI6MTksInN0ZXBzIjpbMSwyLDMsM10sImRhdGEiOltbImNhdGVnb3JpZXMiLCJTdXJ2ZXkiXSxbIk5JUEFfVGFibGVfTGlzdCIsIjQiXSxbIkZpcnN0X1llYXIiLCIyMDA2Il0sWyJMYXN0X1llYXIiLCIyMDIyIl0sWyJTY2FsZSIsIjAiXSxbIlNlcmllcyIsIlEiXV19 Last accessed 2/11/2024)
# https://meps.ahrq.gov/about_meps/Price_Index.shtml
inflation_2006_Q1 <- 0.83135
inflation_2006_Q2 <- 0.83871	
inflation_2006_Q3 <- 0.84486	
inflation_2006_Q4 <- 0.84806
inflation_2007_Q1 <- 0.85655
inflation_2007_Q2 <- 0.86201	
inflation_2007_Q3 <- 0.86568	
inflation_2007_Q4 <- 0.86982	
inflation_2008_Q1 <- 0.87359
inflation_2008_Q2 <- 0.87678	
inflation_2008_Q3 <- 0.88361	
inflation_2008_Q4 <- 0.88511
inflation_2009_Q1 <- 0.88536
inflation_2009_Q2 <- 0.88418	
inflation_2009_Q3 <- 0.88474	
inflation_2009_Q4 <- 0.88798	
inflation_2010_Q1 <- 0.89018	
inflation_2010_Q2 <- 0.89431	
inflation_2010_Q3 <- 0.89755			
inflation_2010_Q4 <- 0.90270			
inflation_2011_Q1 <- 0.90710
inflation_2011_Q2 <- 0.91363	
inflation_2011_Q3 <- 0.91840	
inflation_2011_Q4 <- 0.91951	
inflation_2012_Q1 <- 0.92495	
inflation_2012_Q2 <- 0.92881	
inflation_2012_Q3 <- 0.93459
inflation_2012_Q4 <- 0.93869	
inflation_2013_Q1 <- 0.94204
inflation_2013_Q2 <- 0.94474
inflation_2013_Q3 <- 0.94989
inflation_2013_Q4 <- 0.95477		
inflation_2014_Q1 <- 0.95840
inflation_2014_Q2 <- 0.96343	
inflation_2014_Q3 <- 0.96762
inflation_2014_Q4 <- 0.96800		
inflation_2015_Q1 <- 0.96742
inflation_2015_Q2 <- 0.97302	
inflation_2015_Q3 <- 0.97536
inflation_2015_Q4 <- 0.97527
inflation_2016_Q1 <- 0.97468	
inflation_2016_Q2 <- 0.98108	
inflation_2016_Q3 <- 0.98372
inflation_2016_Q4 <- 0.98884
inflation_2017_Q1 <- 0.99389
inflation_2017_Q2 <- 0.99656		
inflation_2017_Q3 <- 1.00174
inflation_2017_Q4 <- 1.00780	
inflation_2018_Q1 <- 1.01428	
inflation_2018_Q2 <- 1.02140		
inflation_2018_Q3 <- 1.02586
inflation_2018_Q4 <- 1.03005		
inflation_2019_Q1 <- 1.03375	
inflation_2019_Q2 <- 1.03878		
inflation_2019_Q3 <- 1.04213
inflation_2019_Q4 <- 1.04566	
inflation_2020_Q1 <- 1.05042
inflation_2020_Q2 <- 1.04661		
inflation_2020_Q3 <- 1.05593
inflation_2020_Q4 <- 1.06330
inflation_2021_Q1 <- 1.07731		
inflation_2021_Q2 <- 1.09332		
inflation_2021_Q3 <- 1.10957
inflation_2021_Q4 <- 1.12858
inflation_2022_Q1 <- 1.15182		
inflation_2022_Q2 <- 1.17704			
inflation_2022_Q3 <- 1.18980
inflation_2022_Q4 <- 1.20115


# Cost adjusted for inflation (to Q4 2022 year)
inflation_adjusted_rescue_medication_epilepsy <- rescue_medication_epilepsy %>% 
  mutate(year_quarter = quarter(SVCDATE, with_year=TRUE)) %>%
  mutate(
    AWP = case_when(
  year_quarter == 2006.1 ~ AWP*(inflation_2022_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ AWP*(inflation_2022_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ AWP*(inflation_2022_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ AWP*(inflation_2022_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ AWP*(inflation_2022_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ AWP*(inflation_2022_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ AWP*(inflation_2022_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ AWP*(inflation_2022_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ AWP*(inflation_2022_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ AWP*(inflation_2022_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ AWP*(inflation_2022_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ AWP*(inflation_2022_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ AWP*(inflation_2022_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ AWP*(inflation_2022_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ AWP*(inflation_2022_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ AWP*(inflation_2022_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ AWP*(inflation_2022_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ AWP*(inflation_2022_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ AWP*(inflation_2022_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ AWP*(inflation_2022_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ AWP*(inflation_2022_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ AWP*(inflation_2022_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ AWP*(inflation_2022_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ AWP*(inflation_2022_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ AWP*(inflation_2022_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ AWP*(inflation_2022_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ AWP*(inflation_2022_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ AWP*(inflation_2022_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ AWP*(inflation_2022_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ AWP*(inflation_2022_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ AWP*(inflation_2022_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ AWP*(inflation_2022_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ AWP*(inflation_2022_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ AWP*(inflation_2022_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ AWP*(inflation_2022_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ AWP*(inflation_2022_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ AWP*(inflation_2022_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ AWP*(inflation_2022_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ AWP*(inflation_2022_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ AWP*(inflation_2022_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ AWP*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ AWP*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ AWP*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ AWP*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ AWP*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ AWP*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ AWP*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ AWP*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ AWP*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ AWP*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ AWP*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ AWP*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ AWP*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ AWP*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ AWP*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ AWP*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ AWP*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ AWP*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ AWP*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ AWP*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ AWP*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ AWP*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ AWP*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ AWP*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ AWP*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ AWP*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ AWP*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ AWP*(inflation_2022_Q4/inflation_2022_Q4)),
    COB = case_when(
  year_quarter == 2006.1 ~ COB*(inflation_2022_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ COB*(inflation_2022_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ COB*(inflation_2022_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ COB*(inflation_2022_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ COB*(inflation_2022_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ COB*(inflation_2022_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ COB*(inflation_2022_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ COB*(inflation_2022_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ COB*(inflation_2022_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ COB*(inflation_2022_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ COB*(inflation_2022_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ COB*(inflation_2022_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ COB*(inflation_2022_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ COB*(inflation_2022_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ COB*(inflation_2022_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ COB*(inflation_2022_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ COB*(inflation_2022_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ COB*(inflation_2022_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ COB*(inflation_2022_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ COB*(inflation_2022_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ COB*(inflation_2022_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ COB*(inflation_2022_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ COB*(inflation_2022_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ COB*(inflation_2022_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ COB*(inflation_2022_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ COB*(inflation_2022_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ COB*(inflation_2022_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ COB*(inflation_2022_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ COB*(inflation_2022_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ COB*(inflation_2022_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ COB*(inflation_2022_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ COB*(inflation_2022_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ COB*(inflation_2022_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ COB*(inflation_2022_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ COB*(inflation_2022_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ COB*(inflation_2022_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ COB*(inflation_2022_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ COB*(inflation_2022_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ COB*(inflation_2022_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ COB*(inflation_2022_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ COB*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ COB*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ COB*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ COB*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ COB*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ COB*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ COB*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ COB*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ COB*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ COB*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ COB*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ COB*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ COB*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ COB*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ COB*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ COB*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ COB*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ COB*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ COB*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ COB*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ COB*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ COB*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ COB*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ COB*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ COB*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ COB*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ COB*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ COB*(inflation_2022_Q4/inflation_2022_Q4)),
    COINS = case_when(
  year_quarter == 2006.1 ~ COINS*(inflation_2022_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ COINS*(inflation_2022_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ COINS*(inflation_2022_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ COINS*(inflation_2022_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ COINS*(inflation_2022_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ COINS*(inflation_2022_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ COINS*(inflation_2022_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ COINS*(inflation_2022_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ COINS*(inflation_2022_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ COINS*(inflation_2022_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ COINS*(inflation_2022_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ COINS*(inflation_2022_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ COINS*(inflation_2022_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ COINS*(inflation_2022_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ COINS*(inflation_2022_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ COINS*(inflation_2022_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ COINS*(inflation_2022_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ COINS*(inflation_2022_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ COINS*(inflation_2022_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ COINS*(inflation_2022_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ COINS*(inflation_2022_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ COINS*(inflation_2022_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ COINS*(inflation_2022_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ COINS*(inflation_2022_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ COINS*(inflation_2022_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ COINS*(inflation_2022_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ COINS*(inflation_2022_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ COINS*(inflation_2022_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ COINS*(inflation_2022_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ COINS*(inflation_2022_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ COINS*(inflation_2022_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ COINS*(inflation_2022_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ COINS*(inflation_2022_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ COINS*(inflation_2022_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ COINS*(inflation_2022_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ COINS*(inflation_2022_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ COINS*(inflation_2022_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ COINS*(inflation_2022_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ COINS*(inflation_2022_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ COINS*(inflation_2022_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ COINS*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ COINS*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ COINS*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ COINS*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ COINS*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ COINS*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ COINS*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ COINS*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ COINS*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ COINS*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ COINS*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ COINS*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ COINS*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ COINS*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ COINS*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ COINS*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ COINS*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ COINS*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ COINS*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ COINS*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ COINS*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ COINS*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ COINS*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ COINS*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ COINS*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ COINS*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ COINS*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ COINS*(inflation_2022_Q4/inflation_2022_Q4)),
    COPAY = case_when(
  year_quarter == 2006.1 ~ COPAY*(inflation_2022_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ COPAY*(inflation_2022_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ COPAY*(inflation_2022_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ COPAY*(inflation_2022_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ COPAY*(inflation_2022_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ COPAY*(inflation_2022_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ COPAY*(inflation_2022_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ COPAY*(inflation_2022_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ COPAY*(inflation_2022_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ COPAY*(inflation_2022_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ COPAY*(inflation_2022_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ COPAY*(inflation_2022_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ COPAY*(inflation_2022_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ COPAY*(inflation_2022_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ COPAY*(inflation_2022_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ COPAY*(inflation_2022_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ COPAY*(inflation_2022_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ COPAY*(inflation_2022_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ COPAY*(inflation_2022_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ COPAY*(inflation_2022_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ COPAY*(inflation_2022_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ COPAY*(inflation_2022_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ COPAY*(inflation_2022_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ COPAY*(inflation_2022_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ COPAY*(inflation_2022_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ COPAY*(inflation_2022_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ COPAY*(inflation_2022_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ COPAY*(inflation_2022_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ COPAY*(inflation_2022_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ COPAY*(inflation_2022_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ COPAY*(inflation_2022_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ COPAY*(inflation_2022_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ COPAY*(inflation_2022_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ COPAY*(inflation_2022_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ COPAY*(inflation_2022_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ COPAY*(inflation_2022_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ COPAY*(inflation_2022_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ COPAY*(inflation_2022_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ COPAY*(inflation_2022_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ COPAY*(inflation_2022_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ COPAY*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ COPAY*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ COPAY*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ COPAY*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ COPAY*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ COPAY*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ COPAY*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ COPAY*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ COPAY*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ COPAY*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ COPAY*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ COPAY*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ COPAY*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ COPAY*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ COPAY*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ COPAY*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ COPAY*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ COPAY*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ COPAY*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ COPAY*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ COPAY*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ COPAY*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ COPAY*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ COPAY*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ COPAY*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ COPAY*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ COPAY*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ COPAY*(inflation_2022_Q4/inflation_2022_Q4)),
    DEDUCT = case_when(
  year_quarter == 2006.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2022_Q4)),
    DISPFEE = case_when(
  year_quarter == 2006.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2022_Q4)),
    INGCOST = case_when(
  year_quarter == 2006.1 ~ INGCOST*(inflation_2022_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ INGCOST*(inflation_2022_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ INGCOST*(inflation_2022_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ INGCOST*(inflation_2022_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ INGCOST*(inflation_2022_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ INGCOST*(inflation_2022_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ INGCOST*(inflation_2022_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ INGCOST*(inflation_2022_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ INGCOST*(inflation_2022_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ INGCOST*(inflation_2022_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ INGCOST*(inflation_2022_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ INGCOST*(inflation_2022_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ INGCOST*(inflation_2022_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ INGCOST*(inflation_2022_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ INGCOST*(inflation_2022_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ INGCOST*(inflation_2022_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ INGCOST*(inflation_2022_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ INGCOST*(inflation_2022_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ INGCOST*(inflation_2022_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ INGCOST*(inflation_2022_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ INGCOST*(inflation_2022_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ INGCOST*(inflation_2022_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ INGCOST*(inflation_2022_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ INGCOST*(inflation_2022_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ INGCOST*(inflation_2022_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ INGCOST*(inflation_2022_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ INGCOST*(inflation_2022_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ INGCOST*(inflation_2022_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ INGCOST*(inflation_2022_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ INGCOST*(inflation_2022_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ INGCOST*(inflation_2022_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ INGCOST*(inflation_2022_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ INGCOST*(inflation_2022_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ INGCOST*(inflation_2022_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ INGCOST*(inflation_2022_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ INGCOST*(inflation_2022_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ INGCOST*(inflation_2022_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ INGCOST*(inflation_2022_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ INGCOST*(inflation_2022_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ INGCOST*(inflation_2022_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ INGCOST*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ INGCOST*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ INGCOST*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ INGCOST*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ INGCOST*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ INGCOST*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ INGCOST*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ INGCOST*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ INGCOST*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ INGCOST*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ INGCOST*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ INGCOST*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ INGCOST*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ INGCOST*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ INGCOST*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ INGCOST*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ INGCOST*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ INGCOST*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ INGCOST*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ INGCOST*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ INGCOST*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ INGCOST*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ INGCOST*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ INGCOST*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ INGCOST*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ INGCOST*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ INGCOST*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ INGCOST*(inflation_2022_Q4/inflation_2022_Q4)),
    NETPAY = case_when(
  year_quarter == 2006.1 ~ NETPAY*(inflation_2022_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ NETPAY*(inflation_2022_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ NETPAY*(inflation_2022_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ NETPAY*(inflation_2022_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ NETPAY*(inflation_2022_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ NETPAY*(inflation_2022_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ NETPAY*(inflation_2022_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ NETPAY*(inflation_2022_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ NETPAY*(inflation_2022_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ NETPAY*(inflation_2022_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ NETPAY*(inflation_2022_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ NETPAY*(inflation_2022_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ NETPAY*(inflation_2022_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ NETPAY*(inflation_2022_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ NETPAY*(inflation_2022_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ NETPAY*(inflation_2022_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ NETPAY*(inflation_2022_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ NETPAY*(inflation_2022_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ NETPAY*(inflation_2022_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ NETPAY*(inflation_2022_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ NETPAY*(inflation_2022_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ NETPAY*(inflation_2022_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ NETPAY*(inflation_2022_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ NETPAY*(inflation_2022_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ NETPAY*(inflation_2022_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ NETPAY*(inflation_2022_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ NETPAY*(inflation_2022_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ NETPAY*(inflation_2022_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ NETPAY*(inflation_2022_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ NETPAY*(inflation_2022_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ NETPAY*(inflation_2022_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ NETPAY*(inflation_2022_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ NETPAY*(inflation_2022_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ NETPAY*(inflation_2022_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ NETPAY*(inflation_2022_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ NETPAY*(inflation_2022_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ NETPAY*(inflation_2022_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ NETPAY*(inflation_2022_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ NETPAY*(inflation_2022_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ NETPAY*(inflation_2022_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ NETPAY*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ NETPAY*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ NETPAY*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ NETPAY*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ NETPAY*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ NETPAY*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ NETPAY*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ NETPAY*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ NETPAY*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ NETPAY*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ NETPAY*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ NETPAY*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ NETPAY*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ NETPAY*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ NETPAY*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ NETPAY*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ NETPAY*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ NETPAY*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ NETPAY*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ NETPAY*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ NETPAY*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ NETPAY*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ NETPAY*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ NETPAY*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ NETPAY*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ NETPAY*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ NETPAY*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ NETPAY*(inflation_2022_Q4/inflation_2022_Q4)),
    PAY = case_when(
  year_quarter == 2006.1 ~ PAY*(inflation_2022_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ PAY*(inflation_2022_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ PAY*(inflation_2022_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ PAY*(inflation_2022_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ PAY*(inflation_2022_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ PAY*(inflation_2022_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ PAY*(inflation_2022_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ PAY*(inflation_2022_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ PAY*(inflation_2022_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ PAY*(inflation_2022_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ PAY*(inflation_2022_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ PAY*(inflation_2022_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ PAY*(inflation_2022_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ PAY*(inflation_2022_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ PAY*(inflation_2022_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ PAY*(inflation_2022_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ PAY*(inflation_2022_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ PAY*(inflation_2022_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ PAY*(inflation_2022_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ PAY*(inflation_2022_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ PAY*(inflation_2022_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ PAY*(inflation_2022_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ PAY*(inflation_2022_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ PAY*(inflation_2022_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ PAY*(inflation_2022_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ PAY*(inflation_2022_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ PAY*(inflation_2022_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ PAY*(inflation_2022_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ PAY*(inflation_2022_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ PAY*(inflation_2022_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ PAY*(inflation_2022_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ PAY*(inflation_2022_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ PAY*(inflation_2022_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ PAY*(inflation_2022_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ PAY*(inflation_2022_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ PAY*(inflation_2022_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ PAY*(inflation_2022_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ PAY*(inflation_2022_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ PAY*(inflation_2022_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ PAY*(inflation_2022_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ PAY*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ PAY*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ PAY*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ PAY*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ PAY*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ PAY*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ PAY*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ PAY*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ PAY*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ PAY*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ PAY*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ PAY*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ PAY*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ PAY*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ PAY*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ PAY*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ PAY*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ PAY*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ PAY*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ PAY*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ PAY*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ PAY*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ PAY*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ PAY*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ PAY*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ PAY*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ PAY*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ PAY*(inflation_2022_Q4/inflation_2022_Q4)),  
    SALETAX = case_when(
  year_quarter == 2006.1 ~ SALETAX*(inflation_2022_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ SALETAX*(inflation_2022_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ SALETAX*(inflation_2022_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ SALETAX*(inflation_2022_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ SALETAX*(inflation_2022_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ SALETAX*(inflation_2022_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ SALETAX*(inflation_2022_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ SALETAX*(inflation_2022_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ SALETAX*(inflation_2022_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ SALETAX*(inflation_2022_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ SALETAX*(inflation_2022_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ SALETAX*(inflation_2022_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ SALETAX*(inflation_2022_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ SALETAX*(inflation_2022_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ SALETAX*(inflation_2022_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ SALETAX*(inflation_2022_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ SALETAX*(inflation_2022_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ SALETAX*(inflation_2022_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ SALETAX*(inflation_2022_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ SALETAX*(inflation_2022_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ SALETAX*(inflation_2022_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ SALETAX*(inflation_2022_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ SALETAX*(inflation_2022_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ SALETAX*(inflation_2022_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ SALETAX*(inflation_2022_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ SALETAX*(inflation_2022_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ SALETAX*(inflation_2022_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ SALETAX*(inflation_2022_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ SALETAX*(inflation_2022_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ SALETAX*(inflation_2022_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ SALETAX*(inflation_2022_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ SALETAX*(inflation_2022_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ SALETAX*(inflation_2022_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ SALETAX*(inflation_2022_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ SALETAX*(inflation_2022_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ SALETAX*(inflation_2022_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ SALETAX*(inflation_2022_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ SALETAX*(inflation_2022_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ SALETAX*(inflation_2022_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ SALETAX*(inflation_2022_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ SALETAX*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ SALETAX*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ SALETAX*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ SALETAX*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ SALETAX*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ SALETAX*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ SALETAX*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ SALETAX*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ SALETAX*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ SALETAX*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ SALETAX*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ SALETAX*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ SALETAX*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ SALETAX*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ SALETAX*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ SALETAX*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ SALETAX*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ SALETAX*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ SALETAX*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ SALETAX*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ SALETAX*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ SALETAX*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ SALETAX*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ SALETAX*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ SALETAX*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ SALETAX*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ SALETAX*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ SALETAX*(inflation_2022_Q4/inflation_2022_Q4))    
  ) %>% 
    collect()
inflation_adjusted_rescue_medication_epilepsy
```




Extract information for demographics
```{r}
# Extract information from demographics 
#################################2006#################################
demographics_2006 <- ms_t_2006 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  collect()

#################################2007#################################
demographics_2007 <- ms_t_2007 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  collect()

#################################2008#################################
demographics_2008 <- ms_t_2008 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  collect()

#################################2009#################################
demographics_2009 <- ms_t_2009 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  collect()

#################################2010#################################
demographics_2010 <- ms_t_2010 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS), as.numeric)) %>%
  collect()

#################################2011#################################
demographics_2011 <- ms_t_2011 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  collect()

#################################2012#################################
demographics_2012 <- ms_t_2012 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  collect()

#################################2013#################################
demographics_2013 <- ms_t_2013 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  collect()

#################################2014#################################
demographics_2014 <- ms_t_2014 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  collect()

#################################2015#################################
demographics_2015 <- ms_t_2015 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  collect()

#################################2016#################################
demographics_2016 <- ms_t_2016 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  collect()

#################################2017#################################
demographics_2017 <- ms_t_2017 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  collect()

#################################2018#################################
demographics_2018 <- ms_t_2018 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  collect()

#################################2019#################################
demographics_2019 <- ms_t_2019 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  collect()

#################################2020#################################
demographics_2020 <- ms_t_2020 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  collect()

#################################2021#################################
demographics_2021 <- ms_t_2021 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  collect()

#################################2022#################################
demographics_2022 <- ms_t_2022 %>% 
  filter(ENROLID %in% !!patients_with_epilepsy_and_ASM_no_gaps$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  collect()


# Add demographic data to the database
demographics <- bind_rows(demographics_2006, demographics_2007, demographics_2008, demographics_2009, demographics_2010, demographics_2011, demographics_2012, demographics_2013, demographics_2014, demographics_2015, demographics_2016, demographics_2017, demographics_2018, demographics_2019, demographics_2020, demographics_2021, demographics_2022) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  distinct(ENROLID, .keep_all=TRUE) %>% 
  left_join(patients_with_epilepsy_and_ASM_no_gaps, by=c("ENROLID", "DOBYR")) %>% 
  arrange(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  mutate(age_first_ASM_prescription = first(year(SVCDATE) - DOBYR)) %>% 
  ungroup() %>%
  mutate(year_ASM=year(SVCDATE)) %>% 
  collect()




# Division into pediatric onset epilepsy (<= 18 years at first ASM prescription) and adult onset epilepsy
pediatric <- demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  filter(age_first_ASM_prescription<=18) %>% 
  collect()

demographics <- demographics %>% 
  mutate(pediatric_or_adult = case_when(
    ENROLID %in% !!pediatric$ENROLID ~ "pediatric",
    TRUE ~ "adult"
  )) %>% 
  collect()




# Create variable age groups
demographics <- demographics %>% 
  mutate(age_groups = case_when(
    (age_first_ASM_prescription <= 5) ~ "0-5 years",
    (age_first_ASM_prescription > 5 & age_first_ASM_prescription <= 12) ~ "6-12 years",
    (age_first_ASM_prescription > 12 & age_first_ASM_prescription <= 21) ~ "13-21 years",
    (age_first_ASM_prescription > 21 & age_first_ASM_prescription <= 35) ~ "22-35 years",
    (age_first_ASM_prescription > 35 & age_first_ASM_prescription <= 50) ~ "36-50 years",
    age_first_ASM_prescription > 50 ~ ">50 years",
    TRUE ~ "no data"
  )) %>% 
  collect()




# Create variable refractory epilepsy
demographics <- demographics %>% 
  mutate(refractory_epilepsy_case = case_when(
    ENROLID %in% !!refractory_epilepsy$ENROLID ~ "refractory",
    TRUE ~ "non-refractory"
  )) %>% 
  collect()




# Incorporate variables on inpatient or emergency department epilepsy encounter
demographics <- demographics %>%
  left_join(epilepsy_encounters_data, by="ENROLID") %>% 
  mutate(total_epilepsy_encounters =
           case_when(
             is.na(total_epilepsy_encounters) ~ 0,
             TRUE ~ total_epilepsy_encounters
           )) %>% 
  mutate(total_epilepsy_encounters_categorical = factor(
           case_when(
             total_epilepsy_encounters==0 ~ "0",
             total_epilepsy_encounters>0 & total_epilepsy_encounters<=3 ~ "1-3",                total_epilepsy_encounters>3 ~ ">3"
           ))) %>% 
  collect()




# Create variable person years
demographics <- demographics %>% 
  group_by(ENROLID) %>% 
  arrange(ENROLID, SVCDATE) %>% 
  mutate(person_years = as.numeric(((dplyr::last(SVCDATE) + days(dplyr::last(DAYSUPP))) - dplyr::first(SVCDATE))/ 365.24219)) %>% 
  ungroup() %>% 
  collect() 


# Create variable person years per year
demographics <- demographics %>% 
  group_by(ENROLID, year(SVCDATE)) %>% 
  arrange(ENROLID, SVCDATE) %>% 
  mutate(person_years_per_year = as.numeric(((dplyr::last(SVCDATE) + days(dplyr::last(DAYSUPP))) - dplyr::first(SVCDATE))/ 365.24219)) %>% 
  ungroup() %>% 
  collect() 




# Divide demographics into with and without rescue medication
demographics_with_rescue_medication <- demographics %>% 
  filter(ENROLID %in% !!inflation_adjusted_rescue_medication_epilepsy$ENROLID)

demographics_without_rescue_medication <- demographics %>% 
  filter(!ENROLID %in% !!inflation_adjusted_rescue_medication_epilepsy$ENROLID)
```


  
  
Transform variable for generic rescue medication
```{r}
# Create variable generic binary
inflation_adjusted_rescue_medication_epilepsy <- inflation_adjusted_rescue_medication_epilepsy %>% 
  mutate(generic_binary = case_when(
    GENIND=="1" | GENIND=="2" | GENIND=="3" ~ "brand name",
    GENIND=="4" | GENIND=="5" ~ "generic",
    TRUE ~ "other / no data"
  )) %>% 
  collect()


# Create variable generic
inflation_adjusted_rescue_medication_epilepsy <- inflation_adjusted_rescue_medication_epilepsy %>% 
  mutate(generic = case_when(
    GENIND=="1" ~ "single source brand",
    GENIND=="2" ~ "no longer used",
    GENIND=="3" ~ "brand name, generic available",
    GENIND=="4" ~ "multisource generic",
    GENIND=="5" ~ "single source generic",
    TRUE ~ "other / no data"
  )) %>% 
  collect()
```








## 3. Demographic and clinical features




Demographics
```{r}
# Total patients
total_patients <- demographics %>% 
  distinct(ENROLID) %>% 
  nrow()
total_patients

total_patients_with_rescue_medication <- demographics_with_rescue_medication %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  nrow()
total_patients_with_rescue_medication
total_patients_with_rescue_medication/total_patients

total_patients_without_rescue_medication <- demographics_without_rescue_medication %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  nrow()
total_patients_without_rescue_medication
total_patients_without_rescue_medication/total_patients




# Total person years
total_person_years <- demographics %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  summarize(
    sum_person_years = sum(person_years),
    median_person_years = median(person_years),
    p25_person_years = quantile(person_years, 0.25),
    p75_person_years = quantile(person_years, 0.75),
    mean_person_years = mean(person_years),
    SD_person_years = sd(person_years)
  ) %>% collect()
total_person_years

total_person_years_with_rescue_medication <- demographics_with_rescue_medication %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  summarize(
    sum_person_years = sum(person_years),
    median_person_years = median(person_years),
    p25_person_years = quantile(person_years, 0.25),
    p75_person_years = quantile(person_years, 0.75),
    mean_person_years = mean(person_years),
    SD_person_years = sd(person_years)
  ) %>% collect()
total_person_years_with_rescue_medication

total_person_years_without_rescue_medication <- demographics_without_rescue_medication %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  summarize(
    sum_person_years = sum(person_years),
    median_person_years = median(person_years),
    p25_person_years = quantile(person_years, 0.25),
    p75_person_years = quantile(person_years, 0.75),
    mean_person_years = mean(person_years),
    SD_person_years = sd(person_years)
  ) %>% collect()
total_person_years_without_rescue_medication




# Total pediatric patients
total_pediatric_patients <- demographics %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
    reframe(
    onset = CrossTable(pediatric_or_adult)
  )
  
total_pediatric_patients_with_rescue_medication <- demographics_with_rescue_medication %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
    reframe(
    onset = CrossTable(pediatric_or_adult)
  )

total_pediatric_patients_without_rescue_medication <- demographics_without_rescue_medication %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
    reframe(
    onset = CrossTable(pediatric_or_adult)
  )




# Age groups
age_groups <- demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    age_groups = CrossTable(age_groups)
  )

age_groups_with_rescue_medication <- demographics_with_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    age_groups = CrossTable(age_groups)
  )

age_groups_without_rescue_medication <- demographics_without_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    age_groups = CrossTable(age_groups)
  )




# Age
age <- demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  summarize(
    median_age = median(age_first_ASM_prescription),
    p25_age = quantile(age_first_ASM_prescription, 0.25),
    p75_age = quantile(age_first_ASM_prescription, 0.75),
    mean_age = mean(age_first_ASM_prescription),
    SD_age = sd(age_first_ASM_prescription)
  ) %>% collect()
age

age_with_rescue_medication <- demographics_with_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  summarize(
    median_age = median(age_first_ASM_prescription),
    p25_age = quantile(age_first_ASM_prescription, 0.25),
    p75_age = quantile(age_first_ASM_prescription, 0.75),
    mean_age = mean(age_first_ASM_prescription),
    SD_age = sd(age_first_ASM_prescription)
  ) %>% collect()
age_with_rescue_medication

age_without_rescue_medication <- demographics_without_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  summarize(
    median_age = median(age_first_ASM_prescription),
    p25_age = quantile(age_first_ASM_prescription, 0.25),
    p75_age = quantile(age_first_ASM_prescription, 0.75),
    mean_age = mean(age_first_ASM_prescription),
    SD_age = sd(age_first_ASM_prescription)
  ) %>% collect()
age_without_rescue_medication




# Sex
sex <- demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    sex = CrossTable(SEX)
  )

sex_with_rescue_medication <- demographics_with_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    sex = CrossTable(SEX)
  )

sex_without_rescue_medication <- demographics_without_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    sex = CrossTable(SEX)
  )




# Refractory epilepsy
refractory_epilepsy_cases <- demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    refractory_epilepsy_case = CrossTable(refractory_epilepsy_case)
  )

refractory_epilepsy_cases_with_rescue_medication <- demographics_with_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    refractory_epilepsy_case = CrossTable(refractory_epilepsy_case)
  )

refractory_epilepsy_cases_without_rescue_medication <- demographics_without_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    refractory_epilepsy_case = CrossTable(refractory_epilepsy_case)
  )




# Inpatient or emergency department encounters categorical
IP_ED_encounters_for_epilepsy_categories <- demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    IP_ED_encounters_for_epilepsy_categories = CrossTable(total_epilepsy_encounters_categorical)
  )

IP_ED_encounters_for_epilepsy_categories_with_rescue_medication <- demographics_with_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    IP_ED_encounters_for_epilepsy_categories = CrossTable(total_epilepsy_encounters_categorical)
  )

IP_ED_encounters_for_epilepsy_categories_without_rescue_medication <- demographics_without_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    IP_ED_encounters_for_epilepsy_categories = CrossTable(total_epilepsy_encounters_categorical)
  )




# Inpatient or emergency department encounters for epilepsy
IP_ED_encounters_for_epilepsy <- demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  summarize(
    median_IP_ED_encounters = median(total_epilepsy_encounters),
    p25_IP_ED_encounters = quantile(total_epilepsy_encounters, 0.25),
    p75_IP_ED_encounters = quantile(total_epilepsy_encounters, 0.75),
    mean_IP_ED_encounters = mean(total_epilepsy_encounters),
    SD_IP_ED_encounters = sd(total_epilepsy_encounters)
  ) %>% collect()
IP_ED_encounters_for_epilepsy

IP_ED_encounters_for_epilepsy_with_rescue_medication <- demographics_with_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  summarize(
    median_IP_ED_encounters = median(total_epilepsy_encounters),
    p25_IP_ED_encounters = quantile(total_epilepsy_encounters, 0.25),
    p75_IP_ED_encounters = quantile(total_epilepsy_encounters, 0.75),
    mean_IP_ED_encounters = mean(total_epilepsy_encounters),
    SD_IP_ED_encounters = sd(total_epilepsy_encounters)
  ) %>% collect()
IP_ED_encounters_for_epilepsy_with_rescue_medication

IP_ED_encounters_for_epilepsy_without_rescue_medication <- demographics_without_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  summarize(
    median_IP_ED_encounters = median(total_epilepsy_encounters),
    p25_IP_ED_encounters = quantile(total_epilepsy_encounters, 0.25),
    p75_IP_ED_encounters = quantile(total_epilepsy_encounters, 0.75),
    mean_IP_ED_encounters = mean(total_epilepsy_encounters),
    SD_IP_ED_encounters = sd(total_epilepsy_encounters)
  ) %>% collect()
IP_ED_encounters_for_epilepsy_without_rescue_medication




# Region of patient residence
region <- demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    region = CrossTable(REGION)
  )

region_with_rescue_medication <- demographics_with_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    region = CrossTable(REGION)
  )

region_without_rescue_medication <- demographics_without_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    region = CrossTable(REGION)
  )




# Relationship of the patient to the main beneficiary
relationship_employee <- demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    relationship_employee = CrossTable(EMPREL)
  )

relationship_employee_with_rescue_medication <- demographics_with_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    relationship_employee = CrossTable(EMPREL)
  )

relationship_employee_without_rescue_medication <- demographics_without_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    relationship_employee = CrossTable(EMPREL)
  )




# Working status of the main beneficiary
employment_status <- demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    employment_status = CrossTable(EESTATU)
  )

employment_status_with_rescue_medication <- demographics_with_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    employment_status = CrossTable(EESTATU)
  )

employment_status_without_rescue_medication <- demographics_without_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    employment_status = CrossTable(EESTATU)
  )




# Industry of the main beneficiary
industry <- demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    industry = CrossTable(INDSTRY)
  )

industry_with_rescue_medication <- demographics_with_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    industry = CrossTable(INDSTRY)
  )

industry_without_rescue_medication <- demographics_without_rescue_medication %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  reframe(
    industry = CrossTable(INDSTRY)
  )
```








## 4. Main clinical outocomes




Proportion of patients who had at least one rescue medication
```{r}
# Number of rescue medications
number_rescue_medications_per_patient <- inflation_adjusted_rescue_medication_epilepsy %>% 
  group_by(ENROLID) %>% 
  mutate(total_rescue_medications = n()) %>% 
  ungroup() %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  summarize(
    median_rescue_medications = median(total_rescue_medications),
    p25_total_rescue_medications = quantile(total_rescue_medications, 0.25),
    p75_total_rescue_medications = quantile(total_rescue_medications, 0.75),
    mean_total_rescue_medications = mean(total_rescue_medications),
    SD_total_rescue_medications = sd(total_rescue_medications)
  )
number_rescue_medications_per_patient




# Proportion of patients with rescue medication
proportion_patients_with_rescue_medication <- demographics %>% 
  distinct(ENROLID) %>% 
  mutate(with_rescue_medication = case_when(
    ENROLID %in% !!inflation_adjusted_rescue_medication_epilepsy$ENROLID ~ "rescue_medicaton",
    TRUE ~ "no rescue medication"
  )) %>% 
  reframe(
    with_rescue_medication = CrossTable(with_rescue_medication)
  )

proportion_with_rescue_medication_per_year <- demographics %>% 
  distinct(ENROLID, year_ASM) %>% 
  left_join(inflation_adjusted_rescue_medication_epilepsy, join_by(ENROLID, year_ASM == year_rescue_medication)) %>% 
  rename(year=year_ASM) %>% 
  distinct(ENROLID, year, .keep_all=TRUE) %>% 
  group_by(year) %>% 
  mutate(patients_with_rescue_medication_per_year = sum(!is.na(rescue_medication)),
         total_patients_per_year = n(),
         proportion_patients_with_rescue_medication_per_year = patients_with_rescue_medication_per_year / total_patients_per_year) %>% 
  distinct(year, .keep_all=TRUE) %>% 
  arrange(year) %>% 
  select(year, patients_with_rescue_medication_per_year, total_patients_per_year, proportion_patients_with_rescue_medication_per_year) %>% 
  collect()
proportion_with_rescue_medication_per_year
  



# Jonckheere Terpstra test
jonckheere_proportion_with_rescue_medication_per_year_p_value <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year, alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_p_value


jonckheere_proportion_with_rescue_medication_per_year_p_value_2018_2022 <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year[proportion_with_rescue_medication_per_year$year>=2018, ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_p_value_2018_2022




# Proportion of patients with at least one rescue medication prescription per year figure
proportion_with_rescue_medication_per_year_plot <- ggplot(data=proportion_with_rescue_medication_per_year,
                                aes(x=year, y=proportion_patients_with_rescue_medication_per_year)) + 
  geom_line(lwd=1.5, color="darkgreen") + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.1), limits = c(0, 1))
proportion_with_rescue_medication_per_year_plot


proportion_with_rescue_medication_per_year_plot_detail <- ggplot(data=proportion_with_rescue_medication_per_year,
                                aes(x=year, y=proportion_patients_with_rescue_medication_per_year)) + 
  geom_line(lwd=1.5, color="darkgreen") + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 0.15, 0.025), limits = c(0, 0.15))
proportion_with_rescue_medication_per_year_plot_detail




#################################By age groups#################################
# Proportion of patients with rescue medication
proportion_patients_with_rescue_medication_by_age_groups <- demographics %>% 
  distinct(ENROLID, age_groups) %>% 
  mutate(with_rescue_medication = case_when(
    ENROLID %in% !!inflation_adjusted_rescue_medication_epilepsy$ENROLID ~ "rescue_medicaton",
    TRUE ~ "no rescue medication"
  )) %>% 
  group_by(age_groups) %>%
  mutate(patients_with_rescue_medication_per_age_group = sum(with_rescue_medication=="rescue_medicaton"),
         total_patients_per_age_group = n(),
         proportion_patients_with_rescue_medication_per_age_group = patients_with_rescue_medication_per_age_group / total_patients_per_age_group) %>%
    distinct(age_groups, .keep_all=TRUE) %>% 
    select(patients_with_rescue_medication_per_age_group, total_patients_per_age_group, proportion_patients_with_rescue_medication_per_age_group) %>% 
  collect()
proportion_patients_with_rescue_medication_by_age_groups

proportion_with_rescue_medication_per_year_by_age_groups <- demographics %>% 
  distinct(ENROLID, year_ASM, age_groups) %>% 
  left_join(inflation_adjusted_rescue_medication_epilepsy, join_by(ENROLID, year_ASM == year_rescue_medication)) %>% 
  rename(year=year_ASM) %>% 
  distinct(ENROLID, year, .keep_all=TRUE) %>% 
  group_by(year, age_groups) %>% 
  mutate(patients_with_rescue_medication_per_year = sum(!is.na(rescue_medication)),
         total_patients_per_year = n(),
         proportion_patients_with_rescue_medication_per_year = patients_with_rescue_medication_per_year / total_patients_per_year) %>% 
  distinct(year, .keep_all=TRUE) %>% 
  arrange(year, age_groups) %>% 
  select(year, patients_with_rescue_medication_per_year, total_patients_per_year, proportion_patients_with_rescue_medication_per_year) %>% 
  collect()
proportion_with_rescue_medication_per_year_by_age_groups




# Jonckheere Terpstra test
jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_0_5_y_p_value <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_age_groups[proportion_with_rescue_medication_per_year_by_age_groups$age_groups=="0-5 years", ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_0_5_y_p_value


jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_0_5_y_p_value_2018_2022 <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_age_groups[proportion_with_rescue_medication_per_year_by_age_groups$age_groups=="0-5 years" & proportion_with_rescue_medication_per_year_by_age_groups$year>=2018, ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_0_5_y_p_value_2018_2022




jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_6_12_y_p_value <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_age_groups[proportion_with_rescue_medication_per_year_by_age_groups$age_groups=="6-12 years", ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_6_12_y_p_value


jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_6_12_y_p_value_2018_2022 <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_age_groups[proportion_with_rescue_medication_per_year_by_age_groups$age_groups=="6-12 years" & proportion_with_rescue_medication_per_year_by_age_groups$year>=2018, ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_6_12_y_p_value_2018_2022




jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_13_21_y_p_value <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_age_groups[proportion_with_rescue_medication_per_year_by_age_groups$age_groups=="13-21 years", ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_13_21_y_p_value


jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_13_21_y_p_value_2018_2022 <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_age_groups[proportion_with_rescue_medication_per_year_by_age_groups$age_groups=="13-21 years" & proportion_with_rescue_medication_per_year_by_age_groups$year>=2018, ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_13_21_y_p_value_2018_2022




jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_22_35_y_p_value <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_age_groups[proportion_with_rescue_medication_per_year_by_age_groups$age_groups=="22-35 years", ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_22_35_y_p_value


jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_22_35_y_p_value_2018_2022 <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_age_groups[proportion_with_rescue_medication_per_year_by_age_groups$age_groups=="22-35 years" & proportion_with_rescue_medication_per_year_by_age_groups$year>=2018, ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_22_35_y_p_value_2018_2022




jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_36_50_y_p_value <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_age_groups[proportion_with_rescue_medication_per_year_by_age_groups$age_groups=="36-50 years", ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_36_50_y_p_value


jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_36_50_y_p_value_2018_2022 <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_age_groups[proportion_with_rescue_medication_per_year_by_age_groups$age_groups=="36-50 years" & proportion_with_rescue_medication_per_year_by_age_groups$year>=2018, ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_36_50_y_p_value_2018_2022




jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_more_than_50_y_p_value <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_age_groups[proportion_with_rescue_medication_per_year_by_age_groups$age_groups==">50 years", ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_more_than_50_y_p_value


jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_more_than_50_y_p_value_2018_2022 <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_age_groups[proportion_with_rescue_medication_per_year_by_age_groups$age_groups==">50 years" & proportion_with_rescue_medication_per_year_by_age_groups$year>=2018, ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_more_than_50_y_p_value_2018_2022




# Proportion of patients with at least one rescue medication prescription per year by age groups figure
proportion_with_rescue_medication_per_year_by_age_groups_plot <- ggplot(data=proportion_with_rescue_medication_per_year_by_age_groups,
                                aes(x=year, y=proportion_patients_with_rescue_medication_per_year, color=age_groups)) + 
  scale_color_manual(values = c("0-5 years" = "aquamarine4",
                                "6-12 years"="deeppink",
                                "13-21 years"="navyblue",
                                "22-35 years"="darkorange2",
                                "36-50 years"="green",
                                "51-65 years"="grey28")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.1), limits = c(0, 1))
proportion_with_rescue_medication_per_year_by_age_groups_plot


proportion_with_rescue_medication_per_year_by_age_groups_plot_detail <- ggplot(data=proportion_with_rescue_medication_per_year_by_age_groups,
                                aes(x=year, y=proportion_patients_with_rescue_medication_per_year, color=age_groups)) + 
  scale_color_manual(values = c("0-5 years" = "aquamarine4",
                                "6-12 years"="deeppink",
                                "13-21 years"="navyblue",
                                "22-35 years"="darkorange2",
                                "36-50 years"="green",
                                "51-65 years"="grey28")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 5, 0.1), limits = c(0, 0.5))
proportion_with_rescue_medication_per_year_by_age_groups_plot_detail




#################################By refractory epilepsy#################################
# Proportion of patients with rescue medication
proportion_patients_with_rescue_medication_by_refractory_epilepsy <- demographics %>% 
  distinct(ENROLID, refractory_epilepsy_case) %>% 
  mutate(with_rescue_medication = case_when(
    ENROLID %in% !!inflation_adjusted_rescue_medication_epilepsy$ENROLID ~ "rescue_medicaton",
    TRUE ~ "no rescue medication"
  )) %>% 
  group_by(refractory_epilepsy_case) %>%
  mutate(patients_with_rescue_medication_per_refractory_epilepsy = sum(with_rescue_medication=="rescue_medicaton"),
         total_patients_per_refractory_epilepsy = n(),
         proportion_patients_with_rescue_medication_per_refractory_epilepsy = patients_with_rescue_medication_per_refractory_epilepsy / total_patients_per_refractory_epilepsy) %>%
    distinct(refractory_epilepsy_case, .keep_all=TRUE) %>% 
    select(patients_with_rescue_medication_per_refractory_epilepsy, total_patients_per_refractory_epilepsy, proportion_patients_with_rescue_medication_per_refractory_epilepsy) %>% 
  collect()
proportion_patients_with_rescue_medication_by_refractory_epilepsy

proportion_with_rescue_medication_per_year_by_refractory_epilepsy <- demographics %>% 
  distinct(ENROLID, year_ASM, refractory_epilepsy_case) %>% 
  left_join(inflation_adjusted_rescue_medication_epilepsy, join_by(ENROLID, year_ASM == year_rescue_medication)) %>% 
  rename(year=year_ASM) %>% 
  distinct(ENROLID, year, .keep_all=TRUE) %>% 
  group_by(year, refractory_epilepsy_case) %>% 
  mutate(patients_with_rescue_medication_per_year = sum(!is.na(rescue_medication)),
         total_patients_per_year = n(),
         proportion_patients_with_rescue_medication_per_year = patients_with_rescue_medication_per_year / total_patients_per_year) %>% 
  distinct(year, .keep_all=TRUE) %>% 
  arrange(year, refractory_epilepsy_case) %>% 
  select(year, patients_with_rescue_medication_per_year, total_patients_per_year, proportion_patients_with_rescue_medication_per_year) %>% 
  collect()
proportion_with_rescue_medication_per_year_by_refractory_epilepsy




# Jonckheere Terpstra test
jonckheere_proportion_with_rescue_medication_per_year_by_refractory_epilepsy_refractory_p_value <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_refractory_epilepsy[proportion_with_rescue_medication_per_year_by_refractory_epilepsy$refractory_epilepsy_case=="refractory", ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_refractory_epilepsy_refractory_p_value


jonckheere_proportion_with_rescue_medication_per_year_by_refractory_epilepsy_refractory_p_value_2018_2022 <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_refractory_epilepsy[proportion_with_rescue_medication_per_year_by_refractory_epilepsy$refractory_epilepsy_case=="refractory" & proportion_with_rescue_medication_per_year_by_refractory_epilepsy$year>=2018, ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_refractory_epilepsy_refractory_p_value_2018_2022




jonckheere_proportion_with_rescue_medication_per_year_by_refractory_epilepsy_nonrefractory_p_value <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_refractory_epilepsy[proportion_with_rescue_medication_per_year_by_refractory_epilepsy$refractory_epilepsy_case=="non-refractory", ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_refractory_epilepsy_nonrefractory_p_value


jonckheere_proportion_with_rescue_medication_per_year_by_refractory_epilepsy_nonrefractory_p_value_2018_2022 <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_refractory_epilepsy[proportion_with_rescue_medication_per_year_by_refractory_epilepsy$refractory_epilepsy_case=="non-refractory" & proportion_with_rescue_medication_per_year_by_refractory_epilepsy$year>=2018, ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_refractory_epilepsy_nonrefractory_p_value_2018_2022




# Proportion of patients with at least one rescue medication prescription per year by refractory epilepsy figure
proportion_with_rescue_medication_per_year_by_refractory_epilepsy_plot <- ggplot(data=proportion_with_rescue_medication_per_year_by_refractory_epilepsy,
                                aes(x=year, y=proportion_patients_with_rescue_medication_per_year, color=refractory_epilepsy_case)) + 
  scale_color_manual(values = c("refractory" = "dodgerblue",
                                "non-refractory"="salmon4")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.1), limits = c(0, 1))
proportion_with_rescue_medication_per_year_by_refractory_epilepsy_plot


proportion_with_rescue_medication_per_year_by_refractory_epilepsy_plot_detail <- ggplot(data=proportion_with_rescue_medication_per_year_by_refractory_epilepsy,
                                aes(x=year, y=proportion_patients_with_rescue_medication_per_year, color=refractory_epilepsy_case)) + 
  scale_color_manual(values = c("refractory" = "dodgerblue",
                                "non-refractory"="salmon4")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 0.3, 0.1), limits = c(0, 0.3))
proportion_with_rescue_medication_per_year_by_refractory_epilepsy_plot_detail




#################################By epilepsy inpatient or emergency department visits#################################
# Proportion of patients with rescue medication
proportion_patients_with_rescue_medication_by_IP_ED_epilepsy_visits <- demographics %>% 
  distinct(ENROLID, total_epilepsy_encounters_categorical) %>% 
  mutate(with_rescue_medication = case_when(
    ENROLID %in% !!inflation_adjusted_rescue_medication_epilepsy$ENROLID ~ "rescue_medicaton",
    TRUE ~ "no rescue medication"
  )) %>% 
  group_by(total_epilepsy_encounters_categorical) %>%
  mutate(patients_with_rescue_medication_per_IP_ED_epilepsy_visits = sum(with_rescue_medication=="rescue_medicaton"),
         total_patients_per_IP_ED_epilepsy_visits = n(),
         proportion_patients_with_rescue_medication_per_IP_ED_epilepsy_visits = patients_with_rescue_medication_per_IP_ED_epilepsy_visits / total_patients_per_IP_ED_epilepsy_visits) %>%
    distinct(total_epilepsy_encounters_categorical, .keep_all=TRUE) %>% 
    select(patients_with_rescue_medication_per_IP_ED_epilepsy_visits, total_patients_per_IP_ED_epilepsy_visits, proportion_patients_with_rescue_medication_per_IP_ED_epilepsy_visits) %>% 
  collect()
proportion_patients_with_rescue_medication_by_IP_ED_epilepsy_visits

proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits <- demographics %>% 
  distinct(ENROLID, year_ASM, total_epilepsy_encounters_categorical) %>% 
  left_join(inflation_adjusted_rescue_medication_epilepsy, join_by(ENROLID, year_ASM == year_rescue_medication)) %>% 
  rename(year=year_ASM) %>% 
  distinct(ENROLID, year, .keep_all=TRUE) %>% 
  group_by(year, total_epilepsy_encounters_categorical) %>% 
  mutate(patients_with_rescue_medication_per_year = sum(!is.na(rescue_medication)),
         total_patients_per_year = n(),
         proportion_patients_with_rescue_medication_per_year = patients_with_rescue_medication_per_year / total_patients_per_year) %>% 
  distinct(year, .keep_all=TRUE) %>% 
  arrange(year, total_epilepsy_encounters_categorical) %>% 
  select(year, patients_with_rescue_medication_per_year, total_patients_per_year, proportion_patients_with_rescue_medication_per_year) %>% 
  collect()
proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits




# Jonckheere Terpstra test
jonckheere_proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_0_p_value <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits[proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits$total_epilepsy_encounters_categorical=="0", ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_0_p_value


jonckheere_proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_0_p_value_2018_2022 <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits[proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits$total_epilepsy_encounters_categorical=="0" & proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits$year>=2018, ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_0_p_value_2018_2022




jonckheere_proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_1_3_p_value <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits[proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits$total_epilepsy_encounters_categorical=="1-3", ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_1_3_p_value


jonckheere_proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_1_3_p_value_2018_2022 <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits[proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits$total_epilepsy_encounters_categorical=="1-3" & proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits$year>=2018, ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_1_3_p_value_2018_2022




jonckheere_proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_more_than_3_p_value <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits[proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits$total_epilepsy_encounters_categorical==">3", ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_more_than_3_p_value


jonckheere_proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_more_than_3_p_value_2018_2022 <- JonckheereTerpstraTest(proportion_patients_with_rescue_medication_per_year ~ year, data=proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits[proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits$total_epilepsy_encounters_categorical==">3" & proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits$year>=2018, ], alternative="increasing")$p.value
jonckheere_proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_more_than_3_p_value_2018_2022




# Proportion of patients with at least one rescue medication prescription per year by emergency department visit or hospital admission figure
proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_plot <- ggplot(data=proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits,
                                aes(x=year, y=proportion_patients_with_rescue_medication_per_year, color=total_epilepsy_encounters_categorical)) + 
  scale_color_manual(values = c("0" = "cyan2",
                                "1-3"="yellow1",
                                ">3"="brown2")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.1), limits = c(0, 1))
proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_plot


proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_plot_detail <- ggplot(data=proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits,
                                aes(x=year, y=proportion_patients_with_rescue_medication_per_year, color=total_epilepsy_encounters_categorical)) + 
  scale_color_manual(values = c("0" = "cyan2",
                                "1-3"="yellow1",
                                ">3"="brown2")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 0.3, 0.05), limits = c(0, 0.3))
proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_plot_detail
```




Time from diagnosis to rescue medication and time from ED or IP epilepsy visit to rescue medication
```{r}
# Rescue medication prescription after epilepsy diagnosis
epilepsy_first_diagnosis <- epilepsy %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  rename(date_first_diagnosis=SVCDATE) %>% 
  collect()
  
rescue_prescriptions_after_epilepsy_first_diagnosis <- inflation_adjusted_rescue_medication_epilepsy %>% 
  arrange(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(time_to_rescue_prescription = as.numeric(SVCDATE - date_first_diagnosis)) %>% 
  mutate(prescription_just_after_diagnosis = case_when(
    ( (time_to_rescue_prescription < 30) & (time_to_rescue_prescription >= 0) ) ~ 1,
    TRUE ~ 0)
    ) %>% 
  group_by(ENROLID) %>% 
  mutate(post_diagnosis_rescue = case_when(
    sum(prescription_just_after_diagnosis) > 0 ~ "yes",
    TRUE ~ "no")
           ) %>% 
  ungroup() %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, post_diagnosis_rescue) %>% 
  collect()

rescue_post_diagnosis <- rescue_prescriptions_after_epilepsy_first_diagnosis %>% 
  reframe(
    post_diagnosis_prescription = CrossTable(post_diagnosis_rescue)
  )




# Rescue medication prescription after epilepsy visit (not including initial epilepsy diagnosis)
rescue_prescriptions_after_epilepsy_IP_ED_encounter <- inflation_adjusted_rescue_medication_epilepsy %>% 
  arrange(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  left_join(rescue_prescriptions_after_epilepsy_first_diagnosis, by="ENROLID") %>% 
  filter(post_diagnosis_rescue=="no") %>% 
  left_join(all_epilepsy_encounters_data, by="ENROLID") %>% 
  mutate(time_to_rescue_prescription = as.numeric(SVCDATE - encounter_date)) %>% 
  mutate(prescription_just_after_encounter = case_when(
    ( (time_to_rescue_prescription < 30) & (time_to_rescue_prescription >= 0) ) ~ 1,
    TRUE ~ 0)
    ) %>% 
  group_by(ENROLID) %>% 
  mutate(post_encounter_rescue = case_when(
    sum(prescription_just_after_encounter) > 0 ~ "yes",
    TRUE ~ "no")
           ) %>% 
  ungroup() %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, post_encounter_rescue) %>% 
  collect()

rescue_post_epilepsy_encounter <- rescue_prescriptions_after_epilepsy_IP_ED_encounter %>% 
  reframe(
    post_encounter_prescription = CrossTable(post_encounter_rescue)
  )
```




Logistic regression
```{r}
# Prepare data for regression
logistic_regression_database <- demographics %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  mutate(age_groups = as.factor(age_groups)) %>% 
  mutate(
    age_0_5_y = case_when(
      age_groups=="0-5 years" ~ 1,
      TRUE ~ 0),
    age_6_12_y = case_when(
      age_groups=="6-12 years" ~ 1,
      TRUE ~ 0),
    age_13_21_y = case_when(
      age_groups=="13-21 years" ~ 1,
      TRUE ~ 0),
    age_22_35_y = case_when(
      age_groups=="22-35 years" ~ 1,
      TRUE ~ 0),
    age_36_50_y = case_when(
      age_groups=="36-50 years" ~ 1,
      TRUE ~ 0),
    male = case_when(
      SEX==1 ~ 1,
      TRUE ~ 0),
    refractory = case_when(
      refractory_epilepsy_case=="refractory" ~ 1,
      TRUE ~ 0),
    ED_IP_1_3 = case_when(
      total_epilepsy_encounters_categorical=="1-3" ~ 1,
      TRUE ~ 0),    
    ED_IP_more_than_3 = case_when(
      total_epilepsy_encounters_categorical==">3" ~ 1,
      TRUE ~ 0),     
    north_east = case_when(
      REGION==1 ~ 1,
      TRUE ~ 0),
    north_central = case_when(
      REGION==2 ~ 1,
      TRUE ~ 0),
    south = case_when(
      REGION==3 ~ 1,
      TRUE ~ 0),    
    other_region = case_when(
      REGION==5 ~ 1,
      TRUE ~ 0),
    full_time = case_when(
      EESTATU==1 ~ 1,
      TRUE ~ 0)
  ) %>% 
  select(ENROLID, age_groups, age_0_5_y, age_6_12_y, age_13_21_y, age_22_35_y, age_36_50_y, male, refractory, ED_IP_1_3, ED_IP_more_than_3, north_east, north_central, south, other_region, full_time) %>% 
  mutate(rescue = case_when(
    ENROLID %in% !!inflation_adjusted_rescue_medication_epilepsy$ENROLID ~ 1,
    TRUE ~ 0)
    ) %>% 
  select(ENROLID, rescue, age_groups, age_0_5_y, age_6_12_y, age_13_21_y, age_22_35_y, age_36_50_y, male, refractory, ED_IP_1_3, ED_IP_more_than_3, north_east, north_central, south, other_region, full_time) %>% 
  collect()




# Logistic regression
rescue_medication_logistic_regression <- glm(rescue ~ relevel(age_groups, ref="13-21 years") + male + refractory + ED_IP_1_3 + ED_IP_more_than_3 + north_east + north_central + south + other_region + full_time, data=logistic_regression_database, family="binomial")

summary(rescue_medication_logistic_regression)

exp(coef(rescue_medication_logistic_regression))

exp(confint.default(rescue_medication_logistic_regression))

rescue_medication_logistic_regression_age_0_5_y_p_value <- summary(rescue_medication_logistic_regression, digits=1000)$coefficients[2, 4]

rescue_medication_logistic_regression_age_6_12_y_p_value <- summary(rescue_medication_logistic_regression, digits=1000)$coefficients[3, 4]

rescue_medication_logistic_regression_age_13_21_y_p_value <- summary(rescue_medication_logistic_regression, digits=1000)$coefficients[4, 4]

rescue_medication_logistic_regression_age_22_35_y_p_value <- summary(rescue_medication_logistic_regression, digits=1000)$coefficients[5, 4]

rescue_medication_logistic_regression_age_36_50_y_p_value <- summary(rescue_medication_logistic_regression, digits=1000)$coefficients[6, 4]

rescue_medication_logistic_regression_male_p_value <- summary(rescue_medication_logistic_regression, digits=1000)$coefficients[7, 4]

rescue_medication_logistic_regression_refractory_p_value <- summary(rescue_medication_logistic_regression, digits=1000)$coefficients[8, 4]

rescue_medication_logistic_regression_ED_IP_1_3_p_value <- summary(rescue_medication_logistic_regression, digits=1000)$coefficients[9, 4]

rescue_medication_logistic_regression_ED_IP_more_than_3_p_value <- summary(rescue_medication_logistic_regression, digits=1000)$coefficients[10, 4]

rescue_medication_logistic_regression_north_east_p_value <- summary(rescue_medication_logistic_regression, digits=1000)$coefficients[11, 4]

rescue_medication_logistic_regression_north_central_p_value <- summary(rescue_medication_logistic_regression, digits=1000)$coefficients[12, 4]

rescue_medication_logistic_regression_south_p_value <- summary(rescue_medication_logistic_regression, digits=1000)$coefficients[13, 4]

rescue_medication_logistic_regression_other_region_p_value <- summary(rescue_medication_logistic_regression, digits=1000)$coefficients[14, 4]

rescue_medication_logistic_regression_full_time_p_value <- summary(rescue_medication_logistic_regression, digits=1000)$coefficients[15, 4]
```




Rescue medication type
```{r}
# Use of rescue medication per year
rescue_medication_use_per_year  <- inflation_adjusted_rescue_medication_epilepsy %>% 
  group_by(year(SVCDATE)) %>% 
  mutate(total_rescue_medication_prescriptions_per_year = n()) %>% 
  ungroup() %>% 
  group_by(year(SVCDATE), rescue_medication) %>% 
  summarize(
    proportion_use_per_year = n() / total_rescue_medication_prescriptions_per_year
  ) %>% 
  distinct(`year(SVCDATE)`, rescue_medication, .keep_all=TRUE) %>% 
  ungroup() %>% 
  group_by(`year(SVCDATE)`) %>% 
  arrange(desc(proportion_use_per_year), .by_group=TRUE) %>% 
  collect()
rescue_medication_use_per_year




# Use of rescue medication per year figure
rescue_medication_use_per_year_plot <- ggplot(data=rescue_medication_use_per_year,
                                aes(x=`year(SVCDATE)`, y=proportion_use_per_year, color=rescue_medication)) + 
  scale_color_manual(values = c("rectal diazepam" = "red",
                                "intranasal midazolam"="purple4",
                                "intranasal diazepam"="greenyellow")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0, 1))
rescue_medication_use_per_year_plot




#################################By age groups#################################
# Use of rescue medication per year
demographics_age_groups <- demographics[ , c("ENROLID", "age_groups")] %>% 
  distinct(ENROLID, age_groups) %>% 
  collect()

rescue_medication_use_per_year_by_age_groups  <- inflation_adjusted_rescue_medication_epilepsy %>% 
  left_join(demographics_age_groups, by="ENROLID") %>% 
  filter(!is.na(age_groups)) %>% 
  group_by(year(SVCDATE), age_groups) %>% 
  mutate(total_rescue_medication_prescriptions_per_year = n()) %>% 
  ungroup() %>% 
  group_by(year(SVCDATE), age_groups, rescue_medication) %>% 
  summarize(
    proportion_use_per_year = n() / total_rescue_medication_prescriptions_per_year
  ) %>% 
  distinct(`year(SVCDATE)`, age_groups, rescue_medication, .keep_all=TRUE) %>% 
  ungroup() %>% 
  group_by(`year(SVCDATE)`, age_groups) %>% 
  arrange(desc(proportion_use_per_year), .by_group=TRUE) %>% 
  collect()
rescue_medication_use_per_year_by_age_groups




# Use of rescue medication per year figure
rescue_medication_use_per_year_by_age_group_0_5_years_plot <- ggplot(data=rescue_medication_use_per_year_by_age_groups[rescue_medication_use_per_year_by_age_groups$age_groups=="0-5 years", ],
                                aes(x=`year(SVCDATE)`, y=proportion_use_per_year, color=rescue_medication)) + 
  scale_color_manual(values = c("rectal diazepam" = "red",
                                "intranasal midazolam"="purple4",
                                "intranasal diazepam"="greenyellow")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0, 1))
rescue_medication_use_per_year_by_age_group_0_5_years_plot




rescue_medication_use_per_year_by_age_group_6_12_years_plot <- ggplot(data=rescue_medication_use_per_year_by_age_groups[rescue_medication_use_per_year_by_age_groups$age_groups=="6-12 years", ],
                                aes(x=`year(SVCDATE)`, y=proportion_use_per_year, color=rescue_medication)) + 
  scale_color_manual(values = c("rectal diazepam" = "red",
                                "intranasal midazolam"="purple4",
                                "intranasal diazepam"="greenyellow")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0, 1))
rescue_medication_use_per_year_by_age_group_6_12_years_plot




rescue_medication_use_per_year_by_age_group_13_21_years_plot <- ggplot(data=rescue_medication_use_per_year_by_age_groups[rescue_medication_use_per_year_by_age_groups$age_groups=="13-21 years", ],
                                aes(x=`year(SVCDATE)`, y=proportion_use_per_year, color=rescue_medication)) + 
  scale_color_manual(values = c("rectal diazepam" = "red",
                                "intranasal midazolam"="purple4",
                                "intranasal diazepam"="greenyellow")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0, 1))
rescue_medication_use_per_year_by_age_group_13_21_years_plot




rescue_medication_use_per_year_by_age_group_22_35_years_plot <- ggplot(data=rescue_medication_use_per_year_by_age_groups[rescue_medication_use_per_year_by_age_groups$age_groups=="22-35 years", ],
                                aes(x=`year(SVCDATE)`, y=proportion_use_per_year, color=rescue_medication)) + 
  scale_color_manual(values = c("rectal diazepam" = "red",
                                "intranasal midazolam"="purple4",
                                "intranasal diazepam"="greenyellow")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0, 1))
rescue_medication_use_per_year_by_age_group_22_35_years_plot




rescue_medication_use_per_year_by_age_group_36_50_years_plot <- ggplot(data=rescue_medication_use_per_year_by_age_groups[rescue_medication_use_per_year_by_age_groups$age_groups=="36-50 years", ],
                                aes(x=`year(SVCDATE)`, y=proportion_use_per_year, color=rescue_medication)) + 
  scale_color_manual(values = c("rectal diazepam" = "red",
                                "intranasal midazolam"="purple4",
                                "intranasal diazepam"="greenyellow")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0, 1))
rescue_medication_use_per_year_by_age_group_36_50_years_plot




rescue_medication_use_per_year_by_age_group_above_50_years_plot <- ggplot(data=rescue_medication_use_per_year_by_age_groups[rescue_medication_use_per_year_by_age_groups$age_groups==">50 years", ],
                                aes(x=`year(SVCDATE)`, y=proportion_use_per_year, color=rescue_medication)) + 
  scale_color_manual(values = c("rectal diazepam" = "red",
                                "intranasal midazolam"="purple4",
                                "intranasal diazepam"="greenyellow")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0, 1))
rescue_medication_use_per_year_by_age_group_above_50_years_plot




#################################By refractory epilepsy#################################
# Use of rescue medication per year
demographics_refractory_epilepsy <- demographics[ , c("ENROLID", "refractory_epilepsy_case")] %>% 
  distinct(ENROLID, refractory_epilepsy_case) %>% 
  collect()

rescue_medication_use_per_year_by_refractory_epilepsy  <- inflation_adjusted_rescue_medication_epilepsy %>% 
  left_join(demographics_refractory_epilepsy, by="ENROLID") %>% 
  filter(!is.na(refractory_epilepsy_case)) %>% 
  group_by(year(SVCDATE), refractory_epilepsy_case) %>% 
  mutate(total_rescue_medication_prescriptions_per_year = n()) %>% 
  ungroup() %>% 
  group_by(year(SVCDATE), refractory_epilepsy_case, rescue_medication) %>% 
  summarize(
    proportion_use_per_year = n() / total_rescue_medication_prescriptions_per_year
  ) %>% 
  distinct(`year(SVCDATE)`, refractory_epilepsy_case, rescue_medication, .keep_all=TRUE) %>% 
  ungroup() %>% 
  group_by(`year(SVCDATE)`, refractory_epilepsy_case) %>% 
  arrange(desc(proportion_use_per_year), .by_group=TRUE) %>% 
  collect()
rescue_medication_use_per_year_by_refractory_epilepsy




# Use of rescue medication per year figure
rescue_medication_use_per_year_by_refractory_epilepsy_refractory_plot <- ggplot(data=rescue_medication_use_per_year_by_refractory_epilepsy[rescue_medication_use_per_year_by_refractory_epilepsy$refractory_epilepsy_case=="refractory", ],
                                aes(x=`year(SVCDATE)`, y=proportion_use_per_year, color=rescue_medication)) + 
  scale_color_manual(values = c("rectal diazepam" = "red",
                                "intranasal midazolam"="purple4",
                                "intranasal diazepam"="greenyellow")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0, 1))
rescue_medication_use_per_year_by_refractory_epilepsy_refractory_plot




rescue_medication_use_per_year_by_refractory_epilepsy_non_refractory_plot <- ggplot(data=rescue_medication_use_per_year_by_refractory_epilepsy[rescue_medication_use_per_year_by_refractory_epilepsy$refractory_epilepsy_case=="non-refractory", ],
                                aes(x=`year(SVCDATE)`, y=proportion_use_per_year, color=rescue_medication)) + 
  scale_color_manual(values = c("rectal diazepam" = "red",
                                "intranasal midazolam"="purple4",
                                "intranasal diazepam"="greenyellow")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0, 1))
rescue_medication_use_per_year_by_refractory_epilepsy_non_refractory_plot




#################################By emergency department visit or hospital admission for epilepsy#################################
# Use of rescue medication per year
demographics_IP_ED_epilepsy_visits <- demographics[ , c("ENROLID", "total_epilepsy_encounters_categorical")] %>% 
  distinct(ENROLID, total_epilepsy_encounters_categorical) %>% 
  collect()
rescue_medication_use_per_year_by_IP_ED_epilepsy_visits  <- inflation_adjusted_rescue_medication_epilepsy %>% 
  left_join(demographics_IP_ED_epilepsy_visits, by="ENROLID") %>% 
  filter(!is.na(total_epilepsy_encounters_categorical)) %>% 
  group_by(year(SVCDATE), total_epilepsy_encounters_categorical) %>% 
  mutate(total_rescue_medication_prescriptions_per_year = n()) %>% 
  ungroup() %>% 
  group_by(year(SVCDATE), total_epilepsy_encounters_categorical, rescue_medication) %>% 
  summarize(
    proportion_use_per_year = n() / total_rescue_medication_prescriptions_per_year
  ) %>% 
  distinct(`year(SVCDATE)`, total_epilepsy_encounters_categorical, rescue_medication, .keep_all=TRUE) %>% 
  ungroup() %>% 
  group_by(`year(SVCDATE)`, total_epilepsy_encounters_categorical) %>% 
  arrange(desc(proportion_use_per_year), .by_group=TRUE) %>% 
  collect()
rescue_medication_use_per_year_by_IP_ED_epilepsy_visits




# Use of rescue medication per year figure
rescue_medication_use_per_year_by_IP_ED_epilepsy_visits_0_plot <- ggplot(data=rescue_medication_use_per_year_by_IP_ED_epilepsy_visits[rescue_medication_use_per_year_by_IP_ED_epilepsy_visits$total_epilepsy_encounters_categorical=="0", ],
                                aes(x=`year(SVCDATE)`, y=proportion_use_per_year, color=rescue_medication)) + 
  scale_color_manual(values = c("rectal diazepam" = "red",
                                "intranasal midazolam"="purple4",
                                "intranasal diazepam"="greenyellow")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0, 1))
rescue_medication_use_per_year_by_IP_ED_epilepsy_visits_0_plot




rescue_medication_use_per_year_by_IP_ED_epilepsy_visits_1_3_plot <- ggplot(data=rescue_medication_use_per_year_by_IP_ED_epilepsy_visits[rescue_medication_use_per_year_by_IP_ED_epilepsy_visits$total_epilepsy_encounters_categorical=="1-3", ],
                                aes(x=`year(SVCDATE)`, y=proportion_use_per_year, color=rescue_medication)) + 
  scale_color_manual(values = c("rectal diazepam" = "red",
                                "intranasal midazolam"="purple4",
                                "intranasal diazepam"="greenyellow")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0, 1))
rescue_medication_use_per_year_by_IP_ED_epilepsy_visits_1_3_plot




rescue_medication_use_per_year_by_IP_ED_epilepsy_visits_more_than_3_plot <- ggplot(data=rescue_medication_use_per_year_by_IP_ED_epilepsy_visits[rescue_medication_use_per_year_by_IP_ED_epilepsy_visits$total_epilepsy_encounters_categorical==">3", ],
                                aes(x=`year(SVCDATE)`, y=proportion_use_per_year, color=rescue_medication)) + 
  scale_color_manual(values = c("rectal diazepam" = "red",
                                "intranasal midazolam"="purple4",
                                "intranasal diazepam"="greenyellow")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0, 1))
rescue_medication_use_per_year_by_IP_ED_epilepsy_visits_more_than_3_plot
```




Cost of rescue medications
```{r}
# Total cost of rescue medication per year
rescue_medication_cost_per_year <- inflation_adjusted_rescue_medication_epilepsy %>% 
  rowwise() %>% 
  mutate(
    AWP_per_unit = case_when(
      rescue_medication=="rectal diazepam" ~ AWP / METQTY,
      rescue_medication=="intranasal midazolam" ~ (AWP / METQTY) * 2,
      rescue_medication=="intranasal diazepam" ~ (AWP / METQTY) * 2
    ),
    patient_cost_per_unit = case_when(
      rescue_medication=="rectal diazepam" ~ sum(COINS, COPAY, DEDUCT, DISPFEE) / METQTY,
      rescue_medication=="intranasal midazolam" ~ ((sum(COINS, COPAY, DEDUCT, DISPFEE) / METQTY)) * 2,
      rescue_medication=="intranasal diazepam" ~ ((sum(COINS, COPAY, DEDUCT, DISPFEE) / METQTY)) * 2
    )
  ) %>% 
  ungroup() %>% 
  group_by(year(SVCDATE)) %>% 
  summarize(
    median_AWP = median(AWP_per_unit, na.rm=TRUE),
    p25_AWP = quantile(AWP_per_unit, 0.25, na.rm=TRUE),
    p75_AWP = quantile(AWP_per_unit, 0.75, na.rm=TRUE),
    median_patient_cost = median(patient_cost_per_unit, na.rm=TRUE),
    p25_patient_cost = quantile(patient_cost_per_unit, 0.25, na.rm=TRUE),
    p75_patient_cost = quantile(patient_cost_per_unit, 0.75, na.rm=TRUE) 
  ) %>% 
  arrange(`year(SVCDATE)`, desc(median_AWP)) %>% 
  collect()
rescue_medication_cost_per_year




rescue_medication_cost_per_year_for_jonckheere <- inflation_adjusted_rescue_medication_epilepsy %>% 
  rowwise() %>% 
  mutate(
    AWP_per_unit = case_when(
      rescue_medication=="rectal diazepam" ~ AWP / METQTY,
      rescue_medication=="intranasal midazolam" ~ (AWP / METQTY) * 2,
      rescue_medication=="intranasal diazepam" ~ (AWP / METQTY) * 2
    ),
    patient_cost_per_unit = case_when(
      rescue_medication=="rectal diazepam" ~ sum(COINS, COPAY, DEDUCT, DISPFEE) / METQTY,
      rescue_medication=="intranasal midazolam" ~ ((sum(COINS, COPAY, DEDUCT, DISPFEE) / METQTY)) * 2,
      rescue_medication=="intranasal diazepam" ~ ((sum(COINS, COPAY, DEDUCT, DISPFEE) / METQTY)) * 2
    )
  ) %>% 
  ungroup() %>% 
  arrange(year(SVCDATE)) %>% 
  collect()
rescue_medication_cost_per_year_for_jonckheere




# Jonckheere Terpstra test
jonckheere_rescue_medication_cost_AWP_per_year_p_value <- JonckheereTerpstraTest(AWP_per_unit ~ year_rescue_medication, data=rescue_medication_cost_per_year_for_jonckheere, alternative="increasing", nperm=1000)$p.value
jonckheere_rescue_medication_cost_AWP_per_year_p_value


jonckheere_rescue_medication_cost_AWP_per_year_p_value_2018_2022 <- JonckheereTerpstraTest(AWP_per_unit ~ year_rescue_medication, data=rescue_medication_cost_per_year_for_jonckheere[rescue_medication_cost_per_year_for_jonckheere$year_rescue_medication>=2018, ], alternative="increasing", nperm=1000)$p.value
jonckheere_rescue_medication_cost_AWP_per_year_p_value_2018_2022


jonckheere_rescue_medication_cost_patient_cost_per_year_p_value <- JonckheereTerpstraTest(patient_cost_per_unit ~ year_rescue_medication, data=rescue_medication_cost_per_year_for_jonckheere, alternative="increasing", nperm=1000)$p.value
jonckheere_rescue_medication_cost_patient_cost_per_year_p_value


jonckheere_rescue_medication_cost_patient_cost_per_year_p_value_2018_2022 <- JonckheereTerpstraTest(patient_cost_per_unit ~ year_rescue_medication, data=rescue_medication_cost_per_year_for_jonckheere[rescue_medication_cost_per_year_for_jonckheere$year_rescue_medication>=2018, ], alternative="increasing", nperm=1000)$p.value
jonckheere_rescue_medication_cost_patient_cost_per_year_p_value_2018_2022



# Figure rescue medication cost per year
rescue_medication_AWP_cost_per_year_plot <- ggplot(data=rescue_medication_cost_per_year) + 
  geom_line(aes(x=`year(SVCDATE)`, y=median_AWP), color="darkblue", lwd=1.5) + 
  geom_line(aes(x=`year(SVCDATE)`, y=p25_AWP), color="darkblue", lwd=1, lty=2) + 
  geom_line(aes(x=`year(SVCDATE)`, y=p75_AWP), color="darkblue", lwd=1, lty=2) + 
  geom_ribbon(aes(x=`year(SVCDATE)`, ymin=p25_AWP, ymax=p75_AWP), fill="darkblue", alpha=0.1) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Median (p25-p75) cost ($)", breaks=seq(0, 800, 200), limits = c(0, 800))
rescue_medication_AWP_cost_per_year_plot




rescue_medication_patient_cost_per_year_plot <- ggplot(data=rescue_medication_cost_per_year) + 
  geom_line(aes(x=`year(SVCDATE)`, y=median_patient_cost), color="darkblue", lwd=1.5) + 
  geom_line(aes(x=`year(SVCDATE)`, y=p25_patient_cost), color="darkblue", lwd=1, lty=2) + 
  geom_line(aes(x=`year(SVCDATE)`, y=p75_patient_cost), color="darkblue", lwd=1, lty=2) + 
  geom_ribbon(aes(x=`year(SVCDATE)`, ymin=p25_patient_cost, ymax=p75_patient_cost), fill="darkblue", alpha=0.1) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Median (p25-p75) cost ($)", breaks=seq(0, 75, 25), limits = c(0, 75))
rescue_medication_patient_cost_per_year_plot




# Total cost of rescue medication per year by generic
rescue_medication_cost_per_year_by_generic <- inflation_adjusted_rescue_medication_epilepsy %>% 
  filter(generic_binary!="other / no data") %>% 
  rowwise() %>% 
  mutate(
    AWP_per_unit = case_when(
      rescue_medication=="rectal diazepam" ~ AWP / METQTY,
      rescue_medication=="intranasal midazolam" ~ (AWP / METQTY) * 2,
      rescue_medication=="intranasal diazepam" ~ (AWP / METQTY) * 2
    ),
    patient_cost_per_unit = case_when(
      rescue_medication=="rectal diazepam" ~ sum(COINS, COPAY, DEDUCT, DISPFEE) / METQTY,
      rescue_medication=="intranasal midazolam" ~ ((sum(COINS, COPAY, DEDUCT, DISPFEE) / METQTY)) * 2,
      rescue_medication=="intranasal diazepam" ~ ((sum(COINS, COPAY, DEDUCT, DISPFEE) / METQTY)) * 2
    )
  ) %>% 
  ungroup() %>% 
  group_by(year(SVCDATE), generic_binary) %>% 
  summarize(
    median_AWP = median(AWP_per_unit, na.rm=TRUE),
    p25_AWP = quantile(AWP_per_unit, 0.25, na.rm=TRUE),
    p75_AWP = quantile(AWP_per_unit, 0.75, na.rm=TRUE),
    median_patient_cost = median(patient_cost_per_unit, na.rm=TRUE),
    p25_patient_cost = quantile(patient_cost_per_unit, 0.25, na.rm=TRUE),
    p75_patient_cost = quantile(patient_cost_per_unit, 0.75, na.rm=TRUE) 
  ) %>% 
  arrange(`year(SVCDATE)`, desc(median_AWP)) %>% 
  collect()
rescue_medication_cost_per_year_by_generic




# Jonckheere Terpstra test
jonckheere_rescue_medication_cost_AWP_per_year_by_generic_generic_p_value <- JonckheereTerpstraTest(AWP_per_unit ~ year_rescue_medication, data=rescue_medication_cost_per_year_for_jonckheere[rescue_medication_cost_per_year_for_jonckheere$generic_binary=="generic", ], alternative="decreasing", nperm=1000)$p.value
jonckheere_rescue_medication_cost_AWP_per_year_by_generic_generic_p_value


jonckheere_rescue_medication_cost_AWP_per_year_by_generic_generic_p_value_2018_2022 <- JonckheereTerpstraTest(AWP_per_unit ~ year_rescue_medication, data=rescue_medication_cost_per_year_for_jonckheere[rescue_medication_cost_per_year_for_jonckheere$generic_binary=="generic" & rescue_medication_cost_per_year_for_jonckheere$year_rescue_medication>=2018, ], alternative="decreasing", nperm=1000)$p.value
jonckheere_rescue_medication_cost_AWP_per_year_by_generic_generic_p_value_2018_2022


jonckheere_rescue_medication_cost_patient_cost_per_year_by_generic_generic_p_value <- JonckheereTerpstraTest(patient_cost_per_unit ~ year_rescue_medication, data=rescue_medication_cost_per_year_for_jonckheere[rescue_medication_cost_per_year_for_jonckheere$generic_binary=="generic", ], alternative="decreasing", nperm=1000)$p.value
jonckheere_rescue_medication_cost_patient_cost_per_year_by_generic_generic_p_value


jonckheere_rescue_medication_cost_patient_cost_per_year_by_generic_generic_p_value_2018_2022 <- JonckheereTerpstraTest(patient_cost_per_unit ~ year_rescue_medication, data=rescue_medication_cost_per_year_for_jonckheere[rescue_medication_cost_per_year_for_jonckheere$generic_binary=="generic" & rescue_medication_cost_per_year_for_jonckheere$year_rescue_medication>=2018, ], alternative="increasing", nperm=1000)$p.value
jonckheere_rescue_medication_cost_patient_cost_per_year_by_generic_generic_p_value_2018_2022




jonckheere_rescue_medication_cost_AWP_per_year_by_generic_brand_name_p_value <- JonckheereTerpstraTest(AWP_per_unit ~ year_rescue_medication, data=rescue_medication_cost_per_year_for_jonckheere[rescue_medication_cost_per_year_for_jonckheere$generic_binary=="brand name", ], alternative="increasing", nperm=1000)$p.value
jonckheere_rescue_medication_cost_AWP_per_year_by_generic_brand_name_p_value


jonckheere_rescue_medication_cost_AWP_per_year_by_generic_brand_name_p_value_2018_2022 <- JonckheereTerpstraTest(AWP_per_unit ~ year_rescue_medication, data=rescue_medication_cost_per_year_for_jonckheere[rescue_medication_cost_per_year_for_jonckheere$generic_binary=="brand name" & rescue_medication_cost_per_year_for_jonckheere$year_rescue_medication>=2018, ], alternative="increasing", nperm=1000)$p.value
jonckheere_rescue_medication_cost_AWP_per_year_by_generic_brand_name_p_value_2018_2022


jonckheere_rescue_medication_cost_patient_cost_per_year_by_generic_brand_name_p_value <- JonckheereTerpstraTest(patient_cost_per_unit ~ year_rescue_medication, data=rescue_medication_cost_per_year_for_jonckheere[rescue_medication_cost_per_year_for_jonckheere$generic_binary=="brand name", ], alternative="increasing", nperm=1000)$p.value
jonckheere_rescue_medication_cost_patient_cost_per_year_by_generic_brand_name_p_value


jonckheere_rescue_medication_cost_patient_cost_per_year_by_generic_brand_name_p_value_2018_2022 <- JonckheereTerpstraTest(patient_cost_per_unit ~ year_rescue_medication, data=rescue_medication_cost_per_year_for_jonckheere[rescue_medication_cost_per_year_for_jonckheere$generic_binary=="brand name" & rescue_medication_cost_per_year_for_jonckheere$year_rescue_medication>=2018, ], alternative="increasing", nperm=1000)$p.value
jonckheere_rescue_medication_cost_patient_cost_per_year_by_generic_brand_name_p_value_2018_2022




# Figure rescue medication cost per year
rescue_medication_AWP_cost_per_year_by_generic_plot <- ggplot(data=rescue_medication_cost_per_year_by_generic) + 
  geom_line(aes(x=`year(SVCDATE)`, y=median_AWP, color=generic_binary), lwd=1.5) + 
  geom_line(aes(x=`year(SVCDATE)`, y=p25_AWP, color=generic_binary), lwd=1, lty=2) + 
  geom_line(aes(x=`year(SVCDATE)`, y=p75_AWP, color=generic_binary), lwd=1, lty=2) + 
  geom_ribbon(aes(x=`year(SVCDATE)`, ymin=p25_AWP, ymax=p75_AWP, fill=generic_binary), alpha=0.1) +
  scale_color_manual(values = c("generic" = "forestgreen",
                                "brand name"="orangered")) +
  scale_fill_manual(values = c("generic" = "forestgreen",
                                "brand name"="orangered")) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Median (p25-p75) cost ($)", breaks=seq(0, 800, 200), limits = c(0, 800))
rescue_medication_AWP_cost_per_year_by_generic_plot 




rescue_medication_patient_cost_per_year_by_generic_plot <- ggplot(data=rescue_medication_cost_per_year_by_generic) + 
  geom_line(aes(x=`year(SVCDATE)`, y=median_patient_cost, color=generic_binary), lwd=1.5) + 
  geom_line(aes(x=`year(SVCDATE)`, y=p25_patient_cost, color=generic_binary), lwd=1, lty=2) + 
  geom_line(aes(x=`year(SVCDATE)`, y=p75_patient_cost, color=generic_binary), lwd=1, lty=2) + 
  geom_ribbon(aes(x=`year(SVCDATE)`, ymin=p25_patient_cost, ymax=p75_patient_cost, fill=generic_binary), alpha=0.1) +
  scale_color_manual(values = c("generic" = "forestgreen",
                                "brand name"="orangered")) +
  scale_fill_manual(values = c("generic" = "forestgreen",
                                "brand name"="orangered")) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Median (p25-p75) cost ($)", breaks=seq(0, 100, 25), limits = c(0, 100))
rescue_medication_patient_cost_per_year_by_generic_plot 




# Total cost of rescue medication per year by rescue medication
rescue_medication_cost_per_year_by_rescue_medication <- inflation_adjusted_rescue_medication_epilepsy %>% 
  rowwise() %>% 
  mutate(
    AWP_per_unit = case_when(
      rescue_medication=="rectal diazepam" ~ AWP / METQTY,
      rescue_medication=="intranasal midazolam" ~ (AWP / METQTY) * 2,
      rescue_medication=="intranasal diazepam" ~ (AWP / METQTY) * 2
    ),
    patient_cost_per_unit = case_when(
      rescue_medication=="rectal diazepam" ~ sum(COINS, COPAY, DEDUCT, DISPFEE) / METQTY,
      rescue_medication=="intranasal midazolam" ~ ((sum(COINS, COPAY, DEDUCT, DISPFEE) / METQTY)) * 2,
      rescue_medication=="intranasal diazepam" ~ ((sum(COINS, COPAY, DEDUCT, DISPFEE) / METQTY)) * 2
    )
  ) %>% 
  ungroup() %>% 
  group_by(year(SVCDATE), rescue_medication) %>% 
  summarize(
    median_AWP = median(AWP_per_unit, na.rm=TRUE),
    p25_AWP = quantile(AWP_per_unit, 0.25, na.rm=TRUE),
    p75_AWP = quantile(AWP_per_unit, 0.75, na.rm=TRUE),
    median_patient_cost = median(patient_cost_per_unit, na.rm=TRUE),
    p25_patient_cost = quantile(patient_cost_per_unit, 0.25, na.rm=TRUE),
    p75_patient_cost = quantile(patient_cost_per_unit, 0.75, na.rm=TRUE) 
  ) %>% 
  arrange(`year(SVCDATE)`, desc(median_AWP)) %>% 
  collect()
rescue_medication_cost_per_year_by_rescue_medication




# Figure rescue medication cost per year
rescue_medication_AWP_cost_per_year_by_rescue_medication_plot <- ggplot(data=rescue_medication_cost_per_year_by_rescue_medication) + 
  geom_line(aes(x=`year(SVCDATE)`, y=median_AWP, color=rescue_medication), lwd=1.5) + 
  geom_line(aes(x=`year(SVCDATE)`, y=p25_AWP, color=rescue_medication), lwd=1, lty=2) + 
  geom_line(aes(x=`year(SVCDATE)`, y=p75_AWP, color=rescue_medication), lwd=1, lty=2) + 
  geom_ribbon(aes(x=`year(SVCDATE)`, ymin=p25_AWP, ymax=p75_AWP, fill=rescue_medication), alpha=0.1) +
  scale_color_manual(values = c("rectal diazepam" = "red",
                                "intranasal midazolam"="purple4",
                                "intranasal diazepam"="greenyellow")) +
  scale_fill_manual(values = c("rectal diazepam" = "red",
                                "intranasal midazolam"="purple4",
                                "intranasal diazepam"="greenyellow")) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Median (p25-p75) cost ($)", breaks=seq(0, 800, 200), limits = c(0, 800))
rescue_medication_AWP_cost_per_year_by_rescue_medication_plot 




rescue_medication_patient_cost_per_year_by_rescue_medication_plot <- ggplot(data=rescue_medication_cost_per_year_by_rescue_medication) + 
  geom_line(aes(x=`year(SVCDATE)`, y=median_patient_cost, color=rescue_medication), lwd=1.5) + 
  geom_line(aes(x=`year(SVCDATE)`, y=p25_patient_cost, color=rescue_medication), lwd=1, lty=2) + 
  geom_line(aes(x=`year(SVCDATE)`, y=p75_patient_cost, color=rescue_medication), lwd=1, lty=2) + 
  geom_ribbon(aes(x=`year(SVCDATE)`, ymin=p25_patient_cost, ymax=p75_patient_cost, fill=rescue_medication), alpha=0.1) +
  scale_color_manual(values = c("rectal diazepam" = "red",
                                "intranasal midazolam"="purple4",
                                "intranasal diazepam"="greenyellow")) +
  scale_fill_manual(values = c("rectal diazepam" = "red",
                                "intranasal midazolam"="purple4",
                                "intranasal diazepam"="greenyellow")) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2022) +
  scale_y_continuous(name="Median (p25-p75) cost ($)", breaks=seq(0, 100, 25), limits = c(0, 100))
rescue_medication_patient_cost_per_year_by_rescue_medication_plot 
```




## 5. Adjustment for multiple comparisons




Adjustment for multiple comparisons 
```{r}
# Unadjusted p-values
unadjusted_p_values <- c(jonckheere_proportion_with_rescue_medication_per_year_p_value, jonckheere_proportion_with_rescue_medication_per_year_p_value_2018_2022, jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_0_5_y_p_value, jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_0_5_y_p_value_2018_2022, jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_6_12_y_p_value, jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_6_12_y_p_value_2018_2022, jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_13_21_y_p_value, jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_13_21_y_p_value_2018_2022, jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_22_35_y_p_value, jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_22_35_y_p_value_2018_2022, jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_36_50_y_p_value, jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_36_50_y_p_value_2018_2022, jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_more_than_50_y_p_value, jonckheere_proportion_with_rescue_medication_per_year_by_age_groups_more_than_50_y_p_value_2018_2022, jonckheere_proportion_with_rescue_medication_per_year_by_refractory_epilepsy_refractory_p_value, jonckheere_proportion_with_rescue_medication_per_year_by_refractory_epilepsy_refractory_p_value_2018_2022, jonckheere_proportion_with_rescue_medication_per_year_by_refractory_epilepsy_nonrefractory_p_value, jonckheere_proportion_with_rescue_medication_per_year_by_refractory_epilepsy_nonrefractory_p_value_2018_2022, jonckheere_proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_0_p_value, jonckheere_proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_0_p_value_2018_2022, jonckheere_proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_1_3_p_value, jonckheere_proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_1_3_p_value_2018_2022, jonckheere_proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_more_than_3_p_value, jonckheere_proportion_with_rescue_medication_per_year_by_IP_ED_epilepsy_visits_more_than_3_p_value_2018_2022, rescue_medication_logistic_regression_age_0_5_y_p_value, rescue_medication_logistic_regression_age_6_12_y_p_value, rescue_medication_logistic_regression_age_13_21_y_p_value, rescue_medication_logistic_regression_age_22_35_y_p_value, rescue_medication_logistic_regression_age_36_50_y_p_value, rescue_medication_logistic_regression_male_p_value, rescue_medication_logistic_regression_refractory_p_value, rescue_medication_logistic_regression_ED_IP_1_3_p_value, rescue_medication_logistic_regression_ED_IP_more_than_3_p_value, rescue_medication_logistic_regression_north_east_p_value, rescue_medication_logistic_regression_north_central_p_value, rescue_medication_logistic_regression_south_p_value, rescue_medication_logistic_regression_other_region_p_value, rescue_medication_logistic_regression_full_time_p_value, jonckheere_rescue_medication_cost_AWP_per_year_p_value, jonckheere_rescue_medication_cost_AWP_per_year_p_value_2018_2022, jonckheere_rescue_medication_cost_patient_cost_per_year_p_value, jonckheere_rescue_medication_cost_patient_cost_per_year_p_value_2018_2022, jonckheere_rescue_medication_cost_AWP_per_year_by_generic_generic_p_value, jonckheere_rescue_medication_cost_AWP_per_year_by_generic_generic_p_value_2018_2022, jonckheere_rescue_medication_cost_patient_cost_per_year_by_generic_generic_p_value, jonckheere_rescue_medication_cost_patient_cost_per_year_by_generic_generic_p_value_2018_2022, jonckheere_rescue_medication_cost_AWP_per_year_by_generic_brand_name_p_value, jonckheere_rescue_medication_cost_AWP_per_year_by_generic_brand_name_p_value_2018_2022, jonckheere_rescue_medication_cost_patient_cost_per_year_by_generic_brand_name_p_value, jonckheere_rescue_medication_cost_patient_cost_per_year_by_generic_brand_name_p_value_2018_2022)


# Adjusted p-values
adjusted_p_values <- p.adjust(unadjusted_p_values, "BH") 
adjusted_p_values
```



## 6. Disconnect from the database




Disconnect from the database
```{r}
# Disconnect
dbDisconnect(MarketScan)
```

